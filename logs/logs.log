2024-10-20 19:35:29,931 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 19:35:29,931 - ERROR - EXTRACT 'public.geolocation' - FAILED.
2024-10-20 19:35:29,931 - INFO - Extract All Tables From Sources - FAILED
2024-10-20 19:35:29,954 - ERROR - [pid 168726] Worker Worker(salt=4377808355, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=168726) failed    Extract()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/extract.py", line 58, in run
    df = pd.read_sql_query(extract_query.format(table_name = table_name), src_engine)
AttributeError: 'NoneType' object has no attribute 'format'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/extract.py", line 67, in run
    raise Exception(f"Failed to extract '{table_name}' tables")
Exception: Failed to extract 'public.geolocation' tables

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/extract.py", line 106, in run
    raise Exception(f"FAILED to execute EXTRACT TASK !!!")
Exception: FAILED to execute EXTRACT TASK !!!
2024-10-20 19:35:29,956 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 19:35:29,961 - INFO - Informed scheduler that task   Extract__99914b932b   has status   FAILED
2024-10-20 19:35:29,961 - DEBUG - Asking scheduler for work...
2024-10-20 19:35:29,962 - DEBUG - Done
2024-10-20 19:35:29,963 - DEBUG - There are no more tasks to run at this time
2024-10-20 19:35:29,963 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 19:35:29,963 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 19:35:29,963 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 19:35:29,963 - INFO - Worker Worker(salt=4377808355, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=168726) was stopped. Shutting down Keep-Alive thread
2024-10-20 19:35:29,964 - INFO - 
===== Luigi Execution Summary =====

Scheduled 1 tasks of which:
* 1 failed:
    - 1 Extract()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 19:36:20,540 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 19:36:20,540 - ERROR - EXTRACT 'public.geolocation' - FAILED.
2024-10-20 19:36:20,540 - INFO - Extract All Tables From Sources - FAILED
2024-10-20 19:36:20,544 - ERROR - [pid 169527] Worker Worker(salt=7781611351, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=169527) failed    Extract()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/extract.py", line 58, in run
    df = pd.read_sql_query(extract_query.format(table_name = table_name), src_engine)
AttributeError: 'NoneType' object has no attribute 'format'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/extract.py", line 67, in run
    raise Exception(f"Failed to extract '{table_name}' tables")
Exception: Failed to extract 'public.geolocation' tables

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/extract.py", line 106, in run
    raise Exception(f"FAILED to execute EXTRACT TASK !!!")
Exception: FAILED to execute EXTRACT TASK !!!
2024-10-20 19:36:20,546 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 19:36:20,551 - INFO - Informed scheduler that task   Extract__99914b932b   has status   FAILED
2024-10-20 19:36:20,551 - DEBUG - Asking scheduler for work...
2024-10-20 19:36:20,553 - DEBUG - Done
2024-10-20 19:36:20,554 - DEBUG - There are no more tasks to run at this time
2024-10-20 19:36:20,554 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 19:36:20,554 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 19:36:20,554 - INFO - Worker Worker(salt=7781611351, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=169527) was stopped. Shutting down Keep-Alive thread
2024-10-20 19:36:20,555 - INFO - 
===== Luigi Execution Summary =====

Scheduled 1 tasks of which:
* 1 failed:
    - 1 Extract()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 19:37:00,477 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 19:37:00,477 - ERROR - EXTRACT 'public.geolocation' - FAILED.
2024-10-20 19:37:00,477 - INFO - Extract All Tables From Sources - FAILED
2024-10-20 19:37:00,480 - ERROR - [pid 170414] Worker Worker(salt=898094511, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=170414) failed    Extract()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/extract.py", line 58, in run
    df = pd.read_sql_query(extract_query.format(table_name = table_name), src_engine)
AttributeError: 'NoneType' object has no attribute 'format'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/extract.py", line 67, in run
    raise Exception(f"Failed to extract '{table_name}' tables")
Exception: Failed to extract 'public.geolocation' tables

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/extract.py", line 106, in run
    raise Exception(f"FAILED to execute EXTRACT TASK !!!")
Exception: FAILED to execute EXTRACT TASK !!!
2024-10-20 19:37:00,482 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 19:37:00,486 - INFO - Informed scheduler that task   Extract__99914b932b   has status   FAILED
2024-10-20 19:37:00,486 - DEBUG - Asking scheduler for work...
2024-10-20 19:37:00,488 - DEBUG - Done
2024-10-20 19:37:00,488 - DEBUG - There are no more tasks to run at this time
2024-10-20 19:37:00,489 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 19:37:00,489 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 19:37:00,489 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 19:37:00,489 - INFO - Worker Worker(salt=898094511, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=170414) was stopped. Shutting down Keep-Alive thread
2024-10-20 19:37:00,490 - INFO - 
===== Luigi Execution Summary =====

Scheduled 1 tasks of which:
* 1 failed:
    - 1 Extract()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 19:56:34,588 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 19:56:34,795 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 19:56:35,261 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 19:56:35,349 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 19:56:35,604 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 19:56:35,610 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 19:56:36,463 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 19:56:37,450 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 19:56:37,974 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 19:56:38,665 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 19:56:38,665 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 19:56:38,673 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 19:56:38,691 - INFO - [pid 182775] Worker Worker(salt=1435779541, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=182775) done      Extract()
2024-10-20 19:56:38,691 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 19:56:38,694 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 19:56:38,694 - DEBUG - Asking scheduler for work...
2024-10-20 19:56:38,696 - DEBUG - Done
2024-10-20 19:56:38,696 - DEBUG - There are no more tasks to run at this time
2024-10-20 19:56:38,696 - INFO - Worker Worker(salt=1435779541, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=182775) was stopped. Shutting down Keep-Alive thread
2024-10-20 19:56:38,698 - INFO - 
===== Luigi Execution Summary =====

Scheduled 1 tasks of which:
* 1 ran successfully:
    - 1 Extract()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-20 20:21:53,132 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 20:21:53,257 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 20:21:53,692 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 20:21:53,732 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 20:21:53,986 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 20:21:53,991 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 20:21:54,667 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 20:21:55,671 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 20:21:56,202 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 20:21:56,824 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 20:21:56,824 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 20:21:56,836 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 20:21:56,851 - INFO - [pid 199532] Worker Worker(salt=3734527980, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=199532) done      Extract()
2024-10-20 20:21:56,853 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 20:21:56,856 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 20:21:56,856 - DEBUG - Asking scheduler for work...
2024-10-20 20:21:56,857 - DEBUG - Done
2024-10-20 20:21:56,857 - DEBUG - There are no more tasks to run at this time
2024-10-20 20:21:56,858 - INFO - Worker Worker(salt=3734527980, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=199532) was stopped. Shutting down Keep-Alive thread
2024-10-20 20:21:56,859 - INFO - 
===== Luigi Execution Summary =====

Scheduled 1 tasks of which:
* 1 ran successfully:
    - 1 Extract()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-20 20:33:24,232 - INFO - Read Load Query - SUCCESS
2024-10-20 20:33:33,915 - INFO - Read Extracted Data - SUCCESS
2024-10-20 20:33:34,322 - INFO - Connect to DWH - SUCCESS
2024-10-20 20:33:36,390 - ERROR - Truncate public Schema in DWH - FAILED
2024-10-20 20:33:36,398 - ERROR - [pid 207085] Worker Worker(salt=1281184910, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=207085) failed    Load()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedTable: relation "public.geolocation" does not exist


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 136, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedTable) relation "public.geolocation" does not exist

[SQL: -- Truncate all tables in public schema before load
TRUNCATE TABLE public.geolocation CASCADE]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 148, in run
    raise Exception("Failed to Truncate public Schema in DWH")
Exception: Failed to Truncate public Schema in DWH
2024-10-20 20:33:36,439 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 20:33:36,495 - INFO - Informed scheduler that task   Load__99914b932b   has status   FAILED
2024-10-20 20:33:36,499 - DEBUG - Asking scheduler for work...
2024-10-20 20:33:36,529 - DEBUG - Done
2024-10-20 20:33:36,529 - DEBUG - There are no more tasks to run at this time
2024-10-20 20:33:36,529 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 20:33:36,529 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 20:33:36,529 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 20:33:36,529 - INFO - Worker Worker(salt=1281184910, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=207085) was stopped. Shutting down Keep-Alive thread
2024-10-20 20:33:36,538 - INFO - 
===== Luigi Execution Summary =====

Scheduled 2 tasks of which:
* 1 complete ones were encountered:
    - 1 Extract()
* 1 failed:
    - 1 Load()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 20:56:29,902 - INFO - Read Load Query - SUCCESS
2024-10-20 20:56:31,338 - INFO - Read Extracted Data - SUCCESS
2024-10-20 20:56:31,437 - INFO - Connect to DWH - SUCCESS
2024-10-20 20:56:31,746 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 20:56:31,746 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 20:56:35,678 - ERROR - LOAD All Tables To DWH-Bookings - FAILED
2024-10-20 20:56:35,707 - ERROR - LOAD All Tables To DWH - FAILED
2024-10-20 20:56:35,707 - ERROR - [pid 223390] Worker Worker(salt=393909950, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=223390) failed    Load()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2119, in _exec_insertmany_context
    dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.ForeignKeyViolation: insert or update on table "products" violates foreign key constraint "fk_products_product_category"
DETAIL:  Key (product_category_name)=(perfumaria) is not present in table "product_category_name_translation".


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 183, in run
    products.to_sql('products',
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/util/_decorators.py", line 333, in wrapper
    return func(*args, **kwargs)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/core/generic.py", line 3084, in to_sql
    return sql.to_sql(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/io/sql.py", line 842, in to_sql
    return pandas_sql.to_sql(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/io/sql.py", line 2018, in to_sql
    total_inserted = sql_engine.insert_records(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/io/sql.py", line 1567, in insert_records
    raise err
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/io/sql.py", line 1558, in insert_records
    return table.insert(chunksize=chunksize, method=method)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/io/sql.py", line 1119, in insert
    num_inserted = exec_insert(conn, keys, chunk_iter)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/io/sql.py", line 1010, in _execute_insert
    result = conn.execute(self.table.insert(), data)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1847, in _execute_context
    return self._exec_insertmany_context(dialect, context)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2127, in _exec_insertmany_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2119, in _exec_insertmany_context
    dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.ForeignKeyViolation) insert or update on table "products" violates foreign key constraint "fk_products_product_category"
DETAIL:  Key (product_category_name)=(perfumaria) is not present in table "product_category_name_translation".

[SQL: INSERT INTO public.products (product_id, product_category_name, product_name_lenght, product_description_lenght, product_photos_qty, product_weight_g, product_length_cm, product_height_cm, product_width_cm) VALUES (%(product_id__0)s, %(product_catego ... 259872 characters truncated ... _weight_g__999)s, %(product_length_cm__999)s, %(product_height_cm__999)s, %(product_width_cm__999)s)]
[parameters: {'product_name_lenght__0': 40.0, 'product_length_cm__0': 16.0, 'product_description_lenght__0': 287.0, 'product_width_cm__0': 14.0, 'product_weight_g__0': 225.0, 'product_photos_qty__0': 1.0, 'product_height_cm__0': 10.0, 'product_id__0': '1e9e8ef04dbcff4541ed26657ea517e5', 'product_category_name__0': 'perfumaria', 'product_name_lenght__1': 44.0, 'product_length_cm__1': 30.0, 'product_description_lenght__1': 276.0, 'product_width_cm__1': 20.0, 'product_weight_g__1': 1000.0, 'product_photos_qty__1': 1.0, 'product_height_cm__1': 18.0, 'product_id__1': '3aa071139cb16b67ca9e5dea641aaa2f', 'product_category_name__1': 'artes', 'product_name_lenght__2': 46.0, 'product_length_cm__2': 18.0, 'product_description_lenght__2': 250.0, 'product_width_cm__2': 15.0, 'product_weight_g__2': 154.0, 'product_photos_qty__2': 1.0, 'product_height_cm__2': 9.0, 'product_id__2': '96bd76ec8810374ed1b65e291975717f', 'product_category_name__2': 'esporte_lazer', 'product_name_lenght__3': 27.0, 'product_length_cm__3': 26.0, 'product_description_lenght__3': 261.0, 'product_width_cm__3': 26.0, 'product_weight_g__3': 371.0, 'product_photos_qty__3': 1.0, 'product_height_cm__3': 4.0, 'product_id__3': 'cef67bcfe19066a932b7673e239eb23d', 'product_category_name__3': 'bebes', 'product_name_lenght__4': 37.0, 'product_length_cm__4': 20.0, 'product_description_lenght__4': 402.0, 'product_width_cm__4': 13.0, 'product_weight_g__4': 625.0, 'product_photos_qty__4': 4.0, 'product_height_cm__4': 17.0, 'product_id__4': '9dc1a7de274444849c219cff195d0b71', 'product_category_name__4': 'utilidades_domesticas', 'product_name_lenght__5': 60.0, 'product_length_cm__5': 38.0, 'product_description_lenght__5': 745.0, 'product_width_cm__5': 11.0, 'product_weight_g__5': 200.0 ... 8900 parameters truncated ... 'product_weight_g__994': 1588.0, 'product_photos_qty__994': 1.0, 'product_height_cm__994': 12.0, 'product_id__994': 'a93ad122024312ca432da7f7b32474b4', 'product_category_name__994': 'cama_mesa_banho', 'product_name_lenght__995': 40.0, 'product_length_cm__995': 20.0, 'product_description_lenght__995': 287.0, 'product_width_cm__995': 22.0, 'product_weight_g__995': 1400.0, 'product_photos_qty__995': 6.0, 'product_height_cm__995': 16.0, 'product_id__995': '98bf9f3941be6afbca9ea37f8eb0c466', 'product_category_name__995': 'pet_shop', 'product_name_lenght__996': 58.0, 'product_length_cm__996': 23.0, 'product_description_lenght__996': 797.0, 'product_width_cm__996': 38.0, 'product_weight_g__996': 1100.0, 'product_photos_qty__996': 5.0, 'product_height_cm__996': 7.0, 'product_id__996': '1fd95182c672cf5b10c82207ca5dab97', 'product_category_name__996': 'automotivo', 'product_name_lenght__997': 29.0, 'product_length_cm__997': 32.0, 'product_description_lenght__997': 250.0, 'product_width_cm__997': 28.0, 'product_weight_g__997': 800.0, 'product_photos_qty__997': 2.0, 'product_height_cm__997': 6.0, 'product_id__997': 'ac01b71ddb644fe8806e71a6030accf9', 'product_category_name__997': 'moveis_decoracao', 'product_name_lenght__998': 45.0, 'product_length_cm__998': 26.0, 'product_description_lenght__998': 1134.0, 'product_width_cm__998': 18.0, 'product_weight_g__998': 867.0, 'product_photos_qty__998': 1.0, 'product_height_cm__998': 15.0, 'product_id__998': '35e26f65c3f380cfe6257d771fb067d2', 'product_category_name__998': 'esporte_lazer', 'product_name_lenght__999': 32.0, 'product_length_cm__999': 17.0, 'product_description_lenght__999': 999.0, 'product_width_cm__999': 20.0, 'product_weight_g__999': 225.0, 'product_photos_qty__999': 3.0, 'product_height_cm__999': 5.0, 'product_id__999': '089cc17c8bf2226d13648392e33dabd7', 'product_category_name__999': 'informatica_acessorios'}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 228, in run
    raise Exception('Failed Load Tables To DWH-Bookings')
Exception: Failed Load Tables To DWH-Bookings

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 295, in run
    raise Exception('Failed Load Tables To DWH')
Exception: Failed Load Tables To DWH
2024-10-20 20:56:35,721 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 20:56:35,727 - INFO - Informed scheduler that task   Load__99914b932b   has status   FAILED
2024-10-20 20:56:35,727 - DEBUG - Asking scheduler for work...
2024-10-20 20:56:35,728 - DEBUG - Done
2024-10-20 20:56:35,728 - DEBUG - There are no more tasks to run at this time
2024-10-20 20:56:35,728 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 20:56:35,728 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 20:56:35,729 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 20:56:35,729 - INFO - Worker Worker(salt=393909950, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=223390) was stopped. Shutting down Keep-Alive thread
2024-10-20 20:56:35,731 - INFO - 
===== Luigi Execution Summary =====

Scheduled 2 tasks of which:
* 1 complete ones were encountered:
    - 1 Extract()
* 1 failed:
    - 1 Load()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 21:05:10,988 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 21:05:11,102 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 21:05:11,739 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 21:05:11,767 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 21:05:12,029 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 21:05:12,036 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 21:05:13,270 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 21:05:14,642 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 21:05:15,230 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 21:05:15,893 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 21:05:15,894 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 21:05:15,909 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 21:05:15,931 - INFO - [pid 229020] Worker Worker(salt=3428949343, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=229020) done      Extract()
2024-10-20 21:05:15,933 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:05:15,936 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 21:05:15,936 - DEBUG - Asking scheduler for work...
2024-10-20 21:05:15,938 - DEBUG - Pending tasks: 1
2024-10-20 21:05:15,938 - INFO - [pid 229020] Worker Worker(salt=3428949343, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=229020) running   Load()
2024-10-20 21:05:15,943 - INFO - Read Load Query - SUCCESS
2024-10-20 21:05:17,405 - INFO - Read Extracted Data - SUCCESS
2024-10-20 21:05:17,406 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:05:17,699 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 21:05:17,699 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 21:05:39,534 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 21:05:39,737 - ERROR - LOAD All Tables To DWH-Staging - FAILED
2024-10-20 21:05:39,791 - ERROR - LOAD All Tables To DWH - FAILED
2024-10-20 21:05:39,792 - ERROR - [pid 229020] Worker Worker(salt=3428949343, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=229020) failed    Load()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 244, in run
    query = sqlalchemy.text(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/_elements_constructors.py", line 1640, in text
    return TextClause(text)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 2295, in __init__
    self.text = self._bind_params_regex.sub(repl, text)
TypeError: expected string or bytes-like object

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 256, in run
    raise Exception('Failed Load Tables To DWH-Staging')
Exception: Failed Load Tables To DWH-Staging

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 295, in run
    raise Exception('Failed Load Tables To DWH')
Exception: Failed Load Tables To DWH
2024-10-20 21:05:39,850 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:05:39,865 - INFO - Informed scheduler that task   Load__99914b932b   has status   FAILED
2024-10-20 21:05:39,866 - DEBUG - Asking scheduler for work...
2024-10-20 21:05:39,867 - DEBUG - Done
2024-10-20 21:05:39,867 - DEBUG - There are no more tasks to run at this time
2024-10-20 21:05:39,867 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 21:05:39,868 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 21:05:39,868 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 21:05:39,868 - INFO - Worker Worker(salt=3428949343, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=229020) was stopped. Shutting down Keep-Alive thread
2024-10-20 21:05:39,869 - INFO - 
===== Luigi Execution Summary =====

Scheduled 2 tasks of which:
* 1 ran successfully:
    - 1 Extract()
* 1 failed:
    - 1 Load()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 21:10:46,236 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 21:10:46,344 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 21:10:46,828 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 21:10:46,854 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 21:10:47,136 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 21:10:47,142 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 21:10:47,915 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 21:10:48,978 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 21:10:49,535 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 21:10:50,159 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 21:10:50,159 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 21:10:50,166 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 21:10:50,188 - INFO - [pid 232785] Worker Worker(salt=7569198927, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=232785) done      Extract()
2024-10-20 21:10:50,189 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:10:50,200 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 21:10:50,201 - DEBUG - Asking scheduler for work...
2024-10-20 21:10:50,204 - DEBUG - Pending tasks: 1
2024-10-20 21:10:50,205 - INFO - [pid 232785] Worker Worker(salt=7569198927, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=232785) running   Load()
2024-10-20 21:10:50,213 - INFO - Read Load Query - SUCCESS
2024-10-20 21:10:51,474 - INFO - Read Extracted Data - SUCCESS
2024-10-20 21:10:51,476 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:10:51,826 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 21:10:51,826 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 21:11:20,412 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 21:11:32,770 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 21:11:32,834 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 21:11:32,874 - INFO - [pid 232785] Worker Worker(salt=7569198927, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=232785) done      Load()
2024-10-20 21:11:32,875 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:11:32,879 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 21:11:32,879 - DEBUG - Asking scheduler for work...
2024-10-20 21:11:32,881 - DEBUG - Done
2024-10-20 21:11:32,881 - DEBUG - There are no more tasks to run at this time
2024-10-20 21:11:32,881 - INFO - Worker Worker(salt=7569198927, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=232785) was stopped. Shutting down Keep-Alive thread
2024-10-20 21:11:32,891 - INFO - 
===== Luigi Execution Summary =====

Scheduled 2 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-20 21:13:54,153 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:13:54,162 - INFO - Read Transform Query - SUCCESS
2024-10-20 21:13:54,162 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 21:13:54,293 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 21:13:55,547 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 21:13:55,802 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 21:13:55,846 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 21:13:56,678 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-20 21:13:56,685 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 21:13:56,697 - ERROR - Transform Tables - FAILED
2024-10-20 21:13:56,697 - ERROR - [pid 234931] Worker Worker(salt=4196448588, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=234931) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: syntax error at or near "seller_id"
LINE 47:     seller_id = EXCLUDED.seller_id,
             ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) syntax error at or near "seller_id"
LINE 47:     seller_id = EXCLUDED.seller_id,
             ^

[SQL: INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT
    dd.date_actual AS order_date,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    
    -- Get total order
    COUNT(DISTINCT oi.order_id) AS total_order,

    -- Get total quantity
    COUNT(oi.order_item_id) AS total_quantity,

    -- Get total amount (total price + total freight)
    SUM(oi.price) + SUM(oi.freight_value) AS total_amount
FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_products dp ON oi.product_id = dp.product_nk
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date dd ON DATE(o.order_purchase_timestamp) = dd.date_actual
GROUP BY 
    dd.date_actual,
    dp.product_id,
    dc.customer_id,
    ds.seller_id

ON CONFLICT(order_date)
DO UPDATE SET
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id
    seller_id = EXCLUDED.seller_id,
    total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        OR final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 21:13:56,704 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:13:56,710 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 21:13:56,711 - DEBUG - Asking scheduler for work...
2024-10-20 21:13:56,713 - DEBUG - Done
2024-10-20 21:13:56,713 - DEBUG - There are no more tasks to run at this time
2024-10-20 21:13:56,713 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 21:13:56,713 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 21:13:56,714 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 21:13:56,714 - INFO - Worker Worker(salt=4196448588, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=234931) was stopped. Shutting down Keep-Alive thread
2024-10-20 21:13:56,715 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 complete ones were encountered:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 21:16:44,828 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 21:16:44,933 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 21:16:45,364 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 21:16:45,387 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 21:16:45,667 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 21:16:45,673 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 21:16:46,512 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 21:16:47,405 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 21:16:47,935 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 21:16:48,677 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 21:16:48,677 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 21:16:48,687 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 21:16:48,703 - INFO - [pid 236919] Worker Worker(salt=6570948061, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=236919) done      Extract()
2024-10-20 21:16:48,705 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:16:48,707 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 21:16:48,708 - DEBUG - Asking scheduler for work...
2024-10-20 21:16:48,709 - DEBUG - Pending tasks: 2
2024-10-20 21:16:48,709 - INFO - [pid 236919] Worker Worker(salt=6570948061, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=236919) running   Load()
2024-10-20 21:16:48,715 - INFO - Read Load Query - SUCCESS
2024-10-20 21:16:49,993 - INFO - Read Extracted Data - SUCCESS
2024-10-20 21:16:49,994 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:16:50,327 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 21:16:50,327 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 21:18:05,046 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-20 21:18:09,075 - INFO - Retrying attempt 2 of 3 (max)
2024-10-20 21:18:12,206 - INFO - Wait for 30 seconds
2024-10-20 21:19:12,651 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-20 21:19:15,004 - INFO - Retrying attempt 3 of 3 (max)
2024-10-20 21:19:19,088 - INFO - Wait for 30 seconds
2024-10-20 21:20:12,131 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-20 21:20:16,859 - INFO - Retrying attempt 4 of 3 (max)
2024-10-20 21:20:21,527 - INFO - Wait for 30 seconds
2024-10-20 21:20:29,664 - WARNING - Failed pinging scheduler
2024-10-20 21:21:39,819 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-20 21:21:58,740 - INFO - Retrying attempt 2 of 3 (max)
2024-10-20 21:22:15,295 - INFO - Wait for 30 seconds
2024-10-20 21:23:23,215 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-20 21:23:23,800 - INFO - Retrying attempt 3 of 3 (max)
2024-10-20 21:23:24,406 - INFO - Wait for 30 seconds
2024-10-20 21:24:15,958 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-20 21:24:28,679 - INFO - Retrying attempt 4 of 3 (max)
2024-10-20 21:24:39,430 - INFO - Wait for 30 seconds
2024-10-20 21:25:16,124 - WARNING - Failed pinging scheduler
2024-10-20 21:25:48,847 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 21:26:04,770 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 21:26:04,813 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 21:26:07,432 - INFO - [pid 236919] Worker Worker(salt=6570948061, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=236919) done      Load()
2024-10-20 21:26:07,434 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:26:07,437 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 21:26:07,438 - DEBUG - Asking scheduler for work...
2024-10-20 21:26:07,440 - DEBUG - Pending tasks: 1
2024-10-20 21:26:07,440 - INFO - [pid 236919] Worker Worker(salt=6570948061, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=236919) running   Transform()
2024-10-20 21:26:07,442 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:26:07,446 - INFO - Read Transform Query - SUCCESS
2024-10-20 21:26:07,447 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 21:26:07,611 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 21:26:09,220 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 21:26:09,810 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 21:26:10,015 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 21:26:10,622 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-20 21:26:10,694 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-20 21:26:10,699 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 21:26:10,707 - ERROR - Transform Tables - FAILED
2024-10-20 21:26:10,707 - ERROR - [pid 236919] Worker Worker(salt=6570948061, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=236919) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: syntax error at or near "fo"
LINE 14:     fo.order_id,
             ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 137, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) syntax error at or near "fo"
LINE 14:     fo.order_id,
             ^

[SQL: INSERT INTO final.fct_order_payments(
    payment_id,
    order_id,
    customer_id,
    payment_type_id,
    payment_date,
    payment_sequential,
    payment_installments,
    payment_value
)

SELECT
    op.id as payment_id
    fo.order_id,
    dc.customer_id,
    pt.payment_type_id,
    dd.date_id AS payment_date,
    op.payment_sequential,
    op.payment_installments,
    op.payment_value

FROM
    stg.orders o
JOIN
    stg.order_payments op ON o.order_id = op.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_payment_types pt ON op.payment_type = pt.payment_type 
JOIN
    final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id

ON CONFLICT(payment_id)
DO UPDATE SET
    order_id = EXCLUDED.order_id,
    customer_id = EXCLUDED.customer_id,
    payment_type_id = EXCLUDED.payment_type_id,
    payment_date = EXCLUDED.payment_date,
    payment_sequential = EXCLUDED.payment_sequential,
    payment_installments = EXCLUDED.payment_installments,
    payment_value = EXCLUDED.payment_value,
    updated_at = CASE WHEN
                        final.fct_order_payments.order_id <> EXCLUDED.order_id
                        OR final.fct_order_payments.customer_id <> EXCLUDED.customer_id
                        OR final.fct_order_payments.payment_type_id <> EXCLUDED.payment_type_id
                        OR final.fct_order_payments.payment_date <> EXCLUDED.payment_date
                        OR final.fct_order_payments.payment_sequential <> EXCLUDED.payment_sequential
                        OR final.fct_order_payments.payment_installments <> EXCLUDED.payment_installments
                        OR final.fct_order_payments.payment_value <> EXCLUDED.payment_value
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_payments.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 21:26:10,719 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:26:10,729 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 21:26:10,729 - DEBUG - Asking scheduler for work...
2024-10-20 21:26:10,733 - DEBUG - Done
2024-10-20 21:26:10,733 - DEBUG - There are no more tasks to run at this time
2024-10-20 21:26:10,733 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 21:26:10,733 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 21:26:10,733 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 21:26:10,733 - INFO - Worker Worker(salt=6570948061, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=236919) was stopped. Shutting down Keep-Alive thread
2024-10-20 21:26:10,735 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 21:26:57,348 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 21:26:57,478 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 21:26:58,340 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 21:26:58,368 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 21:26:58,668 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 21:26:58,675 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 21:26:59,796 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 21:27:00,930 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 21:27:01,773 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 21:27:03,050 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 21:27:03,050 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 21:27:03,052 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 21:27:03,069 - INFO - [pid 238838] Worker Worker(salt=1310857523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=238838) done      Extract()
2024-10-20 21:27:03,070 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:27:03,072 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 21:27:03,072 - DEBUG - Asking scheduler for work...
2024-10-20 21:27:03,074 - DEBUG - Pending tasks: 2
2024-10-20 21:27:03,074 - INFO - [pid 238838] Worker Worker(salt=1310857523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=238838) running   Load()
2024-10-20 21:27:03,080 - INFO - Read Load Query - SUCCESS
2024-10-20 21:27:04,349 - INFO - Read Extracted Data - SUCCESS
2024-10-20 21:27:04,350 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:27:04,642 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 21:27:04,642 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 21:27:26,958 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 21:27:40,999 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 21:27:41,002 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 21:27:41,034 - INFO - [pid 238838] Worker Worker(salt=1310857523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=238838) done      Load()
2024-10-20 21:27:41,035 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:27:41,037 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 21:27:41,037 - DEBUG - Asking scheduler for work...
2024-10-20 21:27:41,038 - DEBUG - Pending tasks: 1
2024-10-20 21:27:41,038 - INFO - [pid 238838] Worker Worker(salt=1310857523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=238838) running   Transform()
2024-10-20 21:27:41,039 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:27:41,043 - INFO - Read Transform Query - SUCCESS
2024-10-20 21:27:41,043 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 21:27:41,203 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 21:27:42,691 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 21:27:42,971 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 21:27:43,029 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 21:27:44,440 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-20 21:27:44,467 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-20 21:27:44,472 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-20 21:27:44,476 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-20 21:27:44,755 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-20 21:27:44,762 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-20 21:27:44,764 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-20 21:27:44,764 - INFO - [pid 238838] Worker Worker(salt=1310857523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=238838) done      Transform()
2024-10-20 21:27:44,764 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:27:44,766 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-20 21:27:44,766 - DEBUG - Asking scheduler for work...
2024-10-20 21:27:44,767 - DEBUG - Done
2024-10-20 21:27:44,768 - DEBUG - There are no more tasks to run at this time
2024-10-20 21:27:44,768 - INFO - Worker Worker(salt=1310857523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=238838) was stopped. Shutting down Keep-Alive thread
2024-10-20 21:27:44,769 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-20 21:40:00,707 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 21:40:00,939 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 21:40:02,058 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 21:40:02,084 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 21:40:02,420 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 21:40:02,426 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 21:40:03,792 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 21:40:06,021 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 21:40:06,725 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 21:40:07,894 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 21:40:07,895 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 21:40:07,906 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 21:40:07,958 - INFO - [pid 245813] Worker Worker(salt=6009759849, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=245813) done      Extract()
2024-10-20 21:40:07,959 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:40:07,968 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 21:40:07,971 - DEBUG - Asking scheduler for work...
2024-10-20 21:40:07,977 - DEBUG - Pending tasks: 2
2024-10-20 21:40:07,977 - INFO - [pid 245813] Worker Worker(salt=6009759849, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=245813) running   Load()
2024-10-20 21:40:07,981 - INFO - Read Load Query - SUCCESS
2024-10-20 21:40:09,806 - INFO - Read Extracted Data - SUCCESS
2024-10-20 21:40:09,808 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:40:10,266 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 21:40:10,266 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 21:40:34,663 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 21:40:47,960 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 21:40:47,963 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 21:40:47,997 - INFO - [pid 245813] Worker Worker(salt=6009759849, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=245813) done      Load()
2024-10-20 21:40:47,997 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:40:48,000 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 21:40:48,000 - DEBUG - Asking scheduler for work...
2024-10-20 21:40:48,001 - DEBUG - Pending tasks: 1
2024-10-20 21:40:48,001 - INFO - [pid 245813] Worker Worker(salt=6009759849, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=245813) running   Transform()
2024-10-20 21:40:48,002 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:40:48,003 - INFO - Read Transform Query - SUCCESS
2024-10-20 21:40:48,003 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 21:40:48,275 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 21:40:50,593 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 21:40:51,145 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 21:40:51,191 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 21:40:52,608 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 21:40:52,610 - ERROR - Transform Tables - FAILED
2024-10-20 21:40:52,610 - ERROR - [pid 245813] Worker Worker(salt=6009759849, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=245813) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT
    o.id AS order_id,
    o.order_id AS dd_order_id,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    os.order_status_id,
    dd.date_id AS order_date,
    
    -- Get total quantity
    COUNT(oi.order_item_id) AS total_quantity,

    -- Get total price
    SUM(oi.price) AS total_price,

    -- Get total freight
    SUM(oi.freight_value) AS total_freight,

    -- Get total amount (total price + total freight)
    SUM(oi.price) + SUM(oi.freight_value) AS total_amount
FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_products dp ON oi.product_id = dp.product_nk
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_order_status os ON o.order_status = os.order_status
JOIN
    final.dim_date dd ON DATE(o.order_purchase_timestamp) = dd.date_actual
GROUP BY 
    o.id,
    o.order_id,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    os.order_status_id,
    dd.date_id 

ON CONFLICT(order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        OR final.fct_orders.product_id <> EXCLUDED.product_id
                        OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        OR final.fct_orders.order_date <> EXCLUDED.order_date
                        OR final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 21:40:52,617 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:40:52,622 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 21:40:52,622 - DEBUG - Asking scheduler for work...
2024-10-20 21:40:52,624 - DEBUG - Done
2024-10-20 21:40:52,624 - DEBUG - There are no more tasks to run at this time
2024-10-20 21:40:52,624 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 21:40:52,624 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 21:40:52,625 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 21:40:52,625 - INFO - Worker Worker(salt=6009759849, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=245813) was stopped. Shutting down Keep-Alive thread
2024-10-20 21:40:52,627 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 21:57:26,112 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 21:57:26,248 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 21:57:26,800 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 21:57:26,830 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 21:57:27,120 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 21:57:27,125 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 21:57:28,735 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 21:57:30,480 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 21:57:31,104 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 21:57:31,989 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 21:57:31,989 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 21:57:31,993 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 21:57:32,015 - INFO - [pid 255157] Worker Worker(salt=1839054834, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=255157) done      Extract()
2024-10-20 21:57:32,017 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:57:32,020 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 21:57:32,020 - DEBUG - Asking scheduler for work...
2024-10-20 21:57:32,022 - DEBUG - Pending tasks: 2
2024-10-20 21:57:32,022 - INFO - [pid 255157] Worker Worker(salt=1839054834, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=255157) running   Load()
2024-10-20 21:57:32,023 - INFO - Read Load Query - SUCCESS
2024-10-20 21:57:33,640 - INFO - Read Extracted Data - SUCCESS
2024-10-20 21:57:33,641 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:57:34,010 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 21:57:34,010 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 21:57:58,505 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 21:58:11,105 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 21:58:11,113 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 21:58:11,158 - INFO - [pid 255157] Worker Worker(salt=1839054834, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=255157) done      Load()
2024-10-20 21:58:11,159 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:58:11,161 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 21:58:11,161 - DEBUG - Asking scheduler for work...
2024-10-20 21:58:11,163 - DEBUG - Pending tasks: 1
2024-10-20 21:58:11,163 - INFO - [pid 255157] Worker Worker(salt=1839054834, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=255157) running   Transform()
2024-10-20 21:58:11,164 - INFO - Connect to DWH - SUCCESS
2024-10-20 21:58:11,167 - INFO - Read Transform Query - SUCCESS
2024-10-20 21:58:11,168 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 21:58:11,388 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 21:58:13,119 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 21:58:13,551 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 21:58:13,599 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 21:58:19,482 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-20 21:58:19,993 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 21:58:19,996 - ERROR - Transform Tables - FAILED
2024-10-20 21:58:19,996 - ERROR - [pid 255157] Worker Worker(salt=1839054834, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=255157) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT
    dd.date_actual AS order_date,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    
    -- Get total order
    COUNT(DISTINCT oi.order_id) AS total_order,

    -- Get total quantity
    COUNT(oi.order_item_id) AS total_quantity,

    -- Get total amount (total price + total freight)
    SUM(oi.price) + SUM(oi.freight_value) AS total_amount
FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_products dp ON oi.product_id = dp.product_nk
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date dd ON DATE(o.order_purchase_timestamp) = dd.date_actual
GROUP BY 
    dd.date_actual,
    dp.product_id,
    dc.customer_id,
    ds.seller_id

ON CONFLICT(order_date)
DO UPDATE SET
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        OR final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 21:58:20,005 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 21:58:20,010 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 21:58:20,010 - DEBUG - Asking scheduler for work...
2024-10-20 21:58:20,011 - DEBUG - Done
2024-10-20 21:58:20,011 - DEBUG - There are no more tasks to run at this time
2024-10-20 21:58:20,012 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 21:58:20,012 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 21:58:20,012 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 21:58:20,012 - INFO - Worker Worker(salt=1839054834, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=255157) was stopped. Shutting down Keep-Alive thread
2024-10-20 21:58:20,013 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 22:02:53,596 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 22:02:53,746 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 22:02:54,328 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 22:02:54,354 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 22:02:54,681 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 22:02:54,686 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 22:02:55,679 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 22:02:56,912 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 22:02:57,535 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 22:02:58,263 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 22:02:58,263 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 22:02:58,266 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 22:02:58,284 - INFO - [pid 258298] Worker Worker(salt=9486928654, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=258298) done      Extract()
2024-10-20 22:02:58,286 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:02:58,288 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 22:02:58,288 - DEBUG - Asking scheduler for work...
2024-10-20 22:02:58,290 - DEBUG - Pending tasks: 2
2024-10-20 22:02:58,291 - INFO - [pid 258298] Worker Worker(salt=9486928654, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=258298) running   Load()
2024-10-20 22:02:58,296 - INFO - Read Load Query - SUCCESS
2024-10-20 22:02:59,811 - INFO - Read Extracted Data - SUCCESS
2024-10-20 22:02:59,813 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:03:00,124 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 22:03:00,125 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 22:03:21,667 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 22:03:32,766 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 22:03:32,770 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 22:03:32,799 - INFO - [pid 258298] Worker Worker(salt=9486928654, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=258298) done      Load()
2024-10-20 22:03:32,800 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:03:32,802 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 22:03:32,802 - DEBUG - Asking scheduler for work...
2024-10-20 22:03:32,804 - DEBUG - Pending tasks: 1
2024-10-20 22:03:32,804 - INFO - [pid 258298] Worker Worker(salt=9486928654, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=258298) running   Transform()
2024-10-20 22:03:32,805 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:03:32,809 - INFO - Read Transform Query - SUCCESS
2024-10-20 22:03:32,809 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 22:03:33,040 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 22:03:34,620 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 22:03:35,052 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 22:03:35,102 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 22:03:40,645 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-20 22:03:41,044 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 22:03:41,045 - ERROR - Transform Tables - FAILED
2024-10-20 22:03:41,045 - ERROR - [pid 258298] Worker Worker(salt=9486928654, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=258298) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT
    dd.date_actual AS order_date,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    
    -- Get total order
    COUNT(DISTINCT oi.order_id) AS total_order,

    -- Get total quantity
    COUNT(oi.order_item_id) AS total_quantity,

    -- Get total amount (total price + total freight)
    SUM(oi.price) + SUM(oi.freight_value) AS total_amount
FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_products dp ON oi.product_id = dp.product_nk
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date dd ON DATE(o.order_purchase_timestamp) = dd.date_actual
GROUP BY 
    dd.date_actual,
    dp.product_id,
    dc.customer_id,
    ds.seller_id

ON CONFLICT (order_date)
DO UPDATE SET
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        OR final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 22:03:41,053 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:03:41,058 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 22:03:41,058 - DEBUG - Asking scheduler for work...
2024-10-20 22:03:41,059 - DEBUG - Done
2024-10-20 22:03:41,059 - DEBUG - There are no more tasks to run at this time
2024-10-20 22:03:41,059 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 22:03:41,059 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 22:03:41,059 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 22:03:41,060 - INFO - Worker Worker(salt=9486928654, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=258298) was stopped. Shutting down Keep-Alive thread
2024-10-20 22:03:41,061 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 22:05:50,815 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 22:05:50,919 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 22:05:51,405 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 22:05:51,432 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 22:05:51,736 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 22:05:51,742 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 22:05:52,551 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 22:05:53,462 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 22:05:54,028 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 22:05:54,685 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 22:05:54,686 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 22:05:54,687 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 22:05:54,706 - INFO - [pid 260071] Worker Worker(salt=2911036967, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=260071) done      Extract()
2024-10-20 22:05:54,707 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:05:54,710 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 22:05:54,710 - DEBUG - Asking scheduler for work...
2024-10-20 22:05:54,711 - DEBUG - Pending tasks: 2
2024-10-20 22:05:54,711 - INFO - [pid 260071] Worker Worker(salt=2911036967, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=260071) running   Load()
2024-10-20 22:05:54,712 - INFO - Read Load Query - SUCCESS
2024-10-20 22:05:55,856 - INFO - Read Extracted Data - SUCCESS
2024-10-20 22:05:55,858 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:05:56,217 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 22:05:56,217 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 22:06:16,522 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 22:06:26,673 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 22:06:26,676 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 22:06:26,707 - INFO - [pid 260071] Worker Worker(salt=2911036967, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=260071) done      Load()
2024-10-20 22:06:26,707 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:06:26,709 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 22:06:26,710 - DEBUG - Asking scheduler for work...
2024-10-20 22:06:26,711 - DEBUG - Pending tasks: 1
2024-10-20 22:06:26,711 - INFO - [pid 260071] Worker Worker(salt=2911036967, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=260071) running   Transform()
2024-10-20 22:06:26,712 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:06:26,714 - INFO - Read Transform Query - SUCCESS
2024-10-20 22:06:26,714 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 22:06:26,930 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 22:06:28,421 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 22:06:28,805 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 22:06:28,844 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 22:06:30,068 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 22:06:30,069 - ERROR - Transform Tables - FAILED
2024-10-20 22:06:30,069 - ERROR - [pid 260071] Worker Worker(salt=2911036967, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=260071) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT DISTINCT
    o.id AS order_id,
    o.order_id AS dd_order_id,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    os.order_status_id,
    dd.date_id AS order_date,
    
    -- Get total quantity
    COUNT(oi.order_item_id) AS total_quantity,

    -- Get total price
    SUM(oi.price) AS total_price,

    -- Get total freight
    SUM(oi.freight_value) AS total_freight,

    -- Get total amount (total price + total freight)
    SUM(oi.price) + SUM(oi.freight_value) AS total_amount
FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_products dp ON oi.product_id = dp.product_nk
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_order_status os ON o.order_status = os.order_status
JOIN
    final.dim_date dd ON DATE(o.order_purchase_timestamp) = dd.date_actual
GROUP BY 
    o.id,
    o.order_id,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    os.order_status_id,
    dd.date_id 

ON CONFLICT (order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        OR final.fct_orders.product_id <> EXCLUDED.product_id
                        OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        OR final.fct_orders.order_date <> EXCLUDED.order_date
                        OR final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 22:06:30,079 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:06:30,085 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 22:06:30,086 - DEBUG - Asking scheduler for work...
2024-10-20 22:06:30,089 - DEBUG - Done
2024-10-20 22:06:30,089 - DEBUG - There are no more tasks to run at this time
2024-10-20 22:06:30,089 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 22:06:30,089 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 22:06:30,089 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 22:06:30,090 - INFO - Worker Worker(salt=2911036967, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=260071) was stopped. Shutting down Keep-Alive thread
2024-10-20 22:06:30,091 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 22:09:52,681 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 22:09:52,779 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 22:09:53,308 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 22:09:53,330 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 22:09:53,603 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 22:09:53,609 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 22:09:54,402 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 22:09:55,318 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 22:09:55,867 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 22:09:56,646 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 22:09:56,646 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 22:09:56,650 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 22:09:56,671 - INFO - [pid 262374] Worker Worker(salt=7868512617, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=262374) done      Extract()
2024-10-20 22:09:56,673 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:09:56,677 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 22:09:56,677 - DEBUG - Asking scheduler for work...
2024-10-20 22:09:56,678 - DEBUG - Pending tasks: 2
2024-10-20 22:09:56,679 - INFO - [pid 262374] Worker Worker(salt=7868512617, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=262374) running   Load()
2024-10-20 22:09:56,684 - INFO - Read Load Query - SUCCESS
2024-10-20 22:09:57,865 - INFO - Read Extracted Data - SUCCESS
2024-10-20 22:09:57,866 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:09:58,194 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 22:09:58,194 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 22:10:18,575 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 22:10:28,883 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 22:10:28,892 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 22:10:28,930 - INFO - [pid 262374] Worker Worker(salt=7868512617, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=262374) done      Load()
2024-10-20 22:10:28,930 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:10:28,934 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 22:10:28,934 - DEBUG - Asking scheduler for work...
2024-10-20 22:10:28,935 - DEBUG - Pending tasks: 1
2024-10-20 22:10:28,936 - INFO - [pid 262374] Worker Worker(salt=7868512617, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=262374) running   Transform()
2024-10-20 22:10:28,937 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:10:28,941 - INFO - Read Transform Query - SUCCESS
2024-10-20 22:10:28,941 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 22:10:29,171 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 22:10:30,687 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 22:10:31,033 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 22:10:31,077 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 22:10:32,216 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 22:10:32,218 - ERROR - Transform Tables - FAILED
2024-10-20 22:10:32,218 - ERROR - [pid 262374] Worker Worker(salt=7868512617, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=262374) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT
    o.id AS order_id,
    o.order_id AS dd_order_id,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    os.order_status_id,
    dd.date_id AS order_date,
    
    -- Get total quantity
    COUNT(oi.order_item_id) AS total_quantity,

    -- Get total price
    SUM(oi.price) AS total_price,

    -- Get total freight
    SUM(oi.freight_value) AS total_freight,

    -- Get total amount (total price + total freight)
    SUM(oi.price) + SUM(oi.freight_value) AS total_amount
FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_products dp ON oi.product_id = dp.product_nk
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_order_status os ON o.order_status = os.order_status
JOIN
    final.dim_date dd ON DATE(o.order_purchase_timestamp) = dd.date_actual
GROUP BY 
    o.id,
    o.order_id,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    os.order_status_id,
    dd.date_id 

ON CONFLICT (order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 22:10:32,226 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:10:32,231 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 22:10:32,231 - DEBUG - Asking scheduler for work...
2024-10-20 22:10:32,236 - DEBUG - Done
2024-10-20 22:10:32,236 - DEBUG - There are no more tasks to run at this time
2024-10-20 22:10:32,236 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 22:10:32,237 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 22:10:32,237 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 22:10:32,237 - INFO - Worker Worker(salt=7868512617, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=262374) was stopped. Shutting down Keep-Alive thread
2024-10-20 22:10:32,239 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 22:31:22,262 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 22:31:22,419 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 22:31:23,140 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 22:31:23,176 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 22:31:23,453 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 22:31:23,460 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 22:31:24,926 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 22:31:26,419 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 22:31:27,171 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 22:31:28,069 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 22:31:28,069 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 22:31:28,072 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 22:31:28,088 - INFO - [pid 273968] Worker Worker(salt=5280589652, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=273968) done      Extract()
2024-10-20 22:31:28,090 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:31:28,093 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 22:31:28,093 - DEBUG - Asking scheduler for work...
2024-10-20 22:31:28,095 - DEBUG - Pending tasks: 2
2024-10-20 22:31:28,095 - INFO - [pid 273968] Worker Worker(salt=5280589652, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=273968) running   Load()
2024-10-20 22:31:28,100 - INFO - Read Load Query - SUCCESS
2024-10-20 22:31:29,755 - INFO - Read Extracted Data - SUCCESS
2024-10-20 22:31:29,756 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:31:30,127 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 22:31:30,128 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 22:31:57,010 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 22:32:09,824 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 22:32:09,831 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 22:32:09,885 - INFO - [pid 273968] Worker Worker(salt=5280589652, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=273968) done      Load()
2024-10-20 22:32:09,885 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:32:09,888 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 22:32:09,888 - DEBUG - Asking scheduler for work...
2024-10-20 22:32:09,889 - DEBUG - Pending tasks: 1
2024-10-20 22:32:09,889 - INFO - [pid 273968] Worker Worker(salt=5280589652, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=273968) running   Transform()
2024-10-20 22:32:09,890 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:32:09,893 - INFO - Read Transform Query - SUCCESS
2024-10-20 22:32:09,893 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 22:32:10,136 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 22:32:11,854 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 22:32:12,420 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 22:32:12,479 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 22:32:13,849 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 22:32:13,851 - ERROR - Transform Tables - FAILED
2024-10-20 22:32:13,851 - ERROR - [pid 273968] Worker Worker(salt=5280589652, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=273968) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT
    o.id AS order_id,
    o.order_id AS dd_order_id,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    os.order_status_id,
    dd.date_id AS order_date,
    
    -- Get total quantity
    COUNT(oi.order_item_id) AS total_quantity,

    -- Get total price
    SUM(oi.price) AS total_price,

    -- Get total freight
    SUM(oi.freight_value) AS total_freight,

    -- Get total amount (total price + total freight)
    SUM(oi.price) + SUM(oi.freight_value) AS total_amount
FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_products dp ON oi.product_id = dp.product_nk
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_order_status os ON o.order_status = os.order_status
JOIN
    final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
GROUP BY 
    o.id,
    o.order_id,
    dp.product_id,
    dc.customer_id,
    ds.seller_id,
    os.order_status_id,
    dd.date_id 

ON CONFLICT (order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 22:32:13,861 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:32:13,867 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 22:32:13,867 - DEBUG - Asking scheduler for work...
2024-10-20 22:32:13,869 - DEBUG - Done
2024-10-20 22:32:13,869 - DEBUG - There are no more tasks to run at this time
2024-10-20 22:32:13,869 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 22:32:13,869 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 22:32:13,869 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 22:32:13,870 - INFO - Worker Worker(salt=5280589652, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=273968) was stopped. Shutting down Keep-Alive thread
2024-10-20 22:32:13,871 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 22:38:25,230 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 22:38:25,343 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 22:38:25,947 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 22:38:25,976 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 22:38:26,293 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 22:38:26,298 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 22:38:27,231 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 22:38:28,418 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 22:38:29,100 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 22:38:29,851 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 22:38:29,851 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 22:38:29,853 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 22:38:29,871 - INFO - [pid 277940] Worker Worker(salt=9852861905, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=277940) done      Extract()
2024-10-20 22:38:29,874 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:38:29,877 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 22:38:29,877 - DEBUG - Asking scheduler for work...
2024-10-20 22:38:29,879 - DEBUG - Pending tasks: 2
2024-10-20 22:38:29,879 - INFO - [pid 277940] Worker Worker(salt=9852861905, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=277940) running   Load()
2024-10-20 22:38:29,880 - INFO - Read Load Query - SUCCESS
2024-10-20 22:38:31,136 - INFO - Read Extracted Data - SUCCESS
2024-10-20 22:38:31,137 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:38:31,516 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 22:38:31,517 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 22:38:52,186 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 22:39:02,846 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 22:39:02,848 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 22:39:02,901 - INFO - [pid 277940] Worker Worker(salt=9852861905, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=277940) done      Load()
2024-10-20 22:39:02,901 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:39:02,904 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 22:39:02,904 - DEBUG - Asking scheduler for work...
2024-10-20 22:39:02,906 - DEBUG - Pending tasks: 1
2024-10-20 22:39:02,906 - INFO - [pid 277940] Worker Worker(salt=9852861905, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=277940) running   Transform()
2024-10-20 22:39:02,908 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:39:02,910 - INFO - Read Transform Query - SUCCESS
2024-10-20 22:39:02,911 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 22:39:03,154 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 22:39:04,799 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 22:39:05,147 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 22:39:05,190 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 22:39:06,251 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 22:39:06,253 - ERROR - Transform Tables - FAILED
2024-10-20 22:39:06,253 - ERROR - [pid 277940] Worker Worker(salt=9852861905, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=277940) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: WITH inserted_data AS (
    SELECT
        o.id AS order_id,
        o.order_id AS dd_order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id AS order_date,
        
        -- Get total quantity
        COUNT(oi.order_item_id) AS total_quantity,

        -- Get total price
        SUM(oi.price) AS total_price,

        -- Get total freight
        SUM(oi.freight_value) AS total_freight,

        -- Get total amount (total price + total freight)
        SUM(oi.price) + SUM(oi.freight_value) AS total_amount
    FROM
        stg.orders o
    JOIN
        stg.order_items oi ON o.order_id = oi.order_id
    JOIN
        final.dim_products dp ON oi.product_id = dp.product_nk
    JOIN
        final.dim_customers dc ON o.customer_id = dc.customer_nk
    JOIN
        final.dim_sellers ds ON oi.seller_id = ds.seller_nk
    JOIN
        final.dim_order_status os ON o.order_status = os.order_status
    JOIN
        final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    GROUP BY 
        o.id,
        o.order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id
)

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM inserted_data
 
ON CONFLICT (order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 22:39:06,261 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:39:06,267 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 22:39:06,267 - DEBUG - Asking scheduler for work...
2024-10-20 22:39:06,269 - DEBUG - Done
2024-10-20 22:39:06,269 - DEBUG - There are no more tasks to run at this time
2024-10-20 22:39:06,269 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 22:39:06,269 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 22:39:06,270 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 22:39:06,270 - INFO - Worker Worker(salt=9852861905, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=277940) was stopped. Shutting down Keep-Alive thread
2024-10-20 22:39:06,271 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 22:44:59,803 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 22:44:59,913 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 22:45:00,492 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 22:45:00,522 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 22:45:00,844 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 22:45:00,851 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 22:45:01,729 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 22:45:02,807 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 22:45:03,434 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 22:45:04,147 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 22:45:04,147 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 22:45:04,148 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 22:45:04,162 - INFO - [pid 281594] Worker Worker(salt=5641450160, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=281594) done      Extract()
2024-10-20 22:45:04,164 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:45:04,166 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 22:45:04,166 - DEBUG - Asking scheduler for work...
2024-10-20 22:45:04,168 - DEBUG - Pending tasks: 2
2024-10-20 22:45:04,168 - INFO - [pid 281594] Worker Worker(salt=5641450160, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=281594) running   Load()
2024-10-20 22:45:04,177 - INFO - Read Load Query - SUCCESS
2024-10-20 22:45:05,257 - INFO - Read Extracted Data - SUCCESS
2024-10-20 22:45:05,259 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:45:05,572 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 22:45:05,572 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 22:45:25,704 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 22:45:36,041 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 22:45:36,050 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 22:45:36,091 - INFO - [pid 281594] Worker Worker(salt=5641450160, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=281594) done      Load()
2024-10-20 22:45:36,091 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:45:36,094 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 22:45:36,094 - DEBUG - Asking scheduler for work...
2024-10-20 22:45:36,095 - DEBUG - Pending tasks: 1
2024-10-20 22:45:36,095 - INFO - [pid 281594] Worker Worker(salt=5641450160, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=281594) running   Transform()
2024-10-20 22:45:36,096 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:45:36,100 - INFO - Read Transform Query - SUCCESS
2024-10-20 22:45:36,100 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 22:45:36,255 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 22:45:37,560 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 22:45:37,775 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 22:45:37,870 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 22:45:39,133 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 22:45:39,134 - ERROR - Transform Tables - FAILED
2024-10-20 22:45:39,134 - ERROR - [pid 281594] Worker Worker(salt=5641450160, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=281594) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: WITH inserted_data AS (
    SELECT
        o.id AS order_id,
        o.order_id AS dd_order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id AS order_date,
        
        -- Get total quantity
        COUNT(oi.order_item_id) AS total_quantity,

        -- Get total price
        SUM(oi.price) AS total_price,

        -- Get total freight
        SUM(oi.freight_value) AS total_freight,

        -- Get total amount (total price + total freight)
        SUM(oi.price) + SUM(oi.freight_value) AS total_amount
    FROM
        stg.orders o
    JOIN
        stg.order_items oi ON o.order_id = oi.order_id
    JOIN
        final.dim_products dp ON oi.product_id = dp.product_nk
    JOIN
        final.dim_customers dc ON o.customer_id = dc.customer_nk
    JOIN
        final.dim_sellers ds ON oi.seller_id = ds.seller_nk
    JOIN
        final.dim_order_status os ON o.order_status = os.order_status
    JOIN
        final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    GROUP BY 
        o.id,
        o.order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id
)

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM inserted_data
 
ON CONFLICT (order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 22:45:39,143 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:45:39,150 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 22:45:39,150 - DEBUG - Asking scheduler for work...
2024-10-20 22:45:39,152 - DEBUG - Done
2024-10-20 22:45:39,152 - DEBUG - There are no more tasks to run at this time
2024-10-20 22:45:39,152 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 22:45:39,152 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 22:45:39,152 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 22:45:39,153 - INFO - Worker Worker(salt=5641450160, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=281594) was stopped. Shutting down Keep-Alive thread
2024-10-20 22:45:39,153 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 22:48:04,681 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 22:48:04,777 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 22:48:05,324 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 22:48:05,349 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 22:48:05,627 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 22:48:05,632 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 22:48:06,409 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 22:48:07,399 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 22:48:07,983 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 22:48:08,666 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 22:48:08,666 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 22:48:08,667 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 22:48:08,688 - INFO - [pid 283450] Worker Worker(salt=9693001522, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=283450) done      Extract()
2024-10-20 22:48:08,690 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:48:08,693 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 22:48:08,693 - DEBUG - Asking scheduler for work...
2024-10-20 22:48:08,695 - DEBUG - Pending tasks: 2
2024-10-20 22:48:08,695 - INFO - [pid 283450] Worker Worker(salt=9693001522, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=283450) running   Load()
2024-10-20 22:48:08,695 - INFO - Read Load Query - SUCCESS
2024-10-20 22:48:09,843 - INFO - Read Extracted Data - SUCCESS
2024-10-20 22:48:09,844 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:48:10,240 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 22:48:10,240 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 22:48:30,752 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 22:48:41,271 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 22:48:41,281 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 22:48:41,325 - INFO - [pid 283450] Worker Worker(salt=9693001522, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=283450) done      Load()
2024-10-20 22:48:41,326 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:48:41,328 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 22:48:41,329 - DEBUG - Asking scheduler for work...
2024-10-20 22:48:41,330 - DEBUG - Pending tasks: 1
2024-10-20 22:48:41,330 - INFO - [pid 283450] Worker Worker(salt=9693001522, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=283450) running   Transform()
2024-10-20 22:48:41,331 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:48:41,334 - INFO - Read Transform Query - SUCCESS
2024-10-20 22:48:41,334 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 22:48:41,507 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 22:48:42,871 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 22:48:43,073 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 22:48:43,113 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 22:48:45,405 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 22:48:45,407 - ERROR - Transform Tables - FAILED
2024-10-20 22:48:45,407 - ERROR - [pid 283450] Worker Worker(salt=9693001522, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=283450) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: WITH inserted_data AS (
    SELECT
        o.id AS order_id,
        o.order_id AS dd_order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id AS order_date,
        
        -- Get total quantity
        COUNT(oi.order_item_id) AS total_quantity,

        -- Get total price
        SUM(oi.price) AS total_price,

        -- Get total freight
        SUM(oi.freight_value) AS total_freight,

        -- Get total amount (total price + total freight)
        SUM(oi.price) + SUM(oi.freight_value) AS total_amount
    FROM
        stg.orders o
    JOIN
        stg.order_items oi ON o.order_id = oi.order_id
    JOIN
        final.dim_products dp ON oi.product_id = dp.product_nk
    JOIN
        final.dim_customers dc ON o.customer_id = dc.customer_nk
    JOIN
        final.dim_sellers ds ON oi.seller_id = ds.seller_nk
    JOIN
        final.dim_order_status os ON o.order_status = os.order_status
    JOIN
        final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    GROUP BY 
        o.id,
        o.order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id
)

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT DISTINCT * FROM inserted_data
 
ON CONFLICT (order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 22:48:45,414 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:48:45,421 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 22:48:45,421 - DEBUG - Asking scheduler for work...
2024-10-20 22:48:45,423 - DEBUG - Done
2024-10-20 22:48:45,423 - DEBUG - There are no more tasks to run at this time
2024-10-20 22:48:45,423 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 22:48:45,423 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 22:48:45,423 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 22:48:45,424 - INFO - Worker Worker(salt=9693001522, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=283450) was stopped. Shutting down Keep-Alive thread
2024-10-20 22:48:45,428 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 22:58:15,299 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 22:58:15,403 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 22:58:16,011 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 22:58:16,038 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 22:58:16,334 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 22:58:16,341 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 22:58:17,307 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 22:58:18,645 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 22:58:19,213 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 22:58:20,024 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 22:58:20,025 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 22:58:20,027 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 22:58:20,045 - INFO - [pid 289403] Worker Worker(salt=583255893, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=289403) done      Extract()
2024-10-20 22:58:20,046 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:58:20,049 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 22:58:20,049 - DEBUG - Asking scheduler for work...
2024-10-20 22:58:20,050 - DEBUG - Pending tasks: 2
2024-10-20 22:58:20,051 - INFO - [pid 289403] Worker Worker(salt=583255893, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=289403) running   Load()
2024-10-20 22:58:20,055 - INFO - Read Load Query - SUCCESS
2024-10-20 22:58:21,341 - INFO - Read Extracted Data - SUCCESS
2024-10-20 22:58:21,342 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:58:21,716 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 22:58:21,716 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 22:58:45,774 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 22:58:59,870 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 22:58:59,874 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 22:58:59,948 - INFO - [pid 289403] Worker Worker(salt=583255893, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=289403) done      Load()
2024-10-20 22:58:59,948 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:58:59,952 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 22:58:59,952 - DEBUG - Asking scheduler for work...
2024-10-20 22:58:59,954 - DEBUG - Pending tasks: 1
2024-10-20 22:58:59,954 - INFO - [pid 289403] Worker Worker(salt=583255893, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=289403) running   Transform()
2024-10-20 22:58:59,956 - INFO - Connect to DWH - SUCCESS
2024-10-20 22:58:59,960 - INFO - Read Transform Query - SUCCESS
2024-10-20 22:58:59,960 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 22:59:00,113 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 22:59:02,126 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 22:59:02,351 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 22:59:02,406 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 22:59:04,794 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 22:59:04,796 - ERROR - Transform Tables - FAILED
2024-10-20 22:59:04,796 - ERROR - [pid 289403] Worker Worker(salt=583255893, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=289403) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: WITH inserted_data AS (
    SELECT
        o.id AS order_id,
        o.order_id AS dd_order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id AS order_date,
        
        -- Get total quantity
        COUNT(oi.order_item_id) AS total_quantity,

        -- Get total price
        SUM(oi.price) AS total_price,

        -- Get total freight
        SUM(oi.freight_value) AS total_freight,

        -- Get total amount (total price + total freight)
        SUM(oi.price) + SUM(oi.freight_value) AS total_amount
    FROM
        stg.orders o
    JOIN
        stg.order_items oi ON o.order_id = oi.order_id
    JOIN
        final.dim_products dp ON oi.product_id = dp.product_nk
    JOIN
        final.dim_customers dc ON o.customer_id = dc.customer_nk
    JOIN
        final.dim_sellers ds ON oi.seller_id = ds.seller_nk
    JOIN
        final.dim_order_status os ON o.order_status = os.order_status
    JOIN
        final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    GROUP BY 
        o.id,
        o.order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id
)

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT DISTINCT * FROM inserted_data
 
ON CONFLICT (order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 22:59:04,804 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 22:59:04,809 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 22:59:04,810 - DEBUG - Asking scheduler for work...
2024-10-20 22:59:04,812 - DEBUG - Done
2024-10-20 22:59:04,812 - DEBUG - There are no more tasks to run at this time
2024-10-20 22:59:04,812 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 22:59:04,813 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 22:59:04,813 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 22:59:04,813 - INFO - Worker Worker(salt=583255893, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=289403) was stopped. Shutting down Keep-Alive thread
2024-10-20 22:59:04,814 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 23:03:13,960 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 23:03:14,086 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 23:03:14,618 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 23:03:14,653 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 23:03:14,934 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 23:03:14,940 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 23:03:15,778 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 23:03:16,819 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 23:03:17,364 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 23:03:18,177 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 23:03:18,177 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 23:03:18,182 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 23:03:18,246 - INFO - [pid 292287] Worker Worker(salt=5557712758, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=292287) done      Extract()
2024-10-20 23:03:18,249 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:03:18,255 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 23:03:18,263 - DEBUG - Asking scheduler for work...
2024-10-20 23:03:18,274 - DEBUG - Pending tasks: 2
2024-10-20 23:03:18,275 - INFO - [pid 292287] Worker Worker(salt=5557712758, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=292287) running   Load()
2024-10-20 23:03:18,282 - INFO - Read Load Query - SUCCESS
2024-10-20 23:03:19,647 - INFO - Read Extracted Data - SUCCESS
2024-10-20 23:03:19,648 - INFO - Connect to DWH - SUCCESS
2024-10-20 23:03:20,057 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 23:03:20,057 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 23:03:41,386 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 23:03:53,454 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 23:03:53,455 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 23:03:53,487 - INFO - [pid 292287] Worker Worker(salt=5557712758, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=292287) done      Load()
2024-10-20 23:03:53,488 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:03:53,490 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 23:03:53,491 - DEBUG - Asking scheduler for work...
2024-10-20 23:03:53,492 - DEBUG - Pending tasks: 1
2024-10-20 23:03:53,493 - INFO - [pid 292287] Worker Worker(salt=5557712758, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=292287) running   Transform()
2024-10-20 23:03:53,494 - INFO - Connect to DWH - SUCCESS
2024-10-20 23:03:53,497 - INFO - Read Transform Query - SUCCESS
2024-10-20 23:03:53,497 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 23:03:53,657 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 23:03:54,939 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 23:03:55,135 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 23:03:55,205 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 23:03:55,215 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 23:03:55,219 - ERROR - Transform Tables - FAILED
2024-10-20 23:03:55,219 - ERROR - [pid 292287] Worker Worker(salt=5557712758, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=292287) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.GroupingError: column "dp.product_id" must appear in the GROUP BY clause or be used in an aggregate function
LINE 5:         dp.product_id,
                ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.GroupingError) column "dp.product_id" must appear in the GROUP BY clause or be used in an aggregate function
LINE 5:         dp.product_id,
                ^

[SQL: WITH inserted_data AS (
    SELECT
        o.id AS order_id,
        o.order_id AS dd_order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id AS order_date,
        
        -- Get total quantity
        COUNT(oi.order_item_id) AS total_quantity,

        -- Get total price
        SUM(oi.price) AS total_price,

        -- Get total freight
        SUM(oi.freight_value) AS total_freight,

        -- Get total amount (total price + total freight)
        SUM(oi.price) + SUM(oi.freight_value) AS total_amount
    FROM
        stg.orders o
    JOIN
        stg.order_items oi ON o.order_id = oi.order_id
    JOIN
        final.dim_products dp ON oi.product_id = dp.product_nk
    JOIN
        final.dim_customers dc ON o.customer_id = dc.customer_nk
    JOIN
        final.dim_sellers ds ON oi.seller_id = ds.seller_nk
    JOIN
        final.dim_order_status os ON o.order_status = os.order_status
    JOIN
        final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    GROUP BY 
        o.id,
        o.order_id
        -- dp.product_id,
        -- dc.customer_id,
        -- ds.seller_id,
        -- os.order_status_id,
        -- dd.date_id
)

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT DISTINCT * FROM inserted_data
 
ON CONFLICT (order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 23:03:55,230 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:03:55,237 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 23:03:55,237 - DEBUG - Asking scheduler for work...
2024-10-20 23:03:55,238 - DEBUG - Done
2024-10-20 23:03:55,239 - DEBUG - There are no more tasks to run at this time
2024-10-20 23:03:55,239 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 23:03:55,239 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 23:03:55,239 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 23:03:55,239 - INFO - Worker Worker(salt=5557712758, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=292287) was stopped. Shutting down Keep-Alive thread
2024-10-20 23:03:55,240 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 23:10:38,500 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 23:10:38,648 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 23:10:39,288 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 23:10:39,316 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 23:10:39,627 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 23:10:39,632 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 23:10:40,563 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 23:10:41,675 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 23:10:42,273 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 23:10:43,031 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 23:10:43,031 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 23:10:43,032 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 23:10:43,049 - INFO - [pid 296512] Worker Worker(salt=8382032303, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=296512) done      Extract()
2024-10-20 23:10:43,050 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:10:43,054 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 23:10:43,054 - DEBUG - Asking scheduler for work...
2024-10-20 23:10:43,056 - DEBUG - Pending tasks: 2
2024-10-20 23:10:43,057 - INFO - [pid 296512] Worker Worker(salt=8382032303, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=296512) running   Load()
2024-10-20 23:10:43,071 - INFO - Read Load Query - SUCCESS
2024-10-20 23:10:44,297 - INFO - Read Extracted Data - SUCCESS
2024-10-20 23:10:44,298 - INFO - Connect to DWH - SUCCESS
2024-10-20 23:10:44,695 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 23:10:44,695 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 23:11:05,939 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 23:11:16,279 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 23:11:16,280 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 23:11:16,310 - INFO - [pid 296512] Worker Worker(salt=8382032303, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=296512) done      Load()
2024-10-20 23:11:16,310 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:11:16,312 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 23:11:16,312 - DEBUG - Asking scheduler for work...
2024-10-20 23:11:16,314 - DEBUG - Pending tasks: 1
2024-10-20 23:11:16,314 - INFO - [pid 296512] Worker Worker(salt=8382032303, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=296512) running   Transform()
2024-10-20 23:11:16,315 - INFO - Connect to DWH - SUCCESS
2024-10-20 23:11:16,318 - INFO - Read Transform Query - SUCCESS
2024-10-20 23:11:16,318 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 23:11:16,471 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 23:11:17,736 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 23:11:17,989 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 23:11:18,039 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 23:11:18,042 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 23:11:18,044 - ERROR - Transform Tables - FAILED
2024-10-20 23:11:18,044 - ERROR - [pid 296512] Worker Worker(salt=8382032303, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=296512) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: syntax error at or near "dp"
LINE 39:         dp.product_id,
                 ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) syntax error at or near "dp"
LINE 39:         dp.product_id,
                 ^

[SQL: WITH inserted_data AS (
    SELECT
        o.id AS order_id,
        o.order_id AS dd_order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id AS order_date,
        
        -- Get total quantity
        COUNT(oi.order_item_id) AS total_quantity,

        -- Get total price
        SUM(oi.price) AS total_price,

        -- Get total freight
        SUM(oi.freight_value) AS total_freight,

        -- Get total amount (total price + total freight)
        SUM(oi.price) + SUM(oi.freight_value) AS total_amount
    FROM
        stg.orders o
    JOIN
        stg.order_items oi ON o.order_id = oi.order_id
    JOIN
        final.dim_products dp ON oi.product_id = dp.product_nk
    JOIN
        final.dim_customers dc ON o.customer_id = dc.customer_nk
    JOIN
        final.dim_sellers ds ON oi.seller_id = ds.seller_nk
    JOIN
        final.dim_order_status os ON o.order_status = os.order_status
    JOIN
        final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    GROUP BY 
        o.id,
        o.order_id
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id
)

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM inserted_data
 
ON CONFLICT (order_id, dd_order_id, product_id, customer_id, seller_id, order_status_id, order_date)
DO UPDATE SET
    -- dd_order_id = EXCLUDED.dd_order_id,
    -- product_id = EXCLUDED.product_id,
    -- customer_id = EXCLUDED.customer_id,
    -- seller_id = EXCLUDED.seller_id,
    -- order_status_id = EXCLUDED.order_status_id,
    -- order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 23:11:18,047 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:11:18,055 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 23:11:18,055 - DEBUG - Asking scheduler for work...
2024-10-20 23:11:18,057 - DEBUG - Done
2024-10-20 23:11:18,057 - DEBUG - There are no more tasks to run at this time
2024-10-20 23:11:18,057 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 23:11:18,057 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 23:11:18,057 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 23:11:18,057 - INFO - Worker Worker(salt=8382032303, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=296512) was stopped. Shutting down Keep-Alive thread
2024-10-20 23:11:18,059 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 23:11:57,159 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 23:11:57,283 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 23:11:57,731 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 23:11:57,756 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 23:11:58,039 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 23:11:58,048 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 23:11:58,933 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 23:11:59,911 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 23:12:00,407 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 23:12:01,021 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 23:12:01,021 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 23:12:01,022 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 23:12:01,045 - INFO - [pid 297393] Worker Worker(salt=5059644935, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=297393) done      Extract()
2024-10-20 23:12:01,047 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:12:01,050 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 23:12:01,051 - DEBUG - Asking scheduler for work...
2024-10-20 23:12:01,053 - DEBUG - Pending tasks: 2
2024-10-20 23:12:01,053 - INFO - [pid 297393] Worker Worker(salt=5059644935, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=297393) running   Load()
2024-10-20 23:12:01,055 - INFO - Read Load Query - SUCCESS
2024-10-20 23:12:02,672 - INFO - Read Extracted Data - SUCCESS
2024-10-20 23:12:02,674 - INFO - Connect to DWH - SUCCESS
2024-10-20 23:12:02,972 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 23:12:02,972 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 23:12:23,347 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 23:12:33,164 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 23:12:33,179 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 23:12:33,213 - INFO - [pid 297393] Worker Worker(salt=5059644935, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=297393) done      Load()
2024-10-20 23:12:33,213 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:12:33,216 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 23:12:33,216 - DEBUG - Asking scheduler for work...
2024-10-20 23:12:33,217 - DEBUG - Pending tasks: 1
2024-10-20 23:12:33,217 - INFO - [pid 297393] Worker Worker(salt=5059644935, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=297393) running   Transform()
2024-10-20 23:12:33,218 - INFO - Connect to DWH - SUCCESS
2024-10-20 23:12:33,222 - INFO - Read Transform Query - SUCCESS
2024-10-20 23:12:33,222 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 23:12:33,371 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 23:12:34,642 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 23:12:34,924 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 23:12:34,969 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 23:12:36,239 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 23:12:36,241 - ERROR - Transform Tables - FAILED
2024-10-20 23:12:36,241 - ERROR - [pid 297393] Worker Worker(salt=5059644935, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=297393) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "pk_fct_orders"
DETAIL:  Key (order_id)=(d0a73897-c43f-4e77-b037-e6c38858ca3c) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "pk_fct_orders"
DETAIL:  Key (order_id)=(d0a73897-c43f-4e77-b037-e6c38858ca3c) already exists.

[SQL: WITH inserted_data AS (
    SELECT
        o.id AS order_id,
        o.order_id AS dd_order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id AS order_date,
        
        -- Get total quantity
        COUNT(oi.order_item_id) AS total_quantity,

        -- Get total price
        SUM(oi.price) AS total_price,

        -- Get total freight
        SUM(oi.freight_value) AS total_freight,

        -- Get total amount (total price + total freight)
        SUM(oi.price) + SUM(oi.freight_value) AS total_amount
    FROM
        stg.orders o
    JOIN
        stg.order_items oi ON o.order_id = oi.order_id
    JOIN
        final.dim_products dp ON oi.product_id = dp.product_nk
    JOIN
        final.dim_customers dc ON o.customer_id = dc.customer_nk
    JOIN
        final.dim_sellers ds ON oi.seller_id = ds.seller_nk
    JOIN
        final.dim_order_status os ON o.order_status = os.order_status
    JOIN
        final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    GROUP BY 
        o.id,
        o.order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id
)

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM inserted_data
 
ON CONFLICT (order_id, dd_order_id, product_id, customer_id, seller_id, order_status_id, order_date)
DO UPDATE SET
    -- dd_order_id = EXCLUDED.dd_order_id,
    -- product_id = EXCLUDED.product_id,
    -- customer_id = EXCLUDED.customer_id,
    -- seller_id = EXCLUDED.seller_id,
    -- order_status_id = EXCLUDED.order_status_id,
    -- order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 23:12:36,248 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:12:36,255 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 23:12:36,255 - DEBUG - Asking scheduler for work...
2024-10-20 23:12:36,258 - DEBUG - Done
2024-10-20 23:12:36,258 - DEBUG - There are no more tasks to run at this time
2024-10-20 23:12:36,258 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 23:12:36,258 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 23:12:36,258 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 23:12:36,259 - INFO - Worker Worker(salt=5059644935, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=297393) was stopped. Shutting down Keep-Alive thread
2024-10-20 23:12:36,260 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-20 23:17:53,213 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-20 23:17:53,314 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-20 23:17:53,825 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-20 23:17:53,853 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-20 23:17:54,212 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-20 23:17:54,217 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-20 23:17:54,997 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-20 23:17:55,920 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-20 23:17:56,460 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-20 23:17:57,201 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-20 23:17:57,202 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-20 23:17:57,203 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-20 23:17:57,229 - INFO - [pid 300770] Worker Worker(salt=5555332534, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=300770) done      Extract()
2024-10-20 23:17:57,231 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:17:57,233 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-20 23:17:57,233 - DEBUG - Asking scheduler for work...
2024-10-20 23:17:57,235 - DEBUG - Pending tasks: 2
2024-10-20 23:17:57,235 - INFO - [pid 300770] Worker Worker(salt=5555332534, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=300770) running   Load()
2024-10-20 23:17:57,240 - INFO - Read Load Query - SUCCESS
2024-10-20 23:17:58,409 - INFO - Read Extracted Data - SUCCESS
2024-10-20 23:17:58,410 - INFO - Connect to DWH - SUCCESS
2024-10-20 23:17:58,736 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-20 23:17:58,736 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-20 23:18:19,887 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-20 23:18:30,722 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-20 23:18:30,727 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-20 23:18:30,766 - INFO - [pid 300770] Worker Worker(salt=5555332534, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=300770) done      Load()
2024-10-20 23:18:30,766 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:18:30,769 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-20 23:18:30,769 - DEBUG - Asking scheduler for work...
2024-10-20 23:18:30,770 - DEBUG - Pending tasks: 1
2024-10-20 23:18:30,770 - INFO - [pid 300770] Worker Worker(salt=5555332534, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=300770) running   Transform()
2024-10-20 23:18:30,772 - INFO - Connect to DWH - SUCCESS
2024-10-20 23:18:30,776 - INFO - Read Transform Query - SUCCESS
2024-10-20 23:18:30,777 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-20 23:18:30,925 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-20 23:18:32,239 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-20 23:18:32,440 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-20 23:18:32,484 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-20 23:18:33,719 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-20 23:18:33,720 - ERROR - Transform Tables - FAILED
2024-10-20 23:18:33,720 - ERROR - [pid 300770] Worker Worker(salt=5555332534, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=300770) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: WITH inserted_data AS (
    SELECT
        o.id AS order_id,
        o.order_id AS dd_order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id AS order_date,
        
        -- Get total quantity
        COUNT(oi.order_item_id) AS total_quantity,

        -- Get total price
        SUM(oi.price) AS total_price,

        -- Get total freight
        SUM(oi.freight_value) AS total_freight,

        -- Get total amount (total price + total freight)
        SUM(oi.price) + SUM(oi.freight_value) AS total_amount
    FROM
        stg.orders o
    JOIN
        stg.order_items oi ON o.order_id = oi.order_id
    JOIN
        final.dim_products dp ON oi.product_id = dp.product_nk
    JOIN
        final.dim_customers dc ON o.customer_id = dc.customer_nk
    JOIN
        final.dim_sellers ds ON oi.seller_id = ds.seller_nk
    JOIN
        final.dim_order_status os ON o.order_status = os.order_status
    JOIN
        final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    GROUP BY 
        o.id,
        o.order_id,
        dp.product_id,
        dc.customer_id,
        ds.seller_id,
        os.order_status_id,
        dd.date_id
)

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM inserted_data
 
ON CONFLICT (order_id)
DO UPDATE SET
    dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        -- OR final.fct_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        -- OR final.fct_orders.order_date <> EXCLUDED.order_date
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-20 23:18:33,729 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-20 23:18:33,735 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-20 23:18:33,736 - DEBUG - Asking scheduler for work...
2024-10-20 23:18:33,737 - DEBUG - Done
2024-10-20 23:18:33,738 - DEBUG - There are no more tasks to run at this time
2024-10-20 23:18:33,738 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-20 23:18:33,738 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-20 23:18:33,738 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-20 23:18:33,738 - INFO - Worker Worker(salt=5555332534, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=300770) was stopped. Shutting down Keep-Alive thread
2024-10-20 23:18:33,740 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 00:11:44,104 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 00:11:44,355 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 00:11:45,644 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 00:11:45,685 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 00:11:46,131 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 00:11:46,140 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 00:11:49,272 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 00:11:53,068 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 00:11:53,878 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 00:11:55,277 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 00:11:55,278 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 00:11:55,284 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 00:11:55,309 - INFO - [pid 330203] Worker Worker(salt=668925302, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=330203) done      Extract()
2024-10-21 00:11:55,310 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:11:55,312 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 00:11:55,312 - DEBUG - Asking scheduler for work...
2024-10-21 00:11:55,314 - DEBUG - Pending tasks: 2
2024-10-21 00:11:55,314 - INFO - [pid 330203] Worker Worker(salt=668925302, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=330203) running   Load()
2024-10-21 00:11:55,315 - INFO - Read Load Query - SUCCESS
2024-10-21 00:11:58,787 - INFO - Read Extracted Data - SUCCESS
2024-10-21 00:11:58,788 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:11:59,249 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 00:11:59,250 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 00:12:30,726 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 00:12:42,640 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 00:12:42,648 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 00:12:42,689 - INFO - [pid 330203] Worker Worker(salt=668925302, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=330203) done      Load()
2024-10-21 00:12:42,689 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:12:42,692 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 00:12:42,692 - DEBUG - Asking scheduler for work...
2024-10-21 00:12:42,694 - DEBUG - Pending tasks: 1
2024-10-21 00:12:42,694 - INFO - [pid 330203] Worker Worker(salt=668925302, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=330203) running   Transform()
2024-10-21 00:12:42,695 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:12:42,698 - INFO - Read Transform Query - SUCCESS
2024-10-21 00:12:42,698 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 00:12:42,858 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 00:12:44,264 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 00:12:44,528 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 00:12:44,576 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 00:12:44,579 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 00:12:44,580 - ERROR - Transform Tables - FAILED
2024-10-21 00:12:44,580 - ERROR - [pid 330203] Worker Worker(salt=668925302, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=330203) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: syntax error at or near "FROM"
LINE 41:         FROM stg_order_items
                 ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) syntax error at or near "FROM"
LINE 41:         FROM stg_order_items
                 ^

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity,
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price,
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_freight AS (
        SELECT 
            order_id,
            SUM(freight_value) AS total_freight,
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_orders AS (
        SELECT
            oi.id AS order_id,
            o.order_id AS dd_order_id,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ctq.total_quantity AS total_quantity,
            ctp.total_price AS total_price,
            ctf.total_freight AS total_freight,
            (ctp.total_price + ctf.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_price ctp ON oi.order_id = ctp.order_id
        JOIN
            cnt_total_freight ctf ON oi.order_id = ctf.order_id 
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM final_fct_orders
 
ON CONFLICT (order_id, dd_order_id)
DO UPDATE SET
    -- dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        final.fct_orders.product_id <> EXCLUDED.product_id
                        OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        OR final.fct_orders.order_date <> EXCLUDED.order_date
                        OR final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 00:12:44,594 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:12:44,603 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 00:12:44,603 - DEBUG - Asking scheduler for work...
2024-10-21 00:12:44,606 - DEBUG - Done
2024-10-21 00:12:44,606 - DEBUG - There are no more tasks to run at this time
2024-10-21 00:12:44,606 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 00:12:44,606 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 00:12:44,606 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 00:12:44,606 - INFO - Worker Worker(salt=668925302, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=330203) was stopped. Shutting down Keep-Alive thread
2024-10-21 00:12:44,607 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 00:17:45,893 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 00:17:46,083 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 00:17:47,419 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 00:17:47,472 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 00:17:47,970 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 00:17:47,978 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 00:17:49,539 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 00:17:51,441 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 00:17:52,237 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 00:17:53,359 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 00:17:53,360 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 00:17:53,362 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 00:17:53,399 - INFO - [pid 333796] Worker Worker(salt=1967212341, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=333796) done      Extract()
2024-10-21 00:17:53,401 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:17:53,405 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 00:17:53,405 - DEBUG - Asking scheduler for work...
2024-10-21 00:17:53,408 - DEBUG - Pending tasks: 2
2024-10-21 00:17:53,408 - INFO - [pid 333796] Worker Worker(salt=1967212341, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=333796) running   Load()
2024-10-21 00:17:53,409 - INFO - Read Load Query - SUCCESS
2024-10-21 00:17:55,021 - INFO - Read Extracted Data - SUCCESS
2024-10-21 00:17:55,022 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:17:55,395 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 00:17:55,395 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 00:18:16,419 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 00:18:26,763 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 00:18:26,764 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 00:18:26,810 - INFO - [pid 333796] Worker Worker(salt=1967212341, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=333796) done      Load()
2024-10-21 00:18:26,810 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:18:26,813 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 00:18:26,813 - DEBUG - Asking scheduler for work...
2024-10-21 00:18:26,814 - DEBUG - Pending tasks: 1
2024-10-21 00:18:26,814 - INFO - [pid 333796] Worker Worker(salt=1967212341, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=333796) running   Transform()
2024-10-21 00:18:26,815 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:18:26,819 - INFO - Read Transform Query - SUCCESS
2024-10-21 00:18:26,819 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 00:18:26,954 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 00:18:28,248 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 00:18:28,499 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 00:18:28,539 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 00:18:28,543 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 00:18:28,545 - ERROR - Transform Tables - FAILED
2024-10-21 00:18:28,546 - ERROR - [pid 333796] Worker Worker(salt=1967212341, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=333796) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: syntax error at or near "FROM"
LINE 41:         FROM stg_order_items
                 ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) syntax error at or near "FROM"
LINE 41:         FROM stg_order_items
                 ^

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity,
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_freight AS (
        SELECT 
            order_id,
            SUM(freight_value) AS total_freight
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_orders AS (
        SELECT
            oi.id AS order_id,
            o.order_id AS dd_order_id,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ctq.total_quantity AS total_quantity,
            ctp.total_price AS total_price,
            ctf.total_freight AS total_freight,
            (ctp.total_price + ctf.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_price ctp ON oi.order_id = ctp.order_id
        JOIN
            cnt_total_freight ctf ON oi.order_id = ctf.order_id 
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM final_fct_orders
 
ON CONFLICT (order_id, dd_order_id)
DO UPDATE SET
    -- dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        final.fct_orders.product_id <> EXCLUDED.product_id
                        OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        OR final.fct_orders.order_date <> EXCLUDED.order_date
                        OR final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 00:18:28,553 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:18:28,562 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 00:18:28,563 - DEBUG - Asking scheduler for work...
2024-10-21 00:18:28,565 - DEBUG - Done
2024-10-21 00:18:28,565 - DEBUG - There are no more tasks to run at this time
2024-10-21 00:18:28,566 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 00:18:28,566 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 00:18:28,566 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 00:18:28,566 - INFO - Worker Worker(salt=1967212341, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=333796) was stopped. Shutting down Keep-Alive thread
2024-10-21 00:18:28,567 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 00:20:02,731 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 00:20:02,842 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 00:20:03,356 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 00:20:03,384 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 00:20:03,669 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 00:20:03,681 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 00:20:04,560 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 00:20:05,564 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 00:20:06,147 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 00:20:06,824 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 00:20:06,824 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 00:20:06,826 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 00:20:06,845 - INFO - [pid 335263] Worker Worker(salt=2058216820, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=335263) done      Extract()
2024-10-21 00:20:06,846 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:20:06,849 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 00:20:06,849 - DEBUG - Asking scheduler for work...
2024-10-21 00:20:06,850 - DEBUG - Pending tasks: 2
2024-10-21 00:20:06,850 - INFO - [pid 335263] Worker Worker(salt=2058216820, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=335263) running   Load()
2024-10-21 00:20:06,856 - INFO - Read Load Query - SUCCESS
2024-10-21 00:20:08,130 - INFO - Read Extracted Data - SUCCESS
2024-10-21 00:20:08,131 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:20:08,517 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 00:20:08,518 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 00:20:29,078 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 00:20:39,300 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 00:20:39,304 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 00:20:39,337 - INFO - [pid 335263] Worker Worker(salt=2058216820, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=335263) done      Load()
2024-10-21 00:20:39,337 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:20:39,340 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 00:20:39,340 - DEBUG - Asking scheduler for work...
2024-10-21 00:20:39,342 - DEBUG - Pending tasks: 1
2024-10-21 00:20:39,342 - INFO - [pid 335263] Worker Worker(salt=2058216820, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=335263) running   Transform()
2024-10-21 00:20:39,343 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:20:39,346 - INFO - Read Transform Query - SUCCESS
2024-10-21 00:20:39,346 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 00:20:39,498 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 00:20:40,873 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 00:20:41,064 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 00:20:41,106 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 00:20:41,118 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 00:20:41,122 - ERROR - Transform Tables - FAILED
2024-10-21 00:20:41,123 - ERROR - [pid 335263] Worker Worker(salt=2058216820, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=335263) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.InvalidColumnReference: there is no unique or exclusion constraint matching the ON CONFLICT specification


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.InvalidColumnReference) there is no unique or exclusion constraint matching the ON CONFLICT specification

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_freight AS (
        SELECT 
            order_id,
            SUM(freight_value) AS total_freight
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_orders AS (
        SELECT
            oi.id AS order_id,
            o.order_id AS dd_order_id,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ctq.total_quantity AS total_quantity,
            ctp.total_price AS total_price,
            ctf.total_freight AS total_freight,
            (ctp.total_price + ctf.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_price ctp ON oi.order_id = ctp.order_id
        JOIN
            cnt_total_freight ctf ON oi.order_id = ctf.order_id 
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM final_fct_orders
 
ON CONFLICT (order_id, dd_order_id)
DO UPDATE SET
    -- dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        final.fct_orders.product_id <> EXCLUDED.product_id
                        OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        OR final.fct_orders.order_date <> EXCLUDED.order_date
                        OR final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 00:20:41,141 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:20:41,151 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 00:20:41,152 - DEBUG - Asking scheduler for work...
2024-10-21 00:20:41,155 - DEBUG - Done
2024-10-21 00:20:41,156 - DEBUG - There are no more tasks to run at this time
2024-10-21 00:20:41,156 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 00:20:41,156 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 00:20:41,156 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 00:20:41,156 - INFO - Worker Worker(salt=2058216820, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=335263) was stopped. Shutting down Keep-Alive thread
2024-10-21 00:20:41,158 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 00:26:22,243 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 00:26:22,389 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 00:26:23,171 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 00:26:23,198 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 00:26:23,488 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 00:26:23,494 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 00:26:24,486 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 00:26:25,669 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 00:26:26,227 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 00:26:26,937 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 00:26:26,937 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 00:26:26,939 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 00:26:26,960 - INFO - [pid 338989] Worker Worker(salt=4074199793, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=338989) done      Extract()
2024-10-21 00:26:26,961 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:26:26,963 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 00:26:26,963 - DEBUG - Asking scheduler for work...
2024-10-21 00:26:26,965 - DEBUG - Pending tasks: 2
2024-10-21 00:26:26,966 - INFO - [pid 338989] Worker Worker(salt=4074199793, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=338989) running   Load()
2024-10-21 00:26:26,970 - INFO - Read Load Query - SUCCESS
2024-10-21 00:26:28,223 - INFO - Read Extracted Data - SUCCESS
2024-10-21 00:26:28,225 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:26:28,612 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 00:26:28,612 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 00:26:50,891 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 00:27:01,506 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 00:27:01,515 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 00:27:01,561 - INFO - [pid 338989] Worker Worker(salt=4074199793, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=338989) done      Load()
2024-10-21 00:27:01,562 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:27:01,565 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 00:27:01,565 - DEBUG - Asking scheduler for work...
2024-10-21 00:27:01,566 - DEBUG - Pending tasks: 1
2024-10-21 00:27:01,567 - INFO - [pid 338989] Worker Worker(salt=4074199793, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=338989) running   Transform()
2024-10-21 00:27:01,568 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:27:01,571 - INFO - Read Transform Query - SUCCESS
2024-10-21 00:27:01,571 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 00:27:01,737 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 00:27:03,229 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 00:27:03,423 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 00:27:03,466 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 00:27:03,476 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 00:27:03,480 - ERROR - Transform Tables - FAILED
2024-10-21 00:27:03,480 - ERROR - [pid 338989] Worker Worker(salt=4074199793, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=338989) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.InvalidColumnReference: there is no unique or exclusion constraint matching the ON CONFLICT specification


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.InvalidColumnReference) there is no unique or exclusion constraint matching the ON CONFLICT specification

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_freight AS (
        SELECT 
            order_id,
            SUM(freight_value) AS total_freight
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_orders AS (
        SELECT
            oi.id AS order_id,
            o.order_id AS dd_order_id,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ctq.total_quantity AS total_quantity,
            ctp.total_price AS total_price,
            ctf.total_freight AS total_freight,
            (ctp.total_price + ctf.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_price ctp ON oi.order_id = ctp.order_id
        JOIN
            cnt_total_freight ctf ON oi.order_id = ctf.order_id 
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM final_fct_orders
 
ON CONFLICT (order_id, dd_order_id)
DO UPDATE SET
    -- dd_order_id = EXCLUDED.dd_order_id,
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    order_status_id = EXCLUDED.order_status_id,
    order_date = EXCLUDED.order_date,
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_orders.dd_order_id <> EXCLUDED.dd_order_id
                        final.fct_orders.product_id <> EXCLUDED.product_id
                        OR final.fct_orders.customer_id <> EXCLUDED.customer_id
                        OR final.fct_orders.seller_id <> EXCLUDED.seller_id
                        OR final.fct_orders.order_status_id <> EXCLUDED.order_status_id
                        OR final.fct_orders.order_date <> EXCLUDED.order_date
                        OR final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 00:27:03,488 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:27:03,494 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 00:27:03,494 - DEBUG - Asking scheduler for work...
2024-10-21 00:27:03,496 - DEBUG - Done
2024-10-21 00:27:03,496 - DEBUG - There are no more tasks to run at this time
2024-10-21 00:27:03,497 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 00:27:03,497 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 00:27:03,497 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 00:27:03,497 - INFO - Worker Worker(salt=4074199793, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=338989) was stopped. Shutting down Keep-Alive thread
2024-10-21 00:27:03,498 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 00:28:01,835 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 00:28:01,953 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 00:28:02,603 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 00:28:02,643 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 00:28:02,956 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 00:28:02,964 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 00:28:03,794 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 00:28:04,770 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 00:28:05,375 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 00:28:06,176 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 00:28:06,176 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 00:28:06,178 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 00:28:06,195 - INFO - [pid 340091] Worker Worker(salt=6981175029, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=340091) done      Extract()
2024-10-21 00:28:06,196 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:28:06,200 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 00:28:06,200 - DEBUG - Asking scheduler for work...
2024-10-21 00:28:06,201 - DEBUG - Pending tasks: 2
2024-10-21 00:28:06,201 - INFO - [pid 340091] Worker Worker(salt=6981175029, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=340091) running   Load()
2024-10-21 00:28:06,206 - INFO - Read Load Query - SUCCESS
2024-10-21 00:28:07,406 - INFO - Read Extracted Data - SUCCESS
2024-10-21 00:28:07,407 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:28:07,722 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 00:28:07,722 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 00:28:28,259 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 00:28:38,429 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 00:28:38,432 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 00:28:38,475 - INFO - [pid 340091] Worker Worker(salt=6981175029, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=340091) done      Load()
2024-10-21 00:28:38,475 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:28:38,478 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 00:28:38,478 - DEBUG - Asking scheduler for work...
2024-10-21 00:28:38,479 - DEBUG - Pending tasks: 1
2024-10-21 00:28:38,479 - INFO - [pid 340091] Worker Worker(salt=6981175029, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=340091) running   Transform()
2024-10-21 00:28:38,480 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:28:38,484 - INFO - Read Transform Query - SUCCESS
2024-10-21 00:28:38,485 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 00:28:38,651 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 00:28:39,980 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 00:28:40,254 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 00:28:40,299 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 00:28:47,174 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 00:28:47,177 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 00:28:47,178 - ERROR - Transform Tables - FAILED
2024-10-21 00:28:47,178 - ERROR - [pid 340091] Worker Worker(salt=6981175029, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=340091) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: syntax error at or near "final_fct_daily_orders"
LINE 64:     final_fct_daily_orders AS (
             ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) syntax error at or near "final_fct_daily_orders"
LINE 64:     final_fct_daily_orders AS (
             ^

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),
    
    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    cnt_total_order AS (
        SELECT 
            order_id,
            COUNT(DISTINCT order_id) AS total_order
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_amount AS (
        SELECT
            order_id,
            (SUM(price) + SUM(freight_value)) AS total_amount
        FROM stg_order_items
        GROUP BY 1
    )

    final_fct_daily_orders AS (
        SELECT
            dd.date_actual AS order_date,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            cto.total_order AS total_order,
            ctq.total_quantity AS total_quantity,
            cta.total_amount AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_order cto ON oi.order_id = cto.order_id
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_amount cta ON oi.order_id = cta.order_id
    )

INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT * FROM final_fct_daily_orders

ON CONFLICT(order_date)
DO UPDATE SET
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 00:28:47,188 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:28:47,193 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 00:28:47,193 - DEBUG - Asking scheduler for work...
2024-10-21 00:28:47,195 - DEBUG - Done
2024-10-21 00:28:47,195 - DEBUG - There are no more tasks to run at this time
2024-10-21 00:28:47,195 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 00:28:47,195 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 00:28:47,195 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 00:28:47,195 - INFO - Worker Worker(salt=6981175029, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=340091) was stopped. Shutting down Keep-Alive thread
2024-10-21 00:28:47,197 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 00:30:18,396 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 00:30:18,507 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 00:30:18,967 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 00:30:18,989 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 00:30:19,260 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 00:30:19,269 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 00:30:20,050 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 00:30:21,049 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 00:30:21,643 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 00:30:22,342 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 00:30:22,342 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 00:30:22,343 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 00:30:22,363 - INFO - [pid 341631] Worker Worker(salt=9719197378, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=341631) done      Extract()
2024-10-21 00:30:22,364 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:30:22,368 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 00:30:22,368 - DEBUG - Asking scheduler for work...
2024-10-21 00:30:22,370 - DEBUG - Pending tasks: 2
2024-10-21 00:30:22,370 - INFO - [pid 341631] Worker Worker(salt=9719197378, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=341631) running   Load()
2024-10-21 00:30:22,376 - INFO - Read Load Query - SUCCESS
2024-10-21 00:30:23,729 - INFO - Read Extracted Data - SUCCESS
2024-10-21 00:30:23,730 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:30:24,117 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 00:30:24,117 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 00:30:44,340 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 00:30:55,878 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 00:30:55,885 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 00:30:55,920 - INFO - [pid 341631] Worker Worker(salt=9719197378, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=341631) done      Load()
2024-10-21 00:30:55,920 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:30:55,922 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 00:30:55,922 - DEBUG - Asking scheduler for work...
2024-10-21 00:30:55,924 - DEBUG - Pending tasks: 1
2024-10-21 00:30:55,924 - INFO - [pid 341631] Worker Worker(salt=9719197378, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=341631) running   Transform()
2024-10-21 00:30:55,925 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:30:55,928 - INFO - Read Transform Query - SUCCESS
2024-10-21 00:30:55,929 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 00:30:56,115 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 00:30:57,976 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 00:30:58,167 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 00:30:58,205 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 00:31:06,123 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 00:31:06,133 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 00:31:06,135 - ERROR - Transform Tables - FAILED
2024-10-21 00:31:06,135 - ERROR - [pid 341631] Worker Worker(salt=9719197378, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=341631) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.DatatypeMismatch: column "order_date" is of type integer but expression is of type date
LINE 104: SELECT * FROM final_fct_daily_orders
                 ^
HINT:  You will need to rewrite or cast the expression.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.DatatypeMismatch) column "order_date" is of type integer but expression is of type date
LINE 104: SELECT * FROM final_fct_daily_orders
                 ^
HINT:  You will need to rewrite or cast the expression.

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),
    
    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    cnt_total_order AS (
        SELECT 
            order_id,
            COUNT(DISTINCT order_id) AS total_order
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_amount AS (
        SELECT
            order_id,
            (SUM(price) + SUM(freight_value)) AS total_amount
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_daily_orders AS (
        SELECT
            dd.date_actual AS order_date,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            cto.total_order AS total_order,
            ctq.total_quantity AS total_quantity,
            cta.total_amount AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_order cto ON oi.order_id = cto.order_id
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_amount cta ON oi.order_id = cta.order_id
    )

INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT * FROM final_fct_daily_orders

ON CONFLICT(order_date)
DO UPDATE SET
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 00:31:06,152 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:31:06,163 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 00:31:06,163 - DEBUG - Asking scheduler for work...
2024-10-21 00:31:06,165 - DEBUG - Done
2024-10-21 00:31:06,166 - DEBUG - There are no more tasks to run at this time
2024-10-21 00:31:06,166 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 00:31:06,166 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 00:31:06,166 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 00:31:06,166 - INFO - Worker Worker(salt=9719197378, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=341631) was stopped. Shutting down Keep-Alive thread
2024-10-21 00:31:06,168 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 00:44:48,956 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 00:44:49,090 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 00:44:49,686 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 00:44:49,714 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 00:44:50,028 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 00:44:50,033 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 00:44:50,953 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 00:44:52,483 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 00:44:53,126 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 00:44:54,059 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 00:44:54,059 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 00:44:54,065 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 00:44:54,084 - INFO - [pid 349890] Worker Worker(salt=4494453627, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=349890) done      Extract()
2024-10-21 00:44:54,085 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:44:54,087 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 00:44:54,087 - DEBUG - Asking scheduler for work...
2024-10-21 00:44:54,089 - DEBUG - Pending tasks: 2
2024-10-21 00:44:54,089 - INFO - [pid 349890] Worker Worker(salt=4494453627, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=349890) running   Load()
2024-10-21 00:44:54,095 - INFO - Read Load Query - SUCCESS
2024-10-21 00:44:55,624 - INFO - Read Extracted Data - SUCCESS
2024-10-21 00:44:55,625 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:44:56,002 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 00:44:56,002 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 00:45:19,526 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 00:45:31,519 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 00:45:31,526 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 00:45:31,558 - INFO - [pid 349890] Worker Worker(salt=4494453627, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=349890) done      Load()
2024-10-21 00:45:31,558 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:45:31,561 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 00:45:31,561 - DEBUG - Asking scheduler for work...
2024-10-21 00:45:31,562 - DEBUG - Pending tasks: 1
2024-10-21 00:45:31,562 - INFO - [pid 349890] Worker Worker(salt=4494453627, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=349890) running   Transform()
2024-10-21 00:45:31,563 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:45:31,567 - INFO - Read Transform Query - SUCCESS
2024-10-21 00:45:31,568 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 00:45:31,726 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 00:45:33,103 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 00:45:33,326 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 00:45:33,383 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 00:45:40,618 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 00:45:42,011 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 00:45:42,014 - ERROR - Transform Tables - FAILED
2024-10-21 00:45:42,014 - ERROR - [pid 349890] Worker Worker(salt=4494453627, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=349890) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),
    
    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    cnt_total_order AS (
        SELECT 
            order_id,
            COUNT(DISTINCT order_id) AS total_order
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_amount AS (
        SELECT
            order_id,
            (SUM(price) + SUM(freight_value)) AS total_amount
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_daily_orders AS (
        SELECT
            dd.date_id AS order_date,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            cto.total_order AS total_order,
            ctq.total_quantity AS total_quantity,
            cta.total_amount AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_order cto ON oi.order_id = cto.order_id
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_amount cta ON oi.order_id = cta.order_id
    )

INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT * FROM final_fct_daily_orders

ON CONFLICT(order_date)
DO UPDATE SET
    product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 00:45:42,024 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:45:42,030 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 00:45:42,030 - DEBUG - Asking scheduler for work...
2024-10-21 00:45:42,031 - DEBUG - Done
2024-10-21 00:45:42,031 - DEBUG - There are no more tasks to run at this time
2024-10-21 00:45:42,031 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 00:45:42,032 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 00:45:42,032 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 00:45:42,032 - INFO - Worker Worker(salt=4494453627, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=349890) was stopped. Shutting down Keep-Alive thread
2024-10-21 00:45:42,034 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 00:51:50,989 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 00:51:51,097 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 00:51:51,648 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 00:51:51,683 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 00:51:52,003 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 00:51:52,009 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 00:51:52,870 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 00:51:53,906 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 00:51:54,569 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 00:51:55,332 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 00:51:55,332 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 00:51:55,334 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 00:51:55,348 - INFO - [pid 354039] Worker Worker(salt=2084849103, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=354039) done      Extract()
2024-10-21 00:51:55,348 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:51:55,351 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 00:51:55,351 - DEBUG - Asking scheduler for work...
2024-10-21 00:51:55,352 - DEBUG - Pending tasks: 2
2024-10-21 00:51:55,352 - INFO - [pid 354039] Worker Worker(salt=2084849103, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=354039) running   Load()
2024-10-21 00:51:55,358 - INFO - Read Load Query - SUCCESS
2024-10-21 00:51:56,582 - INFO - Read Extracted Data - SUCCESS
2024-10-21 00:51:56,585 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:51:56,935 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 00:51:56,935 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 00:52:17,510 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 00:52:27,587 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 00:52:27,591 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 00:52:27,621 - INFO - [pid 354039] Worker Worker(salt=2084849103, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=354039) done      Load()
2024-10-21 00:52:27,621 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:52:27,623 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 00:52:27,623 - DEBUG - Asking scheduler for work...
2024-10-21 00:52:27,625 - DEBUG - Pending tasks: 1
2024-10-21 00:52:27,625 - INFO - [pid 354039] Worker Worker(salt=2084849103, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=354039) running   Transform()
2024-10-21 00:52:27,626 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:52:27,630 - INFO - Read Transform Query - SUCCESS
2024-10-21 00:52:27,630 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 00:52:27,760 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 00:52:29,028 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 00:52:29,226 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 00:52:29,275 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 00:52:35,915 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 00:52:35,919 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 00:52:35,921 - ERROR - Transform Tables - FAILED
2024-10-21 00:52:35,921 - ERROR - [pid 354039] Worker Worker(salt=2084849103, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=354039) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.InvalidColumnReference: there is no unique or exclusion constraint matching the ON CONFLICT specification


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.InvalidColumnReference) there is no unique or exclusion constraint matching the ON CONFLICT specification

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),
    
    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    cnt_total_order AS (
        SELECT 
            order_id,
            COUNT(DISTINCT order_id) AS total_order
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_amount AS (
        SELECT
            order_id,
            (SUM(price) + SUM(freight_value)) AS total_amount
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_daily_orders AS (
        SELECT
            dd.date_id AS order_date,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            cto.total_order AS total_order,
            ctq.total_quantity AS total_quantity,
            cta.total_amount AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_order cto ON oi.order_id = cto.order_id
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_amount cta ON oi.order_id = cta.order_id
    )

INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT * FROM final_fct_daily_orders

ON CONFLICT(order_date, product_id)
DO UPDATE SET
    -- product_id = EXCLUDED.product_id,
    customer_id = EXCLUDED.customer_id,
    seller_id = EXCLUDED.seller_id,
    total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 00:52:35,930 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:52:35,934 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 00:52:35,934 - DEBUG - Asking scheduler for work...
2024-10-21 00:52:35,936 - DEBUG - Done
2024-10-21 00:52:35,936 - DEBUG - There are no more tasks to run at this time
2024-10-21 00:52:35,936 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 00:52:35,936 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 00:52:35,936 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 00:52:35,936 - INFO - Worker Worker(salt=2084849103, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=354039) was stopped. Shutting down Keep-Alive thread
2024-10-21 00:52:35,938 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 00:59:51,176 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 00:59:51,306 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 00:59:51,896 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 00:59:51,927 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 00:59:52,248 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 00:59:52,257 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 00:59:53,459 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 00:59:54,914 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 00:59:55,523 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 00:59:56,395 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 00:59:56,395 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 00:59:56,400 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 00:59:56,426 - INFO - [pid 358715] Worker Worker(salt=905347972, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=358715) done      Extract()
2024-10-21 00:59:56,429 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 00:59:56,431 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 00:59:56,431 - DEBUG - Asking scheduler for work...
2024-10-21 00:59:56,433 - DEBUG - Pending tasks: 2
2024-10-21 00:59:56,433 - INFO - [pid 358715] Worker Worker(salt=905347972, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=358715) running   Load()
2024-10-21 00:59:56,438 - INFO - Read Load Query - SUCCESS
2024-10-21 00:59:57,914 - INFO - Read Extracted Data - SUCCESS
2024-10-21 00:59:57,915 - INFO - Connect to DWH - SUCCESS
2024-10-21 00:59:58,238 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 00:59:58,239 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 01:00:21,763 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 01:00:33,067 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 01:00:33,077 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 01:00:33,114 - INFO - [pid 358715] Worker Worker(salt=905347972, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=358715) done      Load()
2024-10-21 01:00:33,114 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 01:00:33,116 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 01:00:33,117 - DEBUG - Asking scheduler for work...
2024-10-21 01:00:33,118 - DEBUG - Pending tasks: 1
2024-10-21 01:00:33,118 - INFO - [pid 358715] Worker Worker(salt=905347972, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=358715) running   Transform()
2024-10-21 01:00:33,119 - INFO - Connect to DWH - SUCCESS
2024-10-21 01:00:33,123 - INFO - Read Transform Query - SUCCESS
2024-10-21 01:00:33,123 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 01:00:33,300 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 01:00:34,715 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 01:00:34,934 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 01:00:34,980 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 01:00:42,156 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 01:00:43,816 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 01:00:43,817 - ERROR - Transform Tables - FAILED
2024-10-21 01:00:43,818 - ERROR - [pid 358715] Worker Worker(salt=905347972, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=358715) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),
    
    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    cnt_total_order AS (
        SELECT 
            order_id,
            COUNT(DISTINCT order_id) AS total_order
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_amount AS (
        SELECT
            order_id,
            (SUM(price) + SUM(freight_value)) AS total_amount
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_daily_orders AS (
        SELECT
            dd.date_id AS order_date,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            cto.total_order AS total_order,
            ctq.total_quantity AS total_quantity,
            cta.total_amount AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_order cto ON oi.order_id = cto.order_id
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_amount cta ON oi.order_id = cta.order_id
    )

INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT * FROM final_fct_daily_orders

ON CONFLICT(order_date, product_id, customer_id, seller_id)
DO UPDATE SET
    -- product_id = EXCLUDED.product_id,
    -- customer_id = EXCLUDED.customer_id,
    -- seller_id = EXCLUDED.seller_id,
    -- total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 01:00:43,826 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 01:00:43,831 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 01:00:43,831 - DEBUG - Asking scheduler for work...
2024-10-21 01:00:43,832 - DEBUG - Done
2024-10-21 01:00:43,832 - DEBUG - There are no more tasks to run at this time
2024-10-21 01:00:43,833 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 01:00:43,833 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 01:00:43,833 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 01:00:43,833 - INFO - Worker Worker(salt=905347972, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=358715) was stopped. Shutting down Keep-Alive thread
2024-10-21 01:00:43,835 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 14:51:27,096 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 14:51:27,434 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 14:51:28,459 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 14:51:28,562 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 14:51:29,191 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 14:51:29,203 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 14:51:32,070 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 14:51:36,054 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 14:51:37,584 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 14:51:39,988 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 14:51:39,989 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 14:51:39,997 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 14:51:40,021 - INFO - [pid 15028] Worker Worker(salt=4827247086, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=15028) done      Extract()
2024-10-21 14:51:40,023 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 14:51:40,028 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 14:51:40,028 - DEBUG - Asking scheduler for work...
2024-10-21 14:51:40,030 - DEBUG - Pending tasks: 2
2024-10-21 14:51:40,031 - INFO - [pid 15028] Worker Worker(salt=4827247086, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=15028) running   Load()
2024-10-21 14:51:40,037 - INFO - Read Load Query - SUCCESS
2024-10-21 14:51:42,762 - INFO - Read Extracted Data - SUCCESS
2024-10-21 14:51:42,763 - INFO - Connect to DWH - SUCCESS
2024-10-21 14:51:43,336 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 14:51:43,337 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 14:52:41,081 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 14:53:08,546 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 14:53:08,551 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 14:53:08,627 - INFO - [pid 15028] Worker Worker(salt=4827247086, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=15028) done      Load()
2024-10-21 14:53:08,628 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 14:53:08,635 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 14:53:08,636 - DEBUG - Asking scheduler for work...
2024-10-21 14:53:08,639 - DEBUG - Pending tasks: 1
2024-10-21 14:53:08,640 - INFO - [pid 15028] Worker Worker(salt=4827247086, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=15028) running   Transform()
2024-10-21 14:53:08,642 - INFO - Connect to DWH - SUCCESS
2024-10-21 14:53:08,647 - INFO - Read Transform Query - SUCCESS
2024-10-21 14:53:08,647 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 14:53:08,917 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 14:53:11,686 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 14:53:12,060 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 14:53:12,148 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 14:53:25,137 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 15:01:58,611 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 15:01:58,616 - ERROR - Transform Tables - FAILED
2024-10-21 15:01:58,616 - ERROR - [pid 15028] Worker Worker(salt=4827247086, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=15028) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "pk_fct_daily_orders"
DETAIL:  Key (order_date)=(20160904) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "pk_fct_daily_orders"
DETAIL:  Key (order_date)=(20160904) already exists.

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),
    
    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    cnt_total_order AS (
        SELECT 
            order_id,
            COUNT(DISTINCT order_id) AS total_order
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_amount AS (
        SELECT
            order_id,
            (SUM(price) + SUM(freight_value)) AS total_amount
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_daily_orders AS (
        SELECT
            dd.date_id AS order_date,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            COUNT(DISTINCT cto.total_order) AS total_order,
            SUM(ctq.total_quantity) AS total_quantity,
            SUM(cta.total_amount) AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_order cto ON oi.order_id = cto.order_id
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_amount cta ON oi.order_id = cta.order_id
        
        GROUP BY 
            dd.date_id,
            dp.product_id,
            dc.customer_id,
            ds.seller_id
    )

INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT * FROM final_fct_daily_orders

ON CONFLICT(order_date, product_id, customer_id, seller_id)
DO UPDATE SET
    -- product_id = EXCLUDED.product_id,
    -- customer_id = EXCLUDED.customer_id,
    -- seller_id = EXCLUDED.seller_id,
    -- total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 15:01:58,635 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 15:01:58,652 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 15:01:58,653 - DEBUG - Asking scheduler for work...
2024-10-21 15:01:58,658 - DEBUG - Done
2024-10-21 15:01:58,659 - DEBUG - There are no more tasks to run at this time
2024-10-21 15:01:58,660 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 15:01:58,660 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 15:01:58,661 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 15:01:58,661 - INFO - Worker Worker(salt=4827247086, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=15028) was stopped. Shutting down Keep-Alive thread
2024-10-21 15:01:58,667 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 15:27:05,102 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 15:27:05,549 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 15:27:07,380 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 15:27:07,471 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 15:27:08,233 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 15:27:08,249 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 15:27:10,169 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 15:27:12,957 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 15:27:14,059 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 15:27:15,477 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 15:27:15,477 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 15:27:15,482 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 15:27:15,505 - INFO - [pid 29976] Worker Worker(salt=8340096465, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=29976) done      Extract()
2024-10-21 15:27:15,507 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 15:27:15,511 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 15:27:15,511 - DEBUG - Asking scheduler for work...
2024-10-21 15:27:15,514 - DEBUG - Pending tasks: 2
2024-10-21 15:27:15,515 - INFO - [pid 29976] Worker Worker(salt=8340096465, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=29976) running   Load()
2024-10-21 15:27:15,517 - INFO - Read Load Query - SUCCESS
2024-10-21 15:27:18,217 - INFO - Read Extracted Data - SUCCESS
2024-10-21 15:27:18,219 - INFO - Connect to DWH - SUCCESS
2024-10-21 15:27:18,909 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 15:27:18,909 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 15:28:19,994 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 15:28:49,748 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 15:28:49,753 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 15:28:49,818 - INFO - [pid 29976] Worker Worker(salt=8340096465, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=29976) done      Load()
2024-10-21 15:28:49,819 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 15:28:49,825 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 15:28:49,825 - DEBUG - Asking scheduler for work...
2024-10-21 15:28:49,829 - DEBUG - Pending tasks: 1
2024-10-21 15:28:49,829 - INFO - [pid 29976] Worker Worker(salt=8340096465, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=29976) running   Transform()
2024-10-21 15:28:49,832 - INFO - Connect to DWH - SUCCESS
2024-10-21 15:28:49,838 - INFO - Read Transform Query - SUCCESS
2024-10-21 15:28:49,838 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 15:28:50,114 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 15:28:53,312 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 15:28:53,787 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 15:28:53,883 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 15:29:09,707 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 15:38:14,302 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-21 15:38:14,940 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 15:38:14,943 - ERROR - Transform Tables - FAILED
2024-10-21 15:38:14,943 - ERROR - [pid 29976] Worker Worker(salt=8340096465, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=29976) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 137, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: INSERT INTO final.fct_order_payments(
    payment_id,
    order_id,
    customer_id,
    payment_type_id,
    payment_date,
    payment_sequential,
    payment_installments,
    payment_value
)

SELECT
    op.id as payment_id,
    fo.order_id,
    dc.customer_id,
    pt.payment_type_id,
    dd.date_id AS payment_date,
    op.payment_sequential,
    op.payment_installments,
    op.payment_value

FROM
    stg.orders o
JOIN
    stg.order_payments op ON o.order_id = op.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_payment_types pt ON op.payment_type = pt.payment_type 
JOIN
    final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id

ON CONFLICT(payment_id)
DO UPDATE SET
    order_id = EXCLUDED.order_id,
    customer_id = EXCLUDED.customer_id,
    payment_type_id = EXCLUDED.payment_type_id,
    payment_date = EXCLUDED.payment_date,
    payment_sequential = EXCLUDED.payment_sequential,
    payment_installments = EXCLUDED.payment_installments,
    payment_value = EXCLUDED.payment_value,
    updated_at = CASE WHEN
                        final.fct_order_payments.order_id <> EXCLUDED.order_id
                        OR final.fct_order_payments.customer_id <> EXCLUDED.customer_id
                        OR final.fct_order_payments.payment_type_id <> EXCLUDED.payment_type_id
                        OR final.fct_order_payments.payment_date <> EXCLUDED.payment_date
                        OR final.fct_order_payments.payment_sequential <> EXCLUDED.payment_sequential
                        OR final.fct_order_payments.payment_installments <> EXCLUDED.payment_installments
                        OR final.fct_order_payments.payment_value <> EXCLUDED.payment_value
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_payments.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 15:38:14,955 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 15:38:14,962 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 15:38:14,962 - DEBUG - Asking scheduler for work...
2024-10-21 15:38:14,964 - DEBUG - Done
2024-10-21 15:38:14,964 - DEBUG - There are no more tasks to run at this time
2024-10-21 15:38:14,965 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 15:38:14,965 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 15:38:14,965 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 15:38:14,965 - INFO - Worker Worker(salt=8340096465, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=29976) was stopped. Shutting down Keep-Alive thread
2024-10-21 15:38:14,966 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 16:03:48,684 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 16:03:48,818 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 16:03:49,403 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 16:03:49,433 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 16:03:49,717 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 16:03:49,723 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 16:03:50,664 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 16:03:51,730 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 16:03:52,340 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 16:03:53,151 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 16:03:53,151 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 16:03:53,154 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 16:03:53,167 - INFO - [pid 45819] Worker Worker(salt=8795291025, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45819) done      Extract()
2024-10-21 16:03:53,167 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:03:53,170 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 16:03:53,170 - DEBUG - Asking scheduler for work...
2024-10-21 16:03:53,171 - DEBUG - Pending tasks: 2
2024-10-21 16:03:53,171 - INFO - [pid 45819] Worker Worker(salt=8795291025, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45819) running   Load()
2024-10-21 16:03:53,172 - INFO - Read Load Query - SUCCESS
2024-10-21 16:03:54,245 - INFO - Read Extracted Data - SUCCESS
2024-10-21 16:03:54,247 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:03:54,609 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 16:03:54,610 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 16:04:16,995 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 16:04:31,522 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 16:04:31,524 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 16:04:31,554 - INFO - [pid 45819] Worker Worker(salt=8795291025, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45819) done      Load()
2024-10-21 16:04:31,554 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:04:31,557 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 16:04:31,558 - DEBUG - Asking scheduler for work...
2024-10-21 16:04:31,559 - DEBUG - Pending tasks: 1
2024-10-21 16:04:31,559 - INFO - [pid 45819] Worker Worker(salt=8795291025, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45819) running   Transform()
2024-10-21 16:04:31,560 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:04:31,561 - INFO - Read Transform Query - SUCCESS
2024-10-21 16:04:31,561 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 16:04:31,735 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 16:04:33,611 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 16:04:33,822 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 16:04:33,858 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 16:04:42,372 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 16:09:47,700 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-21 16:09:48,005 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 16:09:48,009 - ERROR - Transform Tables - FAILED
2024-10-21 16:09:48,009 - ERROR - [pid 45819] Worker Worker(salt=8795291025, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45819) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "fct_order_payments_unique"
DETAIL:  Key (payment_id)=(5cf6914e-8404-4756-bccf-75222334d43a) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 137, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "fct_order_payments_unique"
DETAIL:  Key (payment_id)=(5cf6914e-8404-4756-bccf-75222334d43a) already exists.

[SQL: INSERT INTO final.fct_order_payments(
    payment_id,
    order_id,
    customer_id,
    payment_type_id,
    payment_date,
    payment_sequential,
    payment_installments,
    payment_value
)

SELECT
    op.id as payment_id,
    fo.order_id,
    dc.customer_id,
    pt.payment_type_id,
    dd.date_id AS payment_date,
    op.payment_sequential,
    op.payment_installments,
    op.payment_value

FROM
    stg.orders o
JOIN
    stg.order_payments op ON o.order_id = op.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_payment_types pt ON op.payment_type = pt.payment_type 
JOIN
    final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id

ON CONFLICT(payment_id, order_id, customer_id, payment_type_id, payment_date)
DO UPDATE SET
    -- order_id = EXCLUDED.order_id,
    -- customer_id = EXCLUDED.customer_id,
    -- payment_type_id = EXCLUDED.payment_type_id,
    -- payment_date = EXCLUDED.payment_date,
    payment_sequential = EXCLUDED.payment_sequential,
    payment_installments = EXCLUDED.payment_installments,
    payment_value = EXCLUDED.payment_value,
    updated_at = CASE WHEN
                        -- final.fct_order_payments.order_id <> EXCLUDED.order_id
                        -- OR final.fct_order_payments.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_order_payments.payment_type_id <> EXCLUDED.payment_type_id
                        -- OR final.fct_order_payments.payment_date <> EXCLUDED.payment_date
                        final.fct_order_payments.payment_sequential <> EXCLUDED.payment_sequential
                        OR final.fct_order_payments.payment_installments <> EXCLUDED.payment_installments
                        OR final.fct_order_payments.payment_value <> EXCLUDED.payment_value
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_payments.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 16:09:48,023 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:09:48,028 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 16:09:48,028 - DEBUG - Asking scheduler for work...
2024-10-21 16:09:48,031 - DEBUG - Done
2024-10-21 16:09:48,031 - DEBUG - There are no more tasks to run at this time
2024-10-21 16:09:48,031 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 16:09:48,031 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 16:09:48,031 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 16:09:48,031 - INFO - Worker Worker(salt=8795291025, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45819) was stopped. Shutting down Keep-Alive thread
2024-10-21 16:09:48,032 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 16:12:55,048 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 16:12:55,173 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 16:12:55,771 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 16:12:55,818 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 16:12:56,153 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 16:12:56,162 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 16:12:57,046 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 16:12:58,103 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 16:12:58,788 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 16:12:59,579 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 16:12:59,579 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 16:12:59,581 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 16:12:59,593 - INFO - [pid 50425] Worker Worker(salt=7725947297, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=50425) done      Extract()
2024-10-21 16:12:59,593 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:12:59,596 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 16:12:59,596 - DEBUG - Asking scheduler for work...
2024-10-21 16:12:59,597 - DEBUG - Pending tasks: 2
2024-10-21 16:12:59,597 - INFO - [pid 50425] Worker Worker(salt=7725947297, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=50425) running   Load()
2024-10-21 16:12:59,598 - INFO - Read Load Query - SUCCESS
2024-10-21 16:13:00,804 - INFO - Read Extracted Data - SUCCESS
2024-10-21 16:13:00,805 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:13:01,162 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 16:13:01,163 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 16:13:21,701 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 16:13:31,730 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 16:13:31,732 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 16:13:31,760 - INFO - [pid 50425] Worker Worker(salt=7725947297, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=50425) done      Load()
2024-10-21 16:13:31,761 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:13:31,763 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 16:13:31,763 - DEBUG - Asking scheduler for work...
2024-10-21 16:13:31,764 - DEBUG - Pending tasks: 1
2024-10-21 16:13:31,764 - INFO - [pid 50425] Worker Worker(salt=7725947297, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=50425) running   Transform()
2024-10-21 16:13:31,765 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:13:31,766 - INFO - Read Transform Query - SUCCESS
2024-10-21 16:13:31,766 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 16:13:31,898 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 16:13:33,225 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 16:13:33,481 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 16:13:33,520 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 16:13:40,795 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 16:18:45,305 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-21 16:18:45,600 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 16:18:45,602 - ERROR - Transform Tables - FAILED
2024-10-21 16:18:45,602 - ERROR - [pid 50425] Worker Worker(salt=7725947297, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=50425) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "idx_unique_fct_order_payments"
DETAIL:  Key (order_id, customer_id, payment_date)=(706dc535-a9b9-421a-8f40-a3e71f24c4c4, 04edc395-f5cd-4a31-92ed-7abe9db436e5, 20171212) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 137, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "idx_unique_fct_order_payments"
DETAIL:  Key (order_id, customer_id, payment_date)=(706dc535-a9b9-421a-8f40-a3e71f24c4c4, 04edc395-f5cd-4a31-92ed-7abe9db436e5, 20171212) already exists.

[SQL: INSERT INTO final.fct_order_payments(
    payment_id,
    order_id,
    customer_id,
    payment_type_id,
    payment_date,
    payment_sequential,
    payment_installments,
    payment_value
)

SELECT
    op.id as payment_id,
    fo.order_id,
    dc.customer_id,
    pt.payment_type_id,
    dd.date_id AS payment_date,
    op.payment_sequential,
    op.payment_installments,
    op.payment_value

FROM
    stg.orders o
JOIN
    stg.order_payments op ON o.order_id = op.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_payment_types pt ON op.payment_type = pt.payment_type 
JOIN
    final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id

ON CONFLICT(payment_id, order_id, customer_id, payment_type_id, payment_date)
DO UPDATE SET
    -- order_id = EXCLUDED.order_id,
    -- customer_id = EXCLUDED.customer_id,
    -- payment_type_id = EXCLUDED.payment_type_id,
    -- payment_date = EXCLUDED.payment_date,
    payment_sequential = EXCLUDED.payment_sequential,
    payment_installments = EXCLUDED.payment_installments,
    payment_value = EXCLUDED.payment_value,
    updated_at = CASE WHEN
                        -- final.fct_order_payments.order_id <> EXCLUDED.order_id
                        -- OR final.fct_order_payments.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_order_payments.payment_type_id <> EXCLUDED.payment_type_id
                        -- OR final.fct_order_payments.payment_date <> EXCLUDED.payment_date
                        final.fct_order_payments.payment_sequential <> EXCLUDED.payment_sequential
                        OR final.fct_order_payments.payment_installments <> EXCLUDED.payment_installments
                        OR final.fct_order_payments.payment_value <> EXCLUDED.payment_value
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_payments.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 16:18:45,608 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:18:45,613 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 16:18:45,613 - DEBUG - Asking scheduler for work...
2024-10-21 16:18:45,614 - DEBUG - Done
2024-10-21 16:18:45,614 - DEBUG - There are no more tasks to run at this time
2024-10-21 16:18:45,615 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 16:18:45,615 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 16:18:45,615 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 16:18:45,615 - INFO - Worker Worker(salt=7725947297, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=50425) was stopped. Shutting down Keep-Alive thread
2024-10-21 16:18:45,616 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 16:20:33,896 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 16:20:33,989 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 16:20:34,423 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 16:20:34,445 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 16:20:34,700 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 16:20:34,705 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 16:20:35,474 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 16:20:36,386 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 16:20:36,866 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 16:20:37,442 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 16:20:37,442 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 16:20:37,443 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 16:20:37,458 - INFO - [pid 54544] Worker Worker(salt=1880846754, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54544) done      Extract()
2024-10-21 16:20:37,459 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:20:37,461 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 16:20:37,461 - DEBUG - Asking scheduler for work...
2024-10-21 16:20:37,463 - DEBUG - Pending tasks: 2
2024-10-21 16:20:37,464 - INFO - [pid 54544] Worker Worker(salt=1880846754, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54544) running   Load()
2024-10-21 16:20:37,464 - INFO - Read Load Query - SUCCESS
2024-10-21 16:20:38,453 - INFO - Read Extracted Data - SUCCESS
2024-10-21 16:20:38,454 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:20:38,749 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 16:20:38,749 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 16:20:58,964 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 16:21:08,262 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 16:21:08,264 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 16:21:08,293 - INFO - [pid 54544] Worker Worker(salt=1880846754, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54544) done      Load()
2024-10-21 16:21:08,294 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:21:08,296 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 16:21:08,296 - DEBUG - Asking scheduler for work...
2024-10-21 16:21:08,297 - DEBUG - Pending tasks: 1
2024-10-21 16:21:08,298 - INFO - [pid 54544] Worker Worker(salt=1880846754, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54544) running   Transform()
2024-10-21 16:21:08,298 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:21:08,299 - INFO - Read Transform Query - SUCCESS
2024-10-21 16:21:08,299 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 16:21:08,404 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 16:21:09,521 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 16:21:09,693 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 16:21:09,739 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 16:21:16,635 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 16:26:22,831 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-21 16:26:23,124 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 16:26:23,126 - ERROR - Transform Tables - FAILED
2024-10-21 16:26:23,126 - ERROR - [pid 54544] Worker Worker(salt=1880846754, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54544) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "idx_unique_fct_order_payments"
DETAIL:  Key (order_id, customer_id, payment_date)=(2f5be41d-d95d-4617-8884-519255144ca7, 71f3fa8e-b598-4b33-bfc2-27b323a57a2e, 20180127) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 137, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "idx_unique_fct_order_payments"
DETAIL:  Key (order_id, customer_id, payment_date)=(2f5be41d-d95d-4617-8884-519255144ca7, 71f3fa8e-b598-4b33-bfc2-27b323a57a2e, 20180127) already exists.

[SQL: INSERT INTO final.fct_order_payments(
    payment_id,
    order_id,
    customer_id,
    payment_type_id,
    payment_date,
    payment_sequential,
    payment_installments,
    payment_value
)

SELECT
    op.id as payment_id,
    fo.order_id,
    dc.customer_id,
    pt.payment_type_id,
    dd.date_id AS payment_date,
    op.payment_sequential,
    op.payment_installments,
    op.payment_value

FROM
    stg.orders o
JOIN
    stg.order_payments op ON o.order_id = op.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_payment_types pt ON op.payment_type = pt.payment_type 
JOIN
    final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id

ON CONFLICT(payment_id, order_id, customer_id, payment_type_id, payment_date)
DO UPDATE SET
    -- order_id = EXCLUDED.order_id,
    -- customer_id = EXCLUDED.customer_id,
    -- payment_type_id = EXCLUDED.payment_type_id,
    -- payment_date = EXCLUDED.payment_date,
    payment_sequential = EXCLUDED.payment_sequential,
    payment_installments = EXCLUDED.payment_installments,
    payment_value = EXCLUDED.payment_value,
    updated_at = CASE WHEN
                        -- final.fct_order_payments.order_id <> EXCLUDED.order_id
                        -- OR final.fct_order_payments.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_order_payments.payment_type_id <> EXCLUDED.payment_type_id
                        -- OR final.fct_order_payments.payment_date <> EXCLUDED.payment_date
                        final.fct_order_payments.payment_sequential <> EXCLUDED.payment_sequential
                        OR final.fct_order_payments.payment_installments <> EXCLUDED.payment_installments
                        OR final.fct_order_payments.payment_value <> EXCLUDED.payment_value
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_payments.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 16:26:23,129 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:26:23,134 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 16:26:23,134 - DEBUG - Asking scheduler for work...
2024-10-21 16:26:23,135 - DEBUG - Done
2024-10-21 16:26:23,136 - DEBUG - There are no more tasks to run at this time
2024-10-21 16:26:23,136 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 16:26:23,136 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 16:26:23,136 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 16:26:23,136 - INFO - Worker Worker(salt=1880846754, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54544) was stopped. Shutting down Keep-Alive thread
2024-10-21 16:26:23,138 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 16:30:11,825 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 16:30:11,958 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 16:30:12,495 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 16:30:12,522 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 16:30:12,813 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 16:30:12,821 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 16:30:13,736 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 16:30:14,855 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 16:30:15,463 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 16:30:16,311 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 16:30:16,312 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 16:30:16,313 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 16:30:16,326 - INFO - [pid 59473] Worker Worker(salt=4271845523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=59473) done      Extract()
2024-10-21 16:30:16,327 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:30:16,329 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 16:30:16,329 - DEBUG - Asking scheduler for work...
2024-10-21 16:30:16,330 - DEBUG - Pending tasks: 2
2024-10-21 16:30:16,330 - INFO - [pid 59473] Worker Worker(salt=4271845523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=59473) running   Load()
2024-10-21 16:30:16,334 - INFO - Read Load Query - SUCCESS
2024-10-21 16:30:17,397 - INFO - Read Extracted Data - SUCCESS
2024-10-21 16:30:17,398 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:30:17,830 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 16:30:17,831 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 16:30:39,217 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 16:30:50,844 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 16:30:50,846 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 16:30:50,885 - INFO - [pid 59473] Worker Worker(salt=4271845523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=59473) done      Load()
2024-10-21 16:30:50,886 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:30:50,889 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 16:30:50,889 - DEBUG - Asking scheduler for work...
2024-10-21 16:30:50,891 - DEBUG - Pending tasks: 1
2024-10-21 16:30:50,891 - INFO - [pid 59473] Worker Worker(salt=4271845523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=59473) running   Transform()
2024-10-21 16:30:50,892 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:30:50,893 - INFO - Read Transform Query - SUCCESS
2024-10-21 16:30:50,893 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 16:30:51,053 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 16:30:52,680 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 16:30:52,943 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 16:30:52,980 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 16:31:00,886 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 16:36:04,870 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-21 16:36:05,176 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 16:36:05,179 - ERROR - Transform Tables - FAILED
2024-10-21 16:36:05,179 - ERROR - [pid 59473] Worker Worker(salt=4271845523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=59473) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "idx_unique_fct_order_payments"
DETAIL:  Key (order_id, customer_id, payment_date)=(706dc535-a9b9-421a-8f40-a3e71f24c4c4, 04edc395-f5cd-4a31-92ed-7abe9db436e5, 20171212) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 137, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "idx_unique_fct_order_payments"
DETAIL:  Key (order_id, customer_id, payment_date)=(706dc535-a9b9-421a-8f40-a3e71f24c4c4, 04edc395-f5cd-4a31-92ed-7abe9db436e5, 20171212) already exists.

[SQL: INSERT INTO final.fct_order_payments(
    payment_id,
    order_id,
    customer_id,
    payment_type_id,
    payment_date,
    payment_sequential,
    payment_installments,
    payment_value
)

SELECT
    op.id as payment_id,
    fo.order_id,
    dc.customer_id,
    pt.payment_type_id,
    dd.date_id AS payment_date,
    op.payment_sequential,
    op.payment_installments,
    op.payment_value

FROM
    stg.orders o
JOIN
    stg.order_payments op ON o.order_id = op.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_payment_types pt ON op.payment_type = pt.payment_type 
JOIN
    final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id

ON CONFLICT(payment_id, order_id, customer_id, payment_type_id, payment_date)
DO UPDATE SET
    -- order_id = EXCLUDED.order_id,
    -- customer_id = EXCLUDED.customer_id,
    -- payment_type_id = EXCLUDED.payment_type_id,
    -- payment_date = EXCLUDED.payment_date,
    payment_sequential = EXCLUDED.payment_sequential,
    payment_installments = EXCLUDED.payment_installments,
    payment_value = EXCLUDED.payment_value,
    updated_at = CASE WHEN
                        -- final.fct_order_payments.order_id <> EXCLUDED.order_id
                        -- OR final.fct_order_payments.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_order_payments.payment_type_id <> EXCLUDED.payment_type_id
                        -- OR final.fct_order_payments.payment_date <> EXCLUDED.payment_date
                        final.fct_order_payments.payment_sequential <> EXCLUDED.payment_sequential
                        OR final.fct_order_payments.payment_installments <> EXCLUDED.payment_installments
                        OR final.fct_order_payments.payment_value <> EXCLUDED.payment_value
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_payments.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 16:36:05,188 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:36:05,194 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 16:36:05,194 - DEBUG - Asking scheduler for work...
2024-10-21 16:36:05,196 - DEBUG - Done
2024-10-21 16:36:05,196 - DEBUG - There are no more tasks to run at this time
2024-10-21 16:36:05,196 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 16:36:05,196 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 16:36:05,196 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 16:36:05,196 - INFO - Worker Worker(salt=4271845523, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=59473) was stopped. Shutting down Keep-Alive thread
2024-10-21 16:36:05,198 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 16:44:03,205 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 16:44:03,378 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 16:44:04,063 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 16:44:04,092 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 16:44:04,419 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 16:44:04,426 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 16:44:05,464 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 16:44:06,688 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 16:44:07,414 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 16:44:08,362 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 16:44:08,362 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 16:44:08,363 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 16:44:08,377 - INFO - [pid 66207] Worker Worker(salt=4894688888, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=66207) done      Extract()
2024-10-21 16:44:08,379 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:44:08,382 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 16:44:08,382 - DEBUG - Asking scheduler for work...
2024-10-21 16:44:08,383 - DEBUG - Pending tasks: 2
2024-10-21 16:44:08,383 - INFO - [pid 66207] Worker Worker(salt=4894688888, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=66207) running   Load()
2024-10-21 16:44:08,385 - INFO - Read Load Query - SUCCESS
2024-10-21 16:44:09,651 - INFO - Read Extracted Data - SUCCESS
2024-10-21 16:44:09,652 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:44:10,344 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 16:44:10,344 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 16:44:44,292 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 16:45:16,495 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 16:45:16,500 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 16:45:16,598 - INFO - [pid 66207] Worker Worker(salt=4894688888, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=66207) done      Load()
2024-10-21 16:45:16,599 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:45:16,602 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 16:45:16,602 - DEBUG - Asking scheduler for work...
2024-10-21 16:45:16,604 - DEBUG - Pending tasks: 1
2024-10-21 16:45:16,605 - INFO - [pid 66207] Worker Worker(salt=4894688888, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=66207) running   Transform()
2024-10-21 16:45:16,607 - INFO - Connect to DWH - SUCCESS
2024-10-21 16:45:16,609 - INFO - Read Transform Query - SUCCESS
2024-10-21 16:45:16,609 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 16:45:16,816 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 16:45:19,422 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 16:45:19,805 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 16:45:19,864 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 16:45:31,722 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 16:50:47,911 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-21 16:50:48,649 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 16:50:48,699 - ERROR - Transform Tables - FAILED
2024-10-21 16:50:48,701 - ERROR - [pid 66207] Worker Worker(salt=4894688888, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=66207) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "idx_unique_fct_order_payments"
DETAIL:  Key (order_id, customer_id, payment_type_id, payment_date)=(016da93e-dcfb-4828-93ce-1e6605cd6546, 1dc38fb4-0368-4f81-8e39-ecfda3f103d3, dcd9991c-ff54-4505-b66e-a29e588625c0, 20170311) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 137, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "idx_unique_fct_order_payments"
DETAIL:  Key (order_id, customer_id, payment_type_id, payment_date)=(016da93e-dcfb-4828-93ce-1e6605cd6546, 1dc38fb4-0368-4f81-8e39-ecfda3f103d3, dcd9991c-ff54-4505-b66e-a29e588625c0, 20170311) already exists.

[SQL: INSERT INTO final.fct_order_payments(
    payment_id,
    order_id,
    customer_id,
    payment_type_id,
    payment_date,
    payment_sequential,
    payment_installments,
    payment_value
)

SELECT
    op.id as payment_id,
    fo.order_id,
    dc.customer_id,
    pt.payment_type_id,
    dd.date_id AS payment_date,
    op.payment_sequential,
    op.payment_installments,
    op.payment_value

FROM
    stg.orders o
JOIN
    stg.order_payments op ON o.order_id = op.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_payment_types pt ON op.payment_type = pt.payment_type 
JOIN
    final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id

ON CONFLICT(payment_id, order_id, customer_id, payment_type_id, payment_date)
DO UPDATE SET
    -- order_id = EXCLUDED.order_id,
    -- customer_id = EXCLUDED.customer_id,
    -- payment_type_id = EXCLUDED.payment_type_id,
    -- payment_date = EXCLUDED.payment_date,
    payment_sequential = EXCLUDED.payment_sequential,
    payment_installments = EXCLUDED.payment_installments,
    payment_value = EXCLUDED.payment_value,
    updated_at = CASE WHEN
                        -- final.fct_order_payments.order_id <> EXCLUDED.order_id
                        -- OR final.fct_order_payments.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_order_payments.payment_type_id <> EXCLUDED.payment_type_id
                        -- OR final.fct_order_payments.payment_date <> EXCLUDED.payment_date
                        final.fct_order_payments.payment_sequential <> EXCLUDED.payment_sequential
                        OR final.fct_order_payments.payment_installments <> EXCLUDED.payment_installments
                        OR final.fct_order_payments.payment_value <> EXCLUDED.payment_value
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_payments.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 16:50:48,762 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 16:50:48,798 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 16:50:48,799 - DEBUG - Asking scheduler for work...
2024-10-21 16:50:48,802 - DEBUG - Done
2024-10-21 16:50:48,803 - DEBUG - There are no more tasks to run at this time
2024-10-21 16:50:48,803 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 16:50:48,803 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 16:50:48,804 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 16:50:48,804 - INFO - Worker Worker(salt=4894688888, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=66207) was stopped. Shutting down Keep-Alive thread
2024-10-21 16:50:48,814 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 18:00:37,325 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 18:00:37,469 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 18:00:38,056 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 18:00:38,084 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 18:00:38,356 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 18:00:38,362 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 18:00:39,267 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 18:00:40,325 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 18:00:40,938 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 18:00:41,663 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 18:00:41,664 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 18:00:41,671 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 18:00:41,690 - INFO - [pid 98727] Worker Worker(salt=8571284191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=98727) done      Extract()
2024-10-21 18:00:41,693 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 18:00:41,704 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 18:00:41,704 - DEBUG - Asking scheduler for work...
2024-10-21 18:00:41,706 - DEBUG - Pending tasks: 2
2024-10-21 18:00:41,706 - INFO - [pid 98727] Worker Worker(salt=8571284191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=98727) running   Load()
2024-10-21 18:00:41,751 - INFO - Read Load Query - SUCCESS
2024-10-21 18:00:42,809 - INFO - Read Extracted Data - SUCCESS
2024-10-21 18:00:42,810 - INFO - Connect to DWH - SUCCESS
2024-10-21 18:00:43,117 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 18:00:43,117 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 18:01:04,216 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 18:01:17,043 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 18:01:17,045 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 18:01:17,074 - INFO - [pid 98727] Worker Worker(salt=8571284191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=98727) done      Load()
2024-10-21 18:01:17,074 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 18:01:17,077 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 18:01:17,078 - DEBUG - Asking scheduler for work...
2024-10-21 18:01:17,079 - DEBUG - Pending tasks: 1
2024-10-21 18:01:17,079 - INFO - [pid 98727] Worker Worker(salt=8571284191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=98727) running   Transform()
2024-10-21 18:01:17,081 - INFO - Connect to DWH - SUCCESS
2024-10-21 18:01:17,085 - INFO - Read Transform Query - SUCCESS
2024-10-21 18:01:17,085 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 18:01:17,234 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 18:01:18,537 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 18:01:18,723 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 18:01:18,775 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 18:01:25,345 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 18:06:23,694 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-21 18:06:27,553 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-21 18:06:34,326 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-21 18:06:35,015 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-21 18:06:35,022 - ERROR - Transform Tables - FAILED
2024-10-21 18:06:35,022 - ERROR - [pid 98727] Worker Worker(salt=8571284191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=98727) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 147, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: INSERT INTO final.fct_customer_reviews(
    review_id,
    dd_review_id,
    customer_id,
    seller_id,
    product_id,
    review_date,
    review_score
)

SELECT
    rv.id as review_id,
    rv.review_id as dd_review_id,
    dc.customer_id,
    ds.seller_id,
    dp.product_id,
    dd.date_id as review_date,
    rv.review_score

FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    stg.order_reviews rv ON o.order_id = rv.order_id
JOIN
    final.dim_products dp ON oi.product_id = dp.product_nk
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date dd ON TO_DATE(rv.review_creation_date, 'YYYY-MM-DD') = dd.date_actual

ON CONFLICT(review_id, customer_id, seller_id, product_id, review_date)
DO UPDATE SET
    dd_review_id = EXCLUDED.dd_review_id,
    -- customer_id = EXCLUDED.customer_id,
    -- seller_id = EXCLUDED.seller_id,
    -- product_id = EXCLUDED.product_id,
    -- review_date = EXCLUDED.review_date,
    review_score = EXCLUDED.review_score,
    updated_at = CASE WHEN
                        final.fct_customer_reviews.dd_review_id <> EXCLUDED.dd_review_id
                        -- OR final.fct_customer_reviews.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_customer_reviews.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_customer_reviews.product_id <> EXCLUDED.product_id
                        -- OR final.fct_customer_reviews.review_date <> EXCLUDED.review_date
                        OR final.fct_customer_reviews.review_score <> EXCLUDED.review_score
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_customer_reviews.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-21 18:06:35,034 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 18:06:35,039 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-21 18:06:35,039 - DEBUG - Asking scheduler for work...
2024-10-21 18:06:35,041 - DEBUG - Done
2024-10-21 18:06:35,041 - DEBUG - There are no more tasks to run at this time
2024-10-21 18:06:35,041 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-21 18:06:35,041 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-21 18:06:35,041 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-21 18:06:35,042 - INFO - Worker Worker(salt=8571284191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=98727) was stopped. Shutting down Keep-Alive thread
2024-10-21 18:06:35,043 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-21 18:22:15,485 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-21 18:22:15,645 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-21 18:22:16,292 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-21 18:22:16,318 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-21 18:22:16,661 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-21 18:22:16,667 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-21 18:22:17,923 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-21 18:22:19,410 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-21 18:22:20,018 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-21 18:22:20,840 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-21 18:22:20,840 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-21 18:22:20,843 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-21 18:22:20,859 - INFO - [pid 10553] Worker Worker(salt=7954384939, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10553) done      Extract()
2024-10-21 18:22:20,860 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 18:22:20,862 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-21 18:22:20,862 - DEBUG - Asking scheduler for work...
2024-10-21 18:22:20,864 - DEBUG - Pending tasks: 2
2024-10-21 18:22:20,864 - INFO - [pid 10553] Worker Worker(salt=7954384939, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10553) running   Load()
2024-10-21 18:22:20,866 - INFO - Read Load Query - SUCCESS
2024-10-21 18:22:22,285 - INFO - Read Extracted Data - SUCCESS
2024-10-21 18:22:22,286 - INFO - Connect to DWH - SUCCESS
2024-10-21 18:22:22,672 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-21 18:22:22,672 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-21 18:22:45,591 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-21 18:23:00,603 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-21 18:23:00,605 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-21 18:23:00,641 - INFO - [pid 10553] Worker Worker(salt=7954384939, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10553) done      Load()
2024-10-21 18:23:00,641 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 18:23:00,644 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-21 18:23:00,644 - DEBUG - Asking scheduler for work...
2024-10-21 18:23:00,646 - DEBUG - Pending tasks: 1
2024-10-21 18:23:00,646 - INFO - [pid 10553] Worker Worker(salt=7954384939, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10553) running   Transform()
2024-10-21 18:23:00,647 - INFO - Connect to DWH - SUCCESS
2024-10-21 18:23:00,648 - INFO - Read Transform Query - SUCCESS
2024-10-21 18:23:00,648 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-21 18:23:00,790 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-21 18:23:02,305 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-21 18:23:02,673 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-21 18:23:02,723 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-21 18:23:10,498 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-21 18:28:05,746 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-21 18:28:09,736 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-21 18:28:16,724 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-21 18:28:21,017 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-21 18:28:21,024 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-21 18:28:21,030 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-21 18:28:21,030 - INFO - [pid 10553] Worker Worker(salt=7954384939, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10553) done      Transform()
2024-10-21 18:28:21,031 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-21 18:28:21,034 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-21 18:28:21,034 - DEBUG - Asking scheduler for work...
2024-10-21 18:28:21,036 - DEBUG - Done
2024-10-21 18:28:21,036 - DEBUG - There are no more tasks to run at this time
2024-10-21 18:28:21,036 - INFO - Worker Worker(salt=7954384939, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10553) was stopped. Shutting down Keep-Alive thread
2024-10-21 18:28:21,039 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-22 14:45:46,537 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 14:45:46,888 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 14:45:47,799 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 14:45:47,837 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 14:45:48,404 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 14:45:48,412 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 14:45:51,380 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 14:45:56,187 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 14:45:58,595 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 14:46:01,101 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 14:46:01,102 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 14:46:01,108 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 14:46:01,137 - INFO - [pid 21602] Worker Worker(salt=7023801370, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21602) done      Extract()
2024-10-22 14:46:01,142 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 14:46:01,149 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 14:46:01,149 - DEBUG - Asking scheduler for work...
2024-10-22 14:46:01,153 - DEBUG - Pending tasks: 2
2024-10-22 14:46:01,153 - INFO - [pid 21602] Worker Worker(salt=7023801370, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21602) running   Load()
2024-10-22 14:46:01,164 - INFO - Read Load Query - SUCCESS
2024-10-22 14:46:04,812 - INFO - Read Extracted Data - SUCCESS
2024-10-22 14:46:04,814 - INFO - Connect to DWH - SUCCESS
2024-10-22 14:46:05,305 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 14:46:05,306 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 14:47:08,230 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 14:47:41,225 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 14:47:41,230 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 14:47:41,334 - INFO - [pid 21602] Worker Worker(salt=7023801370, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21602) done      Load()
2024-10-22 14:47:41,335 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 14:47:41,340 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 14:47:41,340 - DEBUG - Asking scheduler for work...
2024-10-22 14:47:41,343 - DEBUG - Pending tasks: 1
2024-10-22 14:47:41,344 - INFO - [pid 21602] Worker Worker(salt=7023801370, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21602) running   Transform()
2024-10-22 14:47:41,345 - INFO - Connect to DWH - SUCCESS
2024-10-22 14:47:41,348 - INFO - Read Transform Query - SUCCESS
2024-10-22 14:47:41,348 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 14:47:41,584 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 14:47:43,716 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 14:47:44,082 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 14:47:44,184 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 14:47:47,593 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 14:47:47,595 - ERROR - Transform Tables - FAILED
2024-10-22 14:47:47,595 - ERROR - [pid 21602] Worker Worker(salt=7023801370, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21602) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.CardinalityViolation: ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.CardinalityViolation) ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_freight AS (
        SELECT 
            order_id,
            SUM(freight_value) AS total_freight
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_orders AS (
        SELECT
            o.id AS order_id,
            o.order_id AS dd_order_id,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ctq.total_quantity AS total_quantity,
            ctp.total_price AS total_price,
            ctf.total_freight AS total_freight,
            (ctp.total_price + ctf.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_price ctp ON oi.order_id = ctp.order_id
        JOIN
            cnt_total_freight ctf ON oi.order_id = ctf.order_id 
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM final_fct_orders
 
ON CONFLICT(order_id, dd_order_id, product_id, customer_id, seller_id, order_status_id, order_date)
DO UPDATE SET
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 14:47:47,605 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 14:47:47,612 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 14:47:47,612 - DEBUG - Asking scheduler for work...
2024-10-22 14:47:47,614 - DEBUG - Done
2024-10-22 14:47:47,615 - DEBUG - There are no more tasks to run at this time
2024-10-22 14:47:47,615 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 14:47:47,615 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 14:47:47,615 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 14:47:47,615 - INFO - Worker Worker(salt=7023801370, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21602) was stopped. Shutting down Keep-Alive thread
2024-10-22 14:47:47,617 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 14:52:35,175 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 14:52:35,527 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 14:52:37,201 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 14:52:37,280 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 14:52:38,251 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 14:52:38,261 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 14:52:39,755 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 14:52:41,426 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 14:52:42,339 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 14:52:43,440 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 14:52:43,440 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 14:52:43,443 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 14:52:43,468 - INFO - [pid 24673] Worker Worker(salt=6965295526, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24673) done      Extract()
2024-10-22 14:52:43,472 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 14:52:43,477 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 14:52:43,477 - DEBUG - Asking scheduler for work...
2024-10-22 14:52:43,481 - DEBUG - Pending tasks: 2
2024-10-22 14:52:43,481 - INFO - [pid 24673] Worker Worker(salt=6965295526, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24673) running   Load()
2024-10-22 14:52:43,484 - INFO - Read Load Query - SUCCESS
2024-10-22 14:52:45,443 - INFO - Read Extracted Data - SUCCESS
2024-10-22 14:52:45,445 - INFO - Connect to DWH - SUCCESS
2024-10-22 14:52:46,004 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 14:52:46,005 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 14:53:45,536 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 14:54:12,435 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 14:54:12,438 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 14:54:12,508 - INFO - [pid 24673] Worker Worker(salt=6965295526, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24673) done      Load()
2024-10-22 14:54:12,509 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 14:54:12,516 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 14:54:12,517 - DEBUG - Asking scheduler for work...
2024-10-22 14:54:12,522 - DEBUG - Pending tasks: 1
2024-10-22 14:54:12,523 - INFO - [pid 24673] Worker Worker(salt=6965295526, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24673) running   Transform()
2024-10-22 14:54:12,527 - INFO - Connect to DWH - SUCCESS
2024-10-22 14:54:12,531 - INFO - Read Transform Query - SUCCESS
2024-10-22 14:54:12,531 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 14:54:12,865 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 14:54:15,866 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 14:54:16,393 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 14:54:16,496 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 14:54:20,656 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 14:54:20,658 - ERROR - Transform Tables - FAILED
2024-10-22 14:54:20,658 - ERROR - [pid 24673] Worker Worker(salt=6965295526, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24673) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "pk_fct_orders"
DETAIL:  Key (order_id)=(000a94f1-e242-45b0-8a40-b046dbabef50) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "pk_fct_orders"
DETAIL:  Key (order_id)=(000a94f1-e242-45b0-8a40-b046dbabef50) already exists.

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_freight AS (
        SELECT 
            order_id,
            SUM(freight_value) AS total_freight
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_orders AS (
        SELECT DISTINCT
            o.id AS order_id,
            o.order_id AS dd_order_id,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ctq.total_quantity AS total_quantity,
            ctp.total_price AS total_price,
            ctf.total_freight AS total_freight,
            (ctp.total_price + ctf.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_price ctp ON oi.order_id = ctp.order_id
        JOIN
            cnt_total_freight ctf ON oi.order_id = ctf.order_id 
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT * FROM final_fct_orders
 
ON CONFLICT(order_id, dd_order_id, product_id, customer_id, seller_id, order_status_id, order_date)
DO UPDATE SET
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 14:54:20,669 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 14:54:20,679 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 14:54:20,679 - DEBUG - Asking scheduler for work...
2024-10-22 14:54:20,682 - DEBUG - Done
2024-10-22 14:54:20,682 - DEBUG - There are no more tasks to run at this time
2024-10-22 14:54:20,682 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 14:54:20,682 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 14:54:20,682 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 14:54:20,683 - INFO - Worker Worker(salt=6965295526, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24673) was stopped. Shutting down Keep-Alive thread
2024-10-22 14:54:20,684 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 14:58:06,984 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 14:58:07,410 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 14:58:08,453 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 14:58:08,510 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 14:58:09,260 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 14:58:09,279 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 14:58:10,643 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 14:58:12,363 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 14:58:13,117 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 14:58:14,266 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 14:58:14,266 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 14:58:14,269 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 14:58:14,291 - INFO - [pid 27065] Worker Worker(salt=6654614548, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27065) done      Extract()
2024-10-22 14:58:14,293 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 14:58:14,298 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 14:58:14,298 - DEBUG - Asking scheduler for work...
2024-10-22 14:58:14,302 - DEBUG - Pending tasks: 2
2024-10-22 14:58:14,302 - INFO - [pid 27065] Worker Worker(salt=6654614548, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27065) running   Load()
2024-10-22 14:58:14,303 - INFO - Read Load Query - SUCCESS
2024-10-22 14:58:16,174 - INFO - Read Extracted Data - SUCCESS
2024-10-22 14:58:16,176 - INFO - Connect to DWH - SUCCESS
2024-10-22 14:58:16,779 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 14:58:16,779 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 14:59:12,473 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 14:59:35,518 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 14:59:35,522 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 14:59:35,587 - INFO - [pid 27065] Worker Worker(salt=6654614548, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27065) done      Load()
2024-10-22 14:59:35,588 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 14:59:35,593 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 14:59:35,594 - DEBUG - Asking scheduler for work...
2024-10-22 14:59:35,598 - DEBUG - Pending tasks: 1
2024-10-22 14:59:35,598 - INFO - [pid 27065] Worker Worker(salt=6654614548, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27065) running   Transform()
2024-10-22 14:59:35,601 - INFO - Connect to DWH - SUCCESS
2024-10-22 14:59:35,602 - INFO - Read Transform Query - SUCCESS
2024-10-22 14:59:35,602 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 14:59:35,789 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 14:59:38,305 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 14:59:38,872 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 14:59:38,968 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 14:59:55,715 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 15:10:08,655 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 15:10:08,661 - ERROR - Transform Tables - FAILED
2024-10-22 15:10:08,661 - ERROR - [pid 27065] Worker Worker(salt=6654614548, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27065) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "pk_fct_daily_orders"
DETAIL:  Key (order_date)=(20160904) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 132, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "pk_fct_daily_orders"
DETAIL:  Key (order_date)=(20160904) already exists.

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),
    
    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    cnt_total_order AS (
        SELECT 
            order_id,
            COUNT(DISTINCT order_id) AS total_order
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_quantity AS (
        SELECT 
            order_id,
            COUNT(order_item_id) AS total_quantity
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_price AS (
        SELECT 
            order_id,
            SUM(price) AS total_price
        FROM stg_order_items
        GROUP BY 1
    ),

    cnt_total_amount AS (
        SELECT
            order_id,
            (SUM(price) + SUM(freight_value)) AS total_amount
        FROM stg_order_items
        GROUP BY 1
    ),

    final_fct_daily_orders AS (
        SELECT
            dd.date_id AS order_date,
            dp.product_id,
            dc.customer_id,
            ds.seller_id,
            COUNT(DISTINCT cto.total_order) AS total_order,
            SUM(ctq.total_quantity) AS total_quantity,
            SUM(cta.total_amount) AS total_amount

        FROM
            stg_orders o
        JOIN
            stg_order_items oi ON o.order_id = oi.order_id
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
        JOIN
            cnt_total_order cto ON oi.order_id = cto.order_id
        JOIN
            cnt_total_quantity ctq ON oi.order_id = ctq.order_id
        JOIN
            cnt_total_amount cta ON oi.order_id = cta.order_id
        
        GROUP BY 
            dd.date_id,
            dp.product_id,
            dc.customer_id,
            ds.seller_id
    )

INSERT INTO final.fct_daily_orders(
    order_date,
    product_id,
    customer_id,
    seller_id,
    total_order,
    total_quantity,
    total_amount
)

SELECT * FROM final_fct_daily_orders

ON CONFLICT(order_date, product_id, customer_id, seller_id)
DO UPDATE SET
    -- product_id = EXCLUDED.product_id,
    -- customer_id = EXCLUDED.customer_id,
    -- seller_id = EXCLUDED.seller_id,
    -- total_order = EXCLUDED.total_order,
    total_quantity = EXCLUDED.total_quantity,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        -- final.fct_daily_orders.product_id <> EXCLUDED.product_id
                        -- OR final.fct_daily_orders.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_daily_orders.seller_id <> EXCLUDED.seller_id
                        final.fct_daily_orders.total_order <> EXCLUDED.total_order
                        OR final.fct_daily_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_daily_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_daily_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 15:10:08,684 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:10:08,701 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 15:10:08,701 - DEBUG - Asking scheduler for work...
2024-10-22 15:10:08,707 - DEBUG - Done
2024-10-22 15:10:08,707 - DEBUG - There are no more tasks to run at this time
2024-10-22 15:10:08,708 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 15:10:08,708 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 15:10:08,708 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 15:10:08,709 - INFO - Worker Worker(salt=6654614548, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27065) was stopped. Shutting down Keep-Alive thread
2024-10-22 15:10:08,712 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 15:14:46,643 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 15:14:46,845 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 15:14:48,192 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 15:14:48,244 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 15:14:48,790 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 15:14:48,797 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 15:14:50,262 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 15:14:51,912 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 15:14:53,003 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 15:14:54,202 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 15:14:54,202 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 15:14:54,205 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 15:14:54,229 - INFO - [pid 35051] Worker Worker(salt=4767423615, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=35051) done      Extract()
2024-10-22 15:14:54,232 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:14:54,236 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 15:14:54,237 - DEBUG - Asking scheduler for work...
2024-10-22 15:14:54,240 - DEBUG - Pending tasks: 2
2024-10-22 15:14:54,241 - INFO - [pid 35051] Worker Worker(salt=4767423615, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=35051) running   Load()
2024-10-22 15:14:54,243 - INFO - Read Load Query - SUCCESS
2024-10-22 15:14:56,287 - INFO - Read Extracted Data - SUCCESS
2024-10-22 15:14:56,292 - INFO - Connect to DWH - SUCCESS
2024-10-22 15:14:56,965 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 15:14:56,965 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 15:15:54,491 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 15:16:16,826 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 15:16:16,830 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 15:16:16,882 - INFO - [pid 35051] Worker Worker(salt=4767423615, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=35051) done      Load()
2024-10-22 15:16:16,883 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:16:16,888 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 15:16:16,889 - DEBUG - Asking scheduler for work...
2024-10-22 15:16:16,892 - DEBUG - Pending tasks: 1
2024-10-22 15:16:16,893 - INFO - [pid 35051] Worker Worker(salt=4767423615, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=35051) running   Transform()
2024-10-22 15:16:16,895 - INFO - Connect to DWH - SUCCESS
2024-10-22 15:16:16,896 - INFO - Read Transform Query - SUCCESS
2024-10-22 15:16:16,896 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 15:16:17,180 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 15:16:20,228 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 15:16:20,608 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 15:16:20,670 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 15:16:36,706 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 15:27:29,369 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 15:27:29,991 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 15:27:29,995 - ERROR - Transform Tables - FAILED
2024-10-22 15:27:29,995 - ERROR - [pid 35051] Worker Worker(salt=4767423615, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=35051) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "pk_fct_order_payments"
DETAIL:  Key (payment_id)=(b531deb8-9573-4195-9029-a7702a74bc8a) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 137, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "pk_fct_order_payments"
DETAIL:  Key (payment_id)=(b531deb8-9573-4195-9029-a7702a74bc8a) already exists.

[SQL: INSERT INTO final.fct_order_payments(
    payment_id,
    order_id,
    customer_id,
    payment_type_id,
    payment_date,
    payment_sequential,
    payment_installments,
    payment_value
)

SELECT
    op.id as payment_id,
    fo.order_id,
    dc.customer_id,
    pt.payment_type_id,
    dd.date_id AS payment_date,
    op.payment_sequential,
    op.payment_installments,
    op.payment_value

FROM
    stg.orders o
JOIN
    stg.order_payments op ON o.order_id = op.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_payment_types pt ON op.payment_type = pt.payment_type 
JOIN
    final.dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id

ON CONFLICT(payment_id, order_id, customer_id, payment_type_id, payment_date)
DO UPDATE SET
    -- order_id = EXCLUDED.order_id,
    -- customer_id = EXCLUDED.customer_id,
    -- payment_type_id = EXCLUDED.payment_type_id,
    -- payment_date = EXCLUDED.payment_date,
    payment_sequential = EXCLUDED.payment_sequential,
    payment_installments = EXCLUDED.payment_installments,
    payment_value = EXCLUDED.payment_value,
    updated_at = CASE WHEN
                        -- final.fct_order_payments.order_id <> EXCLUDED.order_id
                        -- OR final.fct_order_payments.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_order_payments.payment_type_id <> EXCLUDED.payment_type_id
                        -- OR final.fct_order_payments.payment_date <> EXCLUDED.payment_date
                        final.fct_order_payments.payment_sequential <> EXCLUDED.payment_sequential
                        OR final.fct_order_payments.payment_installments <> EXCLUDED.payment_installments
                        OR final.fct_order_payments.payment_value <> EXCLUDED.payment_value
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_payments.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 15:27:30,010 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:27:30,019 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 15:27:30,019 - DEBUG - Asking scheduler for work...
2024-10-22 15:27:30,022 - DEBUG - Done
2024-10-22 15:27:30,023 - DEBUG - There are no more tasks to run at this time
2024-10-22 15:27:30,023 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 15:27:30,023 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 15:27:30,023 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 15:27:30,024 - INFO - Worker Worker(salt=4767423615, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=35051) was stopped. Shutting down Keep-Alive thread
2024-10-22 15:27:30,026 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 15:35:23,634 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 15:35:23,847 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 15:35:24,862 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 15:35:24,899 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 15:35:25,417 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 15:35:25,426 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 15:35:27,049 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 15:35:28,909 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 15:35:29,877 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 15:35:31,224 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 15:35:31,224 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 15:35:31,226 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 15:35:31,248 - INFO - [pid 44709] Worker Worker(salt=9957166153, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=44709) done      Extract()
2024-10-22 15:35:31,251 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:35:31,255 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 15:35:31,255 - DEBUG - Asking scheduler for work...
2024-10-22 15:35:31,258 - DEBUG - Pending tasks: 2
2024-10-22 15:35:31,259 - INFO - [pid 44709] Worker Worker(salt=9957166153, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=44709) running   Load()
2024-10-22 15:35:31,261 - INFO - Read Load Query - SUCCESS
2024-10-22 15:35:33,081 - INFO - Read Extracted Data - SUCCESS
2024-10-22 15:35:33,082 - INFO - Connect to DWH - SUCCESS
2024-10-22 15:35:33,624 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 15:35:33,625 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 15:36:21,880 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 15:36:49,520 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 15:36:49,525 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 15:36:49,610 - INFO - [pid 44709] Worker Worker(salt=9957166153, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=44709) done      Load()
2024-10-22 15:36:49,611 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:36:49,619 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 15:36:49,621 - DEBUG - Asking scheduler for work...
2024-10-22 15:36:49,627 - DEBUG - Pending tasks: 1
2024-10-22 15:36:49,627 - INFO - [pid 44709] Worker Worker(salt=9957166153, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=44709) running   Transform()
2024-10-22 15:36:49,631 - INFO - Connect to DWH - SUCCESS
2024-10-22 15:36:49,633 - INFO - Read Transform Query - SUCCESS
2024-10-22 15:36:49,633 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 15:36:49,921 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 15:36:52,759 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 15:36:53,262 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 15:36:53,340 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 15:37:09,216 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 15:47:25,107 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 15:47:31,573 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 15:47:41,240 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-22 15:47:41,244 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 15:47:41,252 - ERROR - Transform Tables - FAILED
2024-10-22 15:47:41,252 - ERROR - [pid 44709] Worker Worker(salt=9957166153, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=44709) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: syntax error at or near "OR"
LINE 39:                         OR final.fct_customer_reviews.review...
                                 ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 147, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) syntax error at or near "OR"
LINE 39:                         OR final.fct_customer_reviews.review...
                                 ^

[SQL: INSERT INTO final.fct_customer_reviews(
    review_id,
    dd_review_id,
    customer_id,
    seller_id,
    product_id,
    review_date,
    review_score
)

SELECT DISTINCT
    rv.id as review_id,
    rv.review_id as dd_review_id,
    dc.customer_id,
    ds.seller_id,
    dp.product_id,
    dd.date_id as review_date,
    rv.review_score

FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    stg.order_reviews rv ON o.order_id = rv.order_id
JOIN
    final.dim_products dp ON oi.product_id = dp.product_nk
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date dd ON TO_DATE(rv.review_creation_date, 'YYYY-MM-DD') = dd.date_actual

ON CONFLICT(review_id, dd_review_id, customer_id, seller_id, product_id, review_date)
DO UPDATE SET
    review_score = EXCLUDED.review_score,
    updated_at = CASE WHEN
                        OR final.fct_customer_reviews.review_score <> EXCLUDED.review_score
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_customer_reviews.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 15:47:41,293 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:47:41,301 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 15:47:41,301 - DEBUG - Asking scheduler for work...
2024-10-22 15:47:41,304 - DEBUG - Done
2024-10-22 15:47:41,304 - DEBUG - There are no more tasks to run at this time
2024-10-22 15:47:41,304 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 15:47:41,304 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 15:47:41,304 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 15:47:41,305 - INFO - Worker Worker(salt=9957166153, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=44709) was stopped. Shutting down Keep-Alive thread
2024-10-22 15:47:41,307 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 15:50:18,613 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 15:50:18,759 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 15:50:19,508 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 15:50:19,535 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 15:50:19,892 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 15:50:19,898 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 15:50:20,874 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 15:50:22,076 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 15:50:23,296 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 15:50:24,192 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 15:50:24,192 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 15:50:24,194 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 15:50:24,208 - INFO - [pid 52296] Worker Worker(salt=3340579518, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=52296) done      Extract()
2024-10-22 15:50:24,209 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:50:24,212 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 15:50:24,212 - DEBUG - Asking scheduler for work...
2024-10-22 15:50:24,214 - DEBUG - Pending tasks: 2
2024-10-22 15:50:24,214 - INFO - [pid 52296] Worker Worker(salt=3340579518, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=52296) running   Load()
2024-10-22 15:50:24,216 - INFO - Read Load Query - SUCCESS
2024-10-22 15:50:25,438 - INFO - Read Extracted Data - SUCCESS
2024-10-22 15:50:25,439 - INFO - Connect to DWH - SUCCESS
2024-10-22 15:50:25,856 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 15:50:25,856 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 15:50:49,142 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 15:51:01,711 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 15:51:01,715 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 15:51:01,780 - INFO - [pid 52296] Worker Worker(salt=3340579518, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=52296) done      Load()
2024-10-22 15:51:01,780 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:51:01,783 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 15:51:01,783 - DEBUG - Asking scheduler for work...
2024-10-22 15:51:01,784 - DEBUG - Pending tasks: 1
2024-10-22 15:51:01,785 - INFO - [pid 52296] Worker Worker(salt=3340579518, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=52296) running   Transform()
2024-10-22 15:51:01,786 - INFO - Connect to DWH - SUCCESS
2024-10-22 15:51:01,786 - INFO - Read Transform Query - SUCCESS
2024-10-22 15:51:01,786 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 15:51:01,957 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 15:51:03,600 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 15:51:03,801 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 15:51:03,836 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 15:51:12,200 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 15:56:11,771 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 15:56:16,514 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 15:56:23,603 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-22 15:56:27,740 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-22 15:56:27,746 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-22 15:56:27,749 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-22 15:56:27,749 - INFO - [pid 52296] Worker Worker(salt=3340579518, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=52296) done      Transform()
2024-10-22 15:56:27,750 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 15:56:27,752 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-22 15:56:27,752 - DEBUG - Asking scheduler for work...
2024-10-22 15:56:27,753 - DEBUG - Done
2024-10-22 15:56:27,754 - DEBUG - There are no more tasks to run at this time
2024-10-22 15:56:27,754 - INFO - Worker Worker(salt=3340579518, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=52296) was stopped. Shutting down Keep-Alive thread
2024-10-22 15:56:27,755 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-22 16:16:43,824 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 16:16:43,993 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 16:16:44,832 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 16:16:44,868 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 16:16:45,340 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 16:16:45,350 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 16:16:46,619 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 16:16:48,334 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 16:16:49,151 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 16:16:50,143 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 16:16:50,143 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 16:16:50,146 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 16:16:50,168 - INFO - [pid 63585] Worker Worker(salt=5357765705, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=63585) done      Extract()
2024-10-22 16:16:50,169 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 16:16:50,175 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 16:16:50,175 - DEBUG - Asking scheduler for work...
2024-10-22 16:16:50,178 - DEBUG - Pending tasks: 2
2024-10-22 16:16:50,179 - INFO - [pid 63585] Worker Worker(salt=5357765705, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=63585) running   Load()
2024-10-22 16:16:50,180 - INFO - Read Load Query - SUCCESS
2024-10-22 16:16:51,744 - INFO - Read Extracted Data - SUCCESS
2024-10-22 16:16:51,745 - INFO - Connect to DWH - SUCCESS
2024-10-22 16:16:52,122 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 16:16:52,123 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 16:17:15,377 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 16:17:28,094 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 16:17:28,097 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 16:17:28,144 - INFO - [pid 63585] Worker Worker(salt=5357765705, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=63585) done      Load()
2024-10-22 16:17:28,145 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 16:17:28,147 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 16:17:28,147 - DEBUG - Asking scheduler for work...
2024-10-22 16:17:28,149 - DEBUG - Pending tasks: 1
2024-10-22 16:17:28,149 - INFO - [pid 63585] Worker Worker(salt=5357765705, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=63585) running   Transform()
2024-10-22 16:17:28,150 - INFO - Connect to DWH - SUCCESS
2024-10-22 16:17:28,151 - INFO - Read Transform Query - SUCCESS
2024-10-22 16:17:28,151 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 16:17:28,383 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 16:17:29,791 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 16:17:30,548 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 16:17:30,581 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 16:17:37,777 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 17:35:37,605 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 17:35:37,715 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 17:35:38,173 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 17:35:38,199 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 17:35:38,492 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 17:35:38,498 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 17:35:39,288 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 17:35:40,197 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 17:35:40,727 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 17:35:41,373 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 17:35:41,374 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 17:35:41,377 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 17:35:41,393 - INFO - [pid 9208] Worker Worker(salt=2476974560, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=9208) done      Extract()
2024-10-22 17:35:41,394 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 17:35:41,396 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 17:35:41,397 - DEBUG - Asking scheduler for work...
2024-10-22 17:35:41,398 - DEBUG - Pending tasks: 2
2024-10-22 17:35:41,398 - INFO - [pid 9208] Worker Worker(salt=2476974560, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=9208) running   Load()
2024-10-22 17:35:41,402 - INFO - Read Load Query - SUCCESS
2024-10-22 17:35:42,455 - INFO - Read Extracted Data - SUCCESS
2024-10-22 17:35:42,457 - INFO - Connect to DWH - SUCCESS
2024-10-22 17:35:42,879 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 17:35:42,879 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 17:36:05,374 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 17:36:20,432 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 17:36:20,436 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 17:36:20,473 - INFO - [pid 9208] Worker Worker(salt=2476974560, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=9208) done      Load()
2024-10-22 17:36:20,474 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 17:36:20,476 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 17:36:20,476 - DEBUG - Asking scheduler for work...
2024-10-22 17:36:20,478 - DEBUG - Pending tasks: 1
2024-10-22 17:36:20,478 - INFO - [pid 9208] Worker Worker(salt=2476974560, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=9208) running   Transform()
2024-10-22 17:36:20,479 - INFO - Connect to DWH - SUCCESS
2024-10-22 17:36:20,481 - INFO - Read Transform Query - SUCCESS
2024-10-22 17:36:20,482 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 17:36:20,610 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 17:36:22,168 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 17:36:22,376 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 17:36:22,416 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 17:36:31,329 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 17:37:03,958 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 17:37:10,373 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 17:37:19,328 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-22 17:37:23,873 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-22 17:37:23,883 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-22 17:37:23,885 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-22 17:37:23,885 - INFO - [pid 9208] Worker Worker(salt=2476974560, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=9208) done      Transform()
2024-10-22 17:37:23,886 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 17:37:23,889 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-22 17:37:23,889 - DEBUG - Asking scheduler for work...
2024-10-22 17:37:23,891 - DEBUG - Done
2024-10-22 17:37:23,891 - DEBUG - There are no more tasks to run at this time
2024-10-22 17:37:23,891 - INFO - Worker Worker(salt=2476974560, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=9208) was stopped. Shutting down Keep-Alive thread
2024-10-22 17:37:23,893 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-22 18:09:13,454 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 18:09:13,578 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 18:09:14,095 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 18:09:14,123 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 18:09:14,425 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 18:09:14,434 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 18:09:15,347 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 18:09:16,294 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 18:09:16,916 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 18:09:17,666 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 18:09:17,666 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 18:09:17,670 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 18:09:17,683 - INFO - [pid 24613] Worker Worker(salt=2849173236, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24613) done      Extract()
2024-10-22 18:09:17,685 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:09:17,687 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 18:09:17,685 - DEBUG - Asking scheduler for work...
2024-10-22 18:09:17,686 - DEBUG - Pending tasks: 2
2024-10-22 18:09:17,687 - INFO - [pid 24613] Worker Worker(salt=2849173236, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24613) running   Load()
2024-10-22 18:09:17,687 - INFO - Read Load Query - SUCCESS
2024-10-22 18:09:18,841 - INFO - Read Extracted Data - SUCCESS
2024-10-22 18:09:18,842 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:09:19,207 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 18:09:19,208 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 18:09:41,277 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 18:09:56,863 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 18:09:56,865 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 18:09:56,900 - INFO - [pid 24613] Worker Worker(salt=2849173236, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24613) done      Load()
2024-10-22 18:09:56,900 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:09:56,902 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 18:09:56,903 - DEBUG - Asking scheduler for work...
2024-10-22 18:09:56,904 - DEBUG - Pending tasks: 1
2024-10-22 18:09:56,904 - INFO - [pid 24613] Worker Worker(salt=2849173236, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24613) running   Transform()
2024-10-22 18:09:56,905 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:09:56,906 - INFO - Read Transform Query - SUCCESS
2024-10-22 18:09:56,906 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 18:09:57,048 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 18:09:58,590 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 18:09:58,834 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 18:09:58,880 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 18:09:58,884 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 18:09:58,886 - ERROR - Transform Tables - FAILED
2024-10-22 18:09:58,886 - ERROR - [pid 24613] Worker Worker(salt=2849173236, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24613) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedTable: missing FROM-clause entry for table "oi"
LINE 74:             dim_sellers ds ON oi.seller_id = ds.seller_nk
                                       ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedTable) missing FROM-clause entry for table "oi"
LINE 74:             dim_sellers ds ON oi.seller_id = ds.seller_nk
                                       ^

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    -- Total aggregate for each order_id
    aggregated_order_items AS (
        SELECT
            oi.order_id,
            dp.product_id,
            COUNT(oi.order_item_id) AS total_quantity,
            SUM(oi.price) AS total_price,
            SUM(oi.freight_value) AS total_freight
        FROM
            stg_order_items oi
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        GROUP BY
            oi.order_id, dp.product_id
    ),

    final_fct_orders AS (
        SELECT
            -- oi.id AS order_id,
            o.order_id AS dd_order_id,
            ao.product_id,
            dc.customer_id,
            ds.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ao.total_quantity,
            ao.total_price,
            ao.total_freight,
            (ao.total_price + ao.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            aggregated_order_items ao ON o.order_id = ao.order_id
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT DISTINCT * FROM final_fct_orders
 
ON CONFLICT(order_id, dd_order_id, product_id, customer_id, seller_id, order_status_id, order_date)
DO UPDATE SET
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 18:09:58,895 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:09:58,903 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 18:09:58,903 - DEBUG - Asking scheduler for work...
2024-10-22 18:09:58,905 - DEBUG - Done
2024-10-22 18:09:58,905 - DEBUG - There are no more tasks to run at this time
2024-10-22 18:09:58,905 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 18:09:58,905 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 18:09:58,905 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 18:09:58,906 - INFO - Worker Worker(salt=2849173236, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=24613) was stopped. Shutting down Keep-Alive thread
2024-10-22 18:09:58,907 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 18:12:49,988 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 18:12:50,089 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 18:12:50,612 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 18:12:50,670 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 18:12:51,005 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 18:12:51,012 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 18:12:51,744 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 18:12:52,587 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 18:12:53,061 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 18:12:53,696 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 18:12:53,696 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 18:12:53,698 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 18:12:53,712 - INFO - [pid 26441] Worker Worker(salt=3101359933, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=26441) done      Extract()
2024-10-22 18:12:53,714 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:12:53,717 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 18:12:53,717 - DEBUG - Asking scheduler for work...
2024-10-22 18:12:53,719 - DEBUG - Pending tasks: 2
2024-10-22 18:12:53,719 - INFO - [pid 26441] Worker Worker(salt=3101359933, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=26441) running   Load()
2024-10-22 18:12:53,719 - INFO - Read Load Query - SUCCESS
2024-10-22 18:12:55,171 - INFO - Read Extracted Data - SUCCESS
2024-10-22 18:12:55,173 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:12:55,525 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 18:12:55,525 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 18:13:16,598 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 18:13:26,121 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 18:13:26,123 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 18:13:26,158 - INFO - [pid 26441] Worker Worker(salt=3101359933, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=26441) done      Load()
2024-10-22 18:13:26,158 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:13:26,161 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 18:13:26,161 - DEBUG - Asking scheduler for work...
2024-10-22 18:13:26,162 - DEBUG - Pending tasks: 1
2024-10-22 18:13:26,162 - INFO - [pid 26441] Worker Worker(salt=3101359933, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=26441) running   Transform()
2024-10-22 18:13:26,163 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:13:26,163 - INFO - Read Transform Query - SUCCESS
2024-10-22 18:13:26,163 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 18:13:26,281 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 18:13:27,563 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 18:13:27,747 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 18:13:27,785 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 18:13:27,790 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 18:13:27,794 - ERROR - Transform Tables - FAILED
2024-10-22 18:13:27,794 - ERROR - [pid 26441] Worker Worker(salt=3101359933, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=26441) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedTable: missing FROM-clause entry for table "ds"
LINE 62:             ds.seller_id,
                     ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedTable) missing FROM-clause entry for table "ds"
LINE 62:             ds.seller_id,
                     ^

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    -- Total aggregate for each order_id
    aggregated_order_items AS (
        SELECT
            oi.order_id,
            dp.product_id,
            ds.seller_id,
            COUNT(oi.order_item_id) AS total_quantity,
            SUM(oi.price) AS total_price,
            SUM(oi.freight_value) AS total_freight
        FROM
            stg_order_items oi
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        GROUP BY
            1, 2, 3
    ),

    final_fct_orders AS (
        SELECT
            -- oi.id AS order_id,
            o.order_id AS dd_order_id,
            ao.product_id,
            dc.customer_id,
            ds.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ao.total_quantity,
            ao.total_price,
            ao.total_freight,
            (ao.total_price + ao.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            aggregated_order_items ao ON o.order_id = ao.order_id
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT DISTINCT * FROM final_fct_orders
 
ON CONFLICT(order_id, dd_order_id, product_id, customer_id, seller_id, order_status_id, order_date)
DO UPDATE SET
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 18:13:27,797 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:13:27,803 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 18:13:27,803 - DEBUG - Asking scheduler for work...
2024-10-22 18:13:27,805 - DEBUG - Done
2024-10-22 18:13:27,805 - DEBUG - There are no more tasks to run at this time
2024-10-22 18:13:27,805 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 18:13:27,806 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 18:13:27,806 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 18:13:27,806 - INFO - Worker Worker(salt=3101359933, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=26441) was stopped. Shutting down Keep-Alive thread
2024-10-22 18:13:27,807 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 18:15:22,127 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 18:15:22,224 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 18:15:22,695 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 18:15:22,721 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 18:15:22,989 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 18:15:22,994 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 18:15:23,867 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 18:15:24,881 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 18:15:25,419 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 18:15:26,054 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 18:15:26,055 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 18:15:26,056 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 18:15:26,076 - INFO - [pid 28207] Worker Worker(salt=361172669, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=28207) done      Extract()
2024-10-22 18:15:26,077 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:15:26,079 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 18:15:26,079 - DEBUG - Asking scheduler for work...
2024-10-22 18:15:26,081 - DEBUG - Pending tasks: 2
2024-10-22 18:15:26,081 - INFO - [pid 28207] Worker Worker(salt=361172669, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=28207) running   Load()
2024-10-22 18:15:26,081 - INFO - Read Load Query - SUCCESS
2024-10-22 18:15:27,204 - INFO - Read Extracted Data - SUCCESS
2024-10-22 18:15:27,205 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:15:27,554 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 18:15:27,554 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 18:15:48,544 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 18:15:58,130 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 18:15:58,133 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 18:15:58,231 - INFO - [pid 28207] Worker Worker(salt=361172669, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=28207) done      Load()
2024-10-22 18:15:58,231 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:15:58,235 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 18:15:58,236 - DEBUG - Asking scheduler for work...
2024-10-22 18:15:58,238 - DEBUG - Pending tasks: 1
2024-10-22 18:15:58,239 - INFO - [pid 28207] Worker Worker(salt=361172669, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=28207) running   Transform()
2024-10-22 18:15:58,240 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:15:58,241 - INFO - Read Transform Query - SUCCESS
2024-10-22 18:15:58,241 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 18:15:58,356 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 18:15:59,540 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 18:15:59,742 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 18:15:59,779 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 18:15:59,783 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 18:15:59,787 - ERROR - Transform Tables - FAILED
2024-10-22 18:15:59,787 - ERROR - [pid 28207] Worker Worker(salt=361172669, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=28207) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: INSERT has more target columns than expressions
LINE 93:     total_amount
             ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) INSERT has more target columns than expressions
LINE 93:     total_amount
             ^

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    -- Total aggregate for each order_id
    aggregated_order_items AS (
        SELECT
            oi.order_id,
            dp.product_id,
            ds.seller_id,
            COUNT(oi.order_item_id) AS total_quantity,
            SUM(oi.price) AS total_price,
            SUM(oi.freight_value) AS total_freight
        FROM
            stg_order_items oi
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        GROUP BY
            1, 2, 3
    ),

    final_fct_orders AS (
        SELECT
            -- oi.id AS order_id,
            o.order_id AS dd_order_id,
            ao.product_id,
            dc.customer_id,
            ao.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ao.total_quantity,
            ao.total_price,
            ao.total_freight,
            (ao.total_price + ao.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            aggregated_order_items ao ON o.order_id = ao.order_id
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT DISTINCT * FROM final_fct_orders
 
ON CONFLICT(order_id, dd_order_id, product_id, customer_id, seller_id, order_status_id, order_date)
DO UPDATE SET
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 18:15:59,803 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:15:59,810 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 18:15:59,810 - DEBUG - Asking scheduler for work...
2024-10-22 18:15:59,812 - DEBUG - Done
2024-10-22 18:15:59,813 - DEBUG - There are no more tasks to run at this time
2024-10-22 18:15:59,813 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 18:15:59,813 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 18:15:59,813 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 18:15:59,813 - INFO - Worker Worker(salt=361172669, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=28207) was stopped. Shutting down Keep-Alive thread
2024-10-22 18:15:59,814 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 18:19:17,943 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 18:19:18,047 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 18:19:18,707 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 18:19:18,733 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 18:19:19,033 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 18:19:19,039 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 18:19:19,845 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 18:19:20,723 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 18:19:21,278 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 18:19:21,860 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 18:19:21,860 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 18:19:21,862 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 18:19:21,879 - INFO - [pid 30226] Worker Worker(salt=309222516, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=30226) done      Extract()
2024-10-22 18:19:21,881 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:19:21,884 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 18:19:21,884 - DEBUG - Asking scheduler for work...
2024-10-22 18:19:21,886 - DEBUG - Pending tasks: 2
2024-10-22 18:19:21,886 - INFO - [pid 30226] Worker Worker(salt=309222516, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=30226) running   Load()
2024-10-22 18:19:21,887 - INFO - Read Load Query - SUCCESS
2024-10-22 18:19:23,020 - INFO - Read Extracted Data - SUCCESS
2024-10-22 18:19:23,021 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:19:23,410 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 18:19:23,410 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 18:19:43,572 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 18:19:52,880 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 18:19:52,882 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 18:19:52,910 - INFO - [pid 30226] Worker Worker(salt=309222516, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=30226) done      Load()
2024-10-22 18:19:52,911 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:19:52,914 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 18:19:52,914 - DEBUG - Asking scheduler for work...
2024-10-22 18:19:52,916 - DEBUG - Pending tasks: 1
2024-10-22 18:19:52,916 - INFO - [pid 30226] Worker Worker(salt=309222516, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=30226) running   Transform()
2024-10-22 18:19:52,917 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:19:52,917 - INFO - Read Transform Query - SUCCESS
2024-10-22 18:19:52,917 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 18:19:53,058 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 18:19:54,439 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 18:19:54,632 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 18:19:54,732 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 18:19:54,737 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 18:19:54,740 - ERROR - Transform Tables - FAILED
2024-10-22 18:19:54,740 - ERROR - [pid 30226] Worker Worker(salt=309222516, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=30226) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: INSERT has more target columns than expressions
LINE 93:     total_amount
             ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 127, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) INSERT has more target columns than expressions
LINE 93:     total_amount
             ^

[SQL: WITH
    stg_orders AS (
        SELECT * 
        FROM stg.orders
    ),

    stg_order_items AS (
        SELECT *
        FROM stg.order_items
    ),

    dim_products AS (
        SELECT * 
        FROM final.dim_products
    ),

    dim_customers AS (
        SELECT * 
        FROM final.dim_customers
    ),

    dim_sellers AS (
        SELECT * 
        FROM final.dim_sellers
    ),

    dim_order_status AS (
        SELECT * 
        FROM final.dim_order_status
    ),

    dim_date AS (
        SELECT * 
        FROM final.dim_date
    ),

    -- Total aggregate for each order_id
    aggregated_order_items AS (
        SELECT
            oi.order_id,
            dp.product_id,
            ds.seller_id,
            COUNT(oi.order_item_id) AS total_quantity,
            SUM(oi.price) AS total_price,
            SUM(oi.freight_value) AS total_freight
        FROM
            stg_order_items oi
        JOIN
            dim_products dp ON oi.product_id = dp.product_nk
        JOIN
            dim_sellers ds ON oi.seller_id = ds.seller_nk
        GROUP BY
            1, 2, 3
    ),

    final_fct_orders AS (
        SELECT
            -- oi.id AS order_id,
            o.order_id AS dd_order_id,
            ao.product_id,
            dc.customer_id,
            ao.seller_id,
            os.order_status_id,
            dd.date_id AS order_date,
            ao.total_quantity,
            ao.total_price,
            ao.total_freight,
            (ao.total_price + ao.total_freight) AS total_amount

        FROM
            stg_orders o
        JOIN
            aggregated_order_items ao ON o.order_id = ao.order_id
        JOIN
            dim_customers dc ON o.customer_id = dc.customer_nk
        JOIN
            dim_order_status os ON o.order_status = os.order_status
        JOIN
            dim_date dd ON TO_DATE(o.order_purchase_timestamp, 'YYYY-MM-DD') = dd.date_actual
    )

INSERT INTO final.fct_orders(
    order_id,
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount
)

SELECT
    dd_order_id,
    product_id,
    customer_id,
    seller_id,
    order_status_id,
    order_date,
    total_quantity,
    total_price,
    total_freight,
    total_amount

FROM final_fct_orders
 
ON CONFLICT(order_id, dd_order_id, product_id, customer_id, seller_id, order_status_id, order_date)
DO UPDATE SET
    total_quantity = EXCLUDED.total_quantity,
    total_price = EXCLUDED.total_price,
    total_freight = EXCLUDED.total_freight,
    total_amount = EXCLUDED.total_amount,
    updated_at = CASE WHEN
                        final.fct_orders.total_quantity <> EXCLUDED.total_quantity
                        OR final.fct_orders.total_price <> EXCLUDED.total_price
                        OR final.fct_orders.total_freight <> EXCLUDED.total_freight
                        OR final.fct_orders.total_amount <> EXCLUDED.total_amount
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_orders.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 18:19:54,744 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:19:54,751 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 18:19:54,752 - DEBUG - Asking scheduler for work...
2024-10-22 18:19:54,756 - DEBUG - Done
2024-10-22 18:19:54,756 - DEBUG - There are no more tasks to run at this time
2024-10-22 18:19:54,756 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 18:19:54,756 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 18:19:54,756 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 18:19:54,757 - INFO - Worker Worker(salt=309222516, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=30226) was stopped. Shutting down Keep-Alive thread
2024-10-22 18:19:54,758 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 18:21:33,650 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 18:21:33,744 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 18:21:34,176 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 18:21:34,197 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 18:21:34,450 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 18:21:34,456 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 18:21:35,157 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 18:21:36,037 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 18:21:36,529 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 18:21:37,102 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 18:21:37,102 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 18:21:37,103 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 18:21:37,118 - INFO - [pid 31440] Worker Worker(salt=4055100931, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31440) done      Extract()
2024-10-22 18:21:37,120 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:21:37,124 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 18:21:37,124 - DEBUG - Asking scheduler for work...
2024-10-22 18:21:37,125 - DEBUG - Pending tasks: 2
2024-10-22 18:21:37,125 - INFO - [pid 31440] Worker Worker(salt=4055100931, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31440) running   Load()
2024-10-22 18:21:37,126 - INFO - Read Load Query - SUCCESS
2024-10-22 18:21:38,129 - INFO - Read Extracted Data - SUCCESS
2024-10-22 18:21:38,130 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:21:38,494 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 18:21:38,494 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 18:21:58,329 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 18:22:07,173 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 18:22:07,176 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 18:22:07,207 - INFO - [pid 31440] Worker Worker(salt=4055100931, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31440) done      Load()
2024-10-22 18:22:07,207 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:22:07,210 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 18:22:07,210 - DEBUG - Asking scheduler for work...
2024-10-22 18:22:07,211 - DEBUG - Pending tasks: 1
2024-10-22 18:22:07,212 - INFO - [pid 31440] Worker Worker(salt=4055100931, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31440) running   Transform()
2024-10-22 18:22:07,213 - INFO - Connect to DWH - SUCCESS
2024-10-22 18:22:07,213 - INFO - Read Transform Query - SUCCESS
2024-10-22 18:22:07,213 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 18:22:07,317 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 18:22:08,461 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 18:22:08,650 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 18:22:08,686 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 18:22:14,747 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 18:27:09,681 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 18:27:14,127 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 18:27:20,500 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-22 18:27:24,509 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-22 18:27:24,515 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-22 18:27:24,518 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-22 18:27:24,518 - INFO - [pid 31440] Worker Worker(salt=4055100931, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31440) done      Transform()
2024-10-22 18:27:24,518 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 18:27:24,522 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-22 18:27:24,522 - DEBUG - Asking scheduler for work...
2024-10-22 18:27:24,523 - DEBUG - Done
2024-10-22 18:27:24,523 - DEBUG - There are no more tasks to run at this time
2024-10-22 18:27:24,524 - INFO - Worker Worker(salt=4055100931, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31440) was stopped. Shutting down Keep-Alive thread
2024-10-22 18:27:24,526 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-22 20:33:57,620 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 20:33:57,951 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 20:33:58,892 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 20:33:58,928 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 20:33:59,373 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 20:33:59,380 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 20:34:00,635 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 20:34:01,846 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 20:34:02,502 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 20:34:03,406 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 20:34:03,407 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 20:34:03,423 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 20:34:03,437 - INFO - [pid 92880] Worker Worker(salt=5708370677, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=92880) done      Extract()
2024-10-22 20:34:03,439 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 20:34:03,441 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 20:34:03,442 - DEBUG - Asking scheduler for work...
2024-10-22 20:34:03,443 - DEBUG - Pending tasks: 2
2024-10-22 20:34:03,443 - INFO - [pid 92880] Worker Worker(salt=5708370677, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=92880) running   Load()
2024-10-22 20:34:03,446 - INFO - Read Load Query - SUCCESS
2024-10-22 20:34:04,441 - INFO - Read Extracted Data - SUCCESS
2024-10-22 20:34:04,442 - INFO - Connect to DWH - SUCCESS
2024-10-22 20:34:04,895 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 20:34:04,895 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 20:34:38,316 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 20:35:09,099 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 20:35:09,102 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 20:35:09,143 - INFO - [pid 92880] Worker Worker(salt=5708370677, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=92880) done      Load()
2024-10-22 20:35:09,144 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 20:35:09,146 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 20:35:09,147 - DEBUG - Asking scheduler for work...
2024-10-22 20:35:09,148 - DEBUG - Pending tasks: 1
2024-10-22 20:35:09,149 - INFO - [pid 92880] Worker Worker(salt=5708370677, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=92880) running   Transform()
2024-10-22 20:35:09,150 - INFO - Connect to DWH - SUCCESS
2024-10-22 20:35:09,153 - INFO - Read Transform Query - SUCCESS
2024-10-22 20:35:09,153 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 20:35:09,275 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 20:35:11,042 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 20:35:11,385 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 20:35:11,505 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 20:35:20,921 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 20:41:10,285 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 20:41:16,841 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 20:41:24,121 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-22 20:41:29,371 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-22 20:41:29,382 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-22 20:41:29,437 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-22 20:41:29,438 - INFO - [pid 92880] Worker Worker(salt=5708370677, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=92880) done      Transform()
2024-10-22 20:41:29,442 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 20:41:29,450 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-22 20:41:29,450 - DEBUG - Asking scheduler for work...
2024-10-22 20:41:29,452 - DEBUG - Done
2024-10-22 20:41:29,452 - DEBUG - There are no more tasks to run at this time
2024-10-22 20:41:29,453 - INFO - Worker Worker(salt=5708370677, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=92880) was stopped. Shutting down Keep-Alive thread
2024-10-22 20:41:29,463 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-22 21:17:00,776 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 21:17:01,013 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 21:17:02,055 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 21:17:02,085 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 21:17:02,548 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 21:17:02,559 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 21:17:04,090 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 21:17:05,662 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 21:17:06,314 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 21:17:07,306 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 21:17:07,306 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 21:17:07,311 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 21:17:07,326 - INFO - [pid 14246] Worker Worker(salt=3261196663, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=14246) done      Extract()
2024-10-22 21:17:07,327 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:17:07,329 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 21:17:07,329 - DEBUG - Asking scheduler for work...
2024-10-22 21:17:07,331 - DEBUG - Pending tasks: 2
2024-10-22 21:17:07,331 - INFO - [pid 14246] Worker Worker(salt=3261196663, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=14246) running   Load()
2024-10-22 21:17:07,332 - INFO - Read Load Query - SUCCESS
2024-10-22 21:17:08,641 - INFO - Read Extracted Data - SUCCESS
2024-10-22 21:17:08,642 - INFO - Connect to DWH - SUCCESS
2024-10-22 21:17:09,110 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 21:17:09,110 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 21:17:35,703 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 21:18:02,776 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 21:18:02,781 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 21:18:02,837 - INFO - [pid 14246] Worker Worker(salt=3261196663, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=14246) done      Load()
2024-10-22 21:18:02,837 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:18:02,840 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 21:18:02,840 - DEBUG - Asking scheduler for work...
2024-10-22 21:18:02,841 - DEBUG - Pending tasks: 1
2024-10-22 21:18:02,842 - INFO - [pid 14246] Worker Worker(salt=3261196663, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=14246) running   Transform()
2024-10-22 21:18:02,843 - INFO - Connect to DWH - SUCCESS
2024-10-22 21:18:02,845 - INFO - Read Transform Query - SUCCESS
2024-10-22 21:18:02,845 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 21:18:02,887 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 21:18:02,889 - ERROR - Transform Tables - FAILED
2024-10-22 21:18:02,889 - ERROR - [pid 14246] Worker Worker(salt=3261196663, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=14246) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedTable: relation "final.dim_geolocation" does not exist
LINE 1: INSERT INTO final.dim_geolocation (
                    ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 107, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedTable) relation "final.dim_geolocation" does not exist
LINE 1: INSERT INTO final.dim_geolocation (
                    ^

[SQL: INSERT INTO final.dim_geolocation (
    geolocation_id,
    geolocation_zip_code_prefix,
    geolocation_lat,
    geolocation_lng,
    geolocation_city,
    geolocation_state
)

SELECT
    g.id as geolocation_id,
    g.geolocation_zip_code_prefix,
    g.geolocation_lat,
    g.geolocation_lng,
    g.geolocation_city,
    g.geolocation_state
FROM 
    stg.geolocation g

ON CONFLICT(geolocation_id)
DO UPDATE SET 
    geolocation_zip_code_prefix = EXCLUDED.geolocation_zip_code_prefix, 
    geolocation_lat = EXCLUDED.geolocation_lat,
    geolocation_lng = EXCLUDED.geolocation_lng,
    geolocation_city = EXCLUDED.geolocation_city,
    geolocation_state = EXCLUDED.geolocation_state,
    updated_at = CASE WHEN
                        final.dim_geolocation.geolocation_zip_code_prefix <> EXCLUDED.geolocation_zip_code_prefix
                        OR final.dim_geolocation.geolocation_lat <> EXCLUDED.geolocation_lat
                        OR final.dim_geolocation.geolocation_lng <> EXCLUDED.geolocation_lng
                        OR final.dim_geolocation.geolocation_city <> EXCLUDED.geolocation_city
                        OR final.dim_geolocation.geolocation_state <> EXCLUDED.geolocation_state
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.dim_geolocation.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 21:18:02,926 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:18:02,932 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 21:18:02,932 - DEBUG - Asking scheduler for work...
2024-10-22 21:18:02,935 - DEBUG - Done
2024-10-22 21:18:02,936 - DEBUG - There are no more tasks to run at this time
2024-10-22 21:18:02,936 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 21:18:02,936 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 21:18:02,937 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 21:18:02,937 - INFO - Worker Worker(salt=3261196663, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=14246) was stopped. Shutting down Keep-Alive thread
2024-10-22 21:18:02,939 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 21:29:02,877 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 21:29:03,007 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 21:29:03,515 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 21:29:03,543 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 21:29:03,820 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 21:29:03,826 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 21:29:04,679 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 21:29:05,686 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 21:29:06,262 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 21:29:06,999 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 21:29:06,999 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 21:29:07,001 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 21:29:07,014 - INFO - [pid 20063] Worker Worker(salt=6900491265, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=20063) done      Extract()
2024-10-22 21:29:07,015 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:29:07,017 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 21:29:07,017 - DEBUG - Asking scheduler for work...
2024-10-22 21:29:07,019 - DEBUG - Pending tasks: 1
2024-10-22 21:29:07,019 - INFO - [pid 20063] Worker Worker(salt=6900491265, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=20063) running   Load()
2024-10-22 21:29:07,020 - INFO - Read Load Query - SUCCESS
2024-10-22 21:29:07,983 - INFO - Read Extracted Data - SUCCESS
2024-10-22 21:29:07,985 - INFO - Connect to DWH - SUCCESS
2024-10-22 21:29:08,369 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 21:29:08,370 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 21:29:30,962 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 21:29:42,207 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 21:29:42,209 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 21:29:42,241 - INFO - [pid 20063] Worker Worker(salt=6900491265, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=20063) done      Load()
2024-10-22 21:29:42,241 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:29:42,243 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 21:29:42,244 - DEBUG - Asking scheduler for work...
2024-10-22 21:29:42,245 - DEBUG - Done
2024-10-22 21:29:42,245 - DEBUG - There are no more tasks to run at this time
2024-10-22 21:29:42,245 - INFO - Worker Worker(salt=6900491265, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=20063) was stopped. Shutting down Keep-Alive thread
2024-10-22 21:29:42,246 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 were left pending, among these:
    * 1 was not granted run permission by the scheduler:
        - 1 Transform()

This progress looks :| because there were tasks that were not granted run permission by the scheduler

===== Luigi Execution Summary =====

2024-10-22 21:31:19,723 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 21:31:19,825 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 21:31:20,423 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 21:31:20,453 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 21:31:20,733 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 21:31:20,740 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 21:31:21,541 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 21:31:22,450 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 21:31:23,015 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 21:31:23,717 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 21:31:23,717 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 21:31:23,719 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 21:31:23,740 - INFO - [pid 21331] Worker Worker(salt=4647655014, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21331) done      Extract()
2024-10-22 21:31:23,742 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:31:23,745 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 21:31:23,745 - DEBUG - Asking scheduler for work...
2024-10-22 21:31:23,747 - DEBUG - Pending tasks: 2
2024-10-22 21:31:23,747 - INFO - [pid 21331] Worker Worker(salt=4647655014, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21331) running   Load()
2024-10-22 21:31:23,748 - INFO - Read Load Query - SUCCESS
2024-10-22 21:31:24,930 - INFO - Read Extracted Data - SUCCESS
2024-10-22 21:31:24,931 - INFO - Connect to DWH - SUCCESS
2024-10-22 21:31:25,290 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 21:31:25,290 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 21:31:49,706 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 21:32:01,845 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 21:32:01,847 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 21:32:01,892 - INFO - [pid 21331] Worker Worker(salt=4647655014, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21331) done      Load()
2024-10-22 21:32:01,892 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:32:01,895 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 21:32:01,896 - DEBUG - Asking scheduler for work...
2024-10-22 21:32:01,897 - DEBUG - Pending tasks: 1
2024-10-22 21:32:01,897 - INFO - [pid 21331] Worker Worker(salt=4647655014, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21331) running   Transform()
2024-10-22 21:32:01,898 - INFO - Connect to DWH - SUCCESS
2024-10-22 21:32:01,899 - INFO - Read Transform Query - SUCCESS
2024-10-22 21:32:01,899 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 21:32:02,062 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 21:32:03,546 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 21:32:03,753 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 21:32:03,792 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 21:32:12,478 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 21:37:20,022 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 21:37:25,173 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 21:37:25,182 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 21:37:25,229 - ERROR - Transform Tables - FAILED
2024-10-22 21:37:25,230 - ERROR - [pid 21331] Worker Worker(salt=4647655014, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21331) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedFunction: function age(integer, integer) does not exist
LINE 24:     EXTRACT(DAY FROM AGE(op.date_id, oa.date_id)) AS day_pro...
                              ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 142, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedFunction) function age(integer, integer) does not exist
LINE 24:     EXTRACT(DAY FROM AGE(op.date_id, oa.date_id)) AS day_pro...
                              ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[SQL: INSERT INTO final.fct_order_delivery(
    -- delivery_id is generated by UUID when create the table
    order_id,
    customer_id,
    seller_id,
    order_received_date,
    process_date,
    success_date,
    estimated_date,
    day_process,
    day_success
)

SELECT
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_id AS order_received_date,
    op.date_id AS process_date,
    os.date_id AS success_date,
    ed.date_id AS estimated_date,

    -- Calculate day process using AGE function to subtract dates
    EXTRACT(DAY FROM AGE(op.date_id, oa.date_id)) AS day_process,

    -- Calculate day success
    EXTRACT(DAY FROM AGE(os.date_id - op.date_id)) AS day_success

FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date oa ON TO_DATE(o.order_approved_at, 'YYYY-MM-DD') = oa.date_actual
JOIN
    final.dim_date op ON TO_DATE(o.order_delivered_carrier_date, 'YYYY-MM-DD') = op.date_actual
JOIN
    final.dim_date os ON TO_DATE(o.order_delivered_customer_date, 'YYYY-MM-DD') = os.date_actual
JOIN
    final.dim_date ed ON TO_DATE(o.order_estimated_delivery_date, 'YYYY-MM-DD') = ed.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id
GROUP BY 
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_id,
    op.date_id,
    os.date_id,
    ed.date_id 

ON CONFLICT(delivery_id, customer_id, seller_id, order_received_date)
DO UPDATE SET
    -- order_id = EXCLUDED.order_id,
    -- customer_id = EXCLUDED.customer_id,
    -- seller_id = EXCLUDED.seller_id,
    -- order_received_date = EXCLUDED.order_received_date,
    process_date = EXCLUDED.process_date,
    success_date = EXCLUDED.success_date,
    estimated_date = EXCLUDED.estimated_date,
    day_process = EXCLUDED.day_process,
    day_success = EXCLUDED.day_success,
    updated_at = CASE WHEN
                        -- final.fct_order_delivery.order_id <> EXCLUDED.order_id
                        -- OR final.fct_order_delivery.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_order_delivery.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_order_delivery.order_received_date <> EXCLUDED.order_received_date
                        final.fct_order_delivery.process_date <> EXCLUDED.process_date
                        OR final.fct_order_delivery.success_date <> EXCLUDED.success_date
                        OR final.fct_order_delivery.estimated_date <> EXCLUDED.estimated_date
                        OR final.fct_order_delivery.day_process <> EXCLUDED.day_process
                        OR final.fct_order_delivery.day_success <> EXCLUDED.day_success
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_delivery.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 21:37:25,266 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:37:25,284 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 21:37:25,284 - DEBUG - Asking scheduler for work...
2024-10-22 21:37:25,288 - DEBUG - Done
2024-10-22 21:37:25,290 - DEBUG - There are no more tasks to run at this time
2024-10-22 21:37:25,290 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 21:37:25,290 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 21:37:25,290 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 21:37:25,291 - INFO - Worker Worker(salt=4647655014, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=21331) was stopped. Shutting down Keep-Alive thread
2024-10-22 21:37:25,303 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 21:38:23,623 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 21:38:23,767 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 21:38:24,376 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 21:38:24,404 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 21:38:24,704 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 21:38:24,709 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 21:38:25,690 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 21:38:26,798 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 21:38:27,392 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 21:38:28,274 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 21:38:28,275 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 21:38:28,276 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 21:38:28,292 - INFO - [pid 25625] Worker Worker(salt=6455351436, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=25625) done      Extract()
2024-10-22 21:38:28,293 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:38:28,295 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 21:38:28,296 - DEBUG - Asking scheduler for work...
2024-10-22 21:38:28,297 - DEBUG - Pending tasks: 2
2024-10-22 21:38:28,297 - INFO - [pid 25625] Worker Worker(salt=6455351436, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=25625) running   Load()
2024-10-22 21:38:28,299 - INFO - Read Load Query - SUCCESS
2024-10-22 21:38:29,622 - INFO - Read Extracted Data - SUCCESS
2024-10-22 21:38:29,624 - INFO - Connect to DWH - SUCCESS
2024-10-22 21:38:30,153 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 21:38:30,153 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 21:38:52,889 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 21:39:04,652 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 21:39:04,654 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 21:39:04,703 - INFO - [pid 25625] Worker Worker(salt=6455351436, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=25625) done      Load()
2024-10-22 21:39:04,704 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:39:04,707 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 21:39:04,708 - DEBUG - Asking scheduler for work...
2024-10-22 21:39:04,709 - DEBUG - Pending tasks: 1
2024-10-22 21:39:04,710 - INFO - [pid 25625] Worker Worker(salt=6455351436, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=25625) running   Transform()
2024-10-22 21:39:04,711 - INFO - Connect to DWH - SUCCESS
2024-10-22 21:39:04,713 - INFO - Read Transform Query - SUCCESS
2024-10-22 21:39:04,713 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 21:39:04,901 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 21:39:06,492 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 21:39:06,716 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 21:39:06,757 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 21:39:15,885 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 21:44:20,619 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 21:44:25,274 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 21:44:25,280 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 21:44:25,282 - ERROR - Transform Tables - FAILED
2024-10-22 21:44:25,282 - ERROR - [pid 25625] Worker Worker(salt=6455351436, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=25625) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedFunction: function age(integer) does not exist
LINE 27:     EXTRACT(DAY FROM AGE(os.date_actual - op.date_actual)) A...
                              ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 142, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedFunction) function age(integer) does not exist
LINE 27:     EXTRACT(DAY FROM AGE(os.date_actual - op.date_actual)) A...
                              ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[SQL: INSERT INTO final.fct_order_delivery(
    -- delivery_id is generated by UUID when create the table
    order_id,
    customer_id,
    seller_id,
    order_received_date,
    process_date,
    success_date,
    estimated_date,
    day_process,
    day_success
)

SELECT
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_id AS order_received_date,
    op.date_id AS process_date,
    os.date_id AS success_date,
    ed.date_id AS estimated_date,

    -- Calculate day process using AGE function to subtract dates
    EXTRACT(DAY FROM AGE(op.date_actual, oa.date_actual)) AS day_process,

    -- Calculate day success
    EXTRACT(DAY FROM AGE(os.date_actual - op.date_actual)) AS day_success

FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date oa ON TO_DATE(o.order_approved_at, 'YYYY-MM-DD') = oa.date_actual
JOIN
    final.dim_date op ON TO_DATE(o.order_delivered_carrier_date, 'YYYY-MM-DD') = op.date_actual
JOIN
    final.dim_date os ON TO_DATE(o.order_delivered_customer_date, 'YYYY-MM-DD') = os.date_actual
JOIN
    final.dim_date ed ON TO_DATE(o.order_estimated_delivery_date, 'YYYY-MM-DD') = ed.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id
GROUP BY 
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_id,
    op.date_id,
    os.date_id,
    ed.date_id 

ON CONFLICT(delivery_id, customer_id, seller_id, order_received_date)
DO UPDATE SET
    -- order_id = EXCLUDED.order_id,
    -- customer_id = EXCLUDED.customer_id,
    -- seller_id = EXCLUDED.seller_id,
    -- order_received_date = EXCLUDED.order_received_date,
    process_date = EXCLUDED.process_date,
    success_date = EXCLUDED.success_date,
    estimated_date = EXCLUDED.estimated_date,
    day_process = EXCLUDED.day_process,
    day_success = EXCLUDED.day_success,
    updated_at = CASE WHEN
                        -- final.fct_order_delivery.order_id <> EXCLUDED.order_id
                        -- OR final.fct_order_delivery.customer_id <> EXCLUDED.customer_id
                        -- OR final.fct_order_delivery.seller_id <> EXCLUDED.seller_id
                        -- OR final.fct_order_delivery.order_received_date <> EXCLUDED.order_received_date
                        final.fct_order_delivery.process_date <> EXCLUDED.process_date
                        OR final.fct_order_delivery.success_date <> EXCLUDED.success_date
                        OR final.fct_order_delivery.estimated_date <> EXCLUDED.estimated_date
                        OR final.fct_order_delivery.day_process <> EXCLUDED.day_process
                        OR final.fct_order_delivery.day_success <> EXCLUDED.day_success
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_delivery.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 21:44:25,295 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:44:25,302 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 21:44:25,303 - DEBUG - Asking scheduler for work...
2024-10-22 21:44:25,305 - DEBUG - Done
2024-10-22 21:44:25,305 - DEBUG - There are no more tasks to run at this time
2024-10-22 21:44:25,305 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 21:44:25,305 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 21:44:25,305 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 21:44:25,306 - INFO - Worker Worker(salt=6455351436, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=25625) was stopped. Shutting down Keep-Alive thread
2024-10-22 21:44:25,308 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 21:48:12,867 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 21:48:12,983 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 21:48:13,542 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 21:48:13,566 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 21:48:13,861 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 21:48:13,866 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 21:48:14,837 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 21:48:16,072 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 21:48:16,668 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 21:48:17,521 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 21:48:17,521 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 21:48:17,524 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 21:48:17,545 - INFO - [pid 31194] Worker Worker(salt=6146295757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31194) done      Extract()
2024-10-22 21:48:17,546 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:48:17,549 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 21:48:17,549 - DEBUG - Asking scheduler for work...
2024-10-22 21:48:17,551 - DEBUG - Pending tasks: 2
2024-10-22 21:48:17,551 - INFO - [pid 31194] Worker Worker(salt=6146295757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31194) running   Load()
2024-10-22 21:48:17,552 - INFO - Read Load Query - SUCCESS
2024-10-22 21:48:19,031 - INFO - Read Extracted Data - SUCCESS
2024-10-22 21:48:19,032 - INFO - Connect to DWH - SUCCESS
2024-10-22 21:48:19,354 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 21:48:19,354 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 21:48:45,542 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 21:49:03,350 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 21:49:03,352 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 21:49:03,395 - INFO - [pid 31194] Worker Worker(salt=6146295757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31194) done      Load()
2024-10-22 21:49:03,395 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:49:03,398 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 21:49:03,398 - DEBUG - Asking scheduler for work...
2024-10-22 21:49:03,400 - DEBUG - Pending tasks: 1
2024-10-22 21:49:03,400 - INFO - [pid 31194] Worker Worker(salt=6146295757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31194) running   Transform()
2024-10-22 21:49:03,401 - INFO - Connect to DWH - SUCCESS
2024-10-22 21:49:03,403 - INFO - Read Transform Query - SUCCESS
2024-10-22 21:49:03,403 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 21:49:03,593 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 21:49:05,316 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 21:49:05,538 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 21:49:05,580 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 21:49:13,695 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 21:54:38,324 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 21:54:45,035 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 21:54:45,045 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 21:54:45,054 - ERROR - Transform Tables - FAILED
2024-10-22 21:54:45,054 - ERROR - [pid 31194] Worker Worker(salt=6146295757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31194) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedFunction: function age(integer) does not exist
LINE 27:     EXTRACT(DAY FROM AGE(os.date_actual - op.date_actual)) A...
                              ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 142, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedFunction) function age(integer) does not exist
LINE 27:     EXTRACT(DAY FROM AGE(os.date_actual - op.date_actual)) A...
                              ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[SQL: INSERT INTO final.fct_order_delivery(
    -- delivery_id is generated by UUID when create the table
    order_id,
    customer_id,
    seller_id,
    order_received_date,
    process_date,
    success_date,
    estimated_date,
    day_process,
    day_success
)

SELECT
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_actual AS order_received_date,
    op.date_actual AS process_date,
    os.date_actual AS success_date,
    ed.date_actual AS estimated_date,

    -- Calculate day process using AGE function to subtract dates
    EXTRACT(DAY FROM AGE(op.date_actual, oa.date_actual)) AS day_process,

    -- Calculate day success
    EXTRACT(DAY FROM AGE(os.date_actual - op.date_actual)) AS day_success

FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date oa ON TO_DATE(o.order_approved_at, 'YYYY-MM-DD') = oa.date_actual
JOIN
    final.dim_date op ON TO_DATE(o.order_delivered_carrier_date, 'YYYY-MM-DD') = op.date_actual
JOIN
    final.dim_date os ON TO_DATE(o.order_delivered_customer_date, 'YYYY-MM-DD') = os.date_actual
JOIN
    final.dim_date ed ON TO_DATE(o.order_estimated_delivery_date, 'YYYY-MM-DD') = ed.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id
GROUP BY 
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_actual,
    op.date_actual,
    os.date_actual,
    ed.date_actual 

ON CONFLICT(delivery_id, customer_id, seller_id, order_received_date)
DO UPDATE SET
    process_date = EXCLUDED.process_date,
    success_date = EXCLUDED.success_date,
    estimated_date = EXCLUDED.estimated_date,
    day_process = EXCLUDED.day_process,
    day_success = EXCLUDED.day_success,
    updated_at = CASE WHEN
                        final.fct_order_delivery.process_date <> EXCLUDED.process_date
                        OR final.fct_order_delivery.success_date <> EXCLUDED.success_date
                        OR final.fct_order_delivery.estimated_date <> EXCLUDED.estimated_date
                        OR final.fct_order_delivery.day_process <> EXCLUDED.day_process
                        OR final.fct_order_delivery.day_success <> EXCLUDED.day_success
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_delivery.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 21:54:45,075 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 21:54:45,086 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 21:54:45,087 - DEBUG - Asking scheduler for work...
2024-10-22 21:54:45,088 - DEBUG - Done
2024-10-22 21:54:45,088 - DEBUG - There are no more tasks to run at this time
2024-10-22 21:54:45,088 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 21:54:45,089 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 21:54:45,089 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 21:54:45,089 - INFO - Worker Worker(salt=6146295757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=31194) was stopped. Shutting down Keep-Alive thread
2024-10-22 21:54:45,093 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 22:16:31,848 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 22:16:32,019 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 22:16:32,640 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 22:16:32,667 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 22:16:32,981 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 22:16:32,986 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 22:16:33,997 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 22:16:35,147 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 22:16:35,787 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 22:16:36,748 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 22:16:36,748 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 22:16:36,759 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 22:16:36,777 - INFO - [pid 45253] Worker Worker(salt=4466386513, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45253) done      Extract()
2024-10-22 22:16:36,778 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:16:36,780 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 22:16:36,781 - DEBUG - Asking scheduler for work...
2024-10-22 22:16:36,782 - DEBUG - Pending tasks: 2
2024-10-22 22:16:36,782 - INFO - [pid 45253] Worker Worker(salt=4466386513, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45253) running   Load()
2024-10-22 22:16:36,784 - INFO - Read Load Query - SUCCESS
2024-10-22 22:16:37,956 - INFO - Read Extracted Data - SUCCESS
2024-10-22 22:16:37,957 - INFO - Connect to DWH - SUCCESS
2024-10-22 22:16:38,444 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 22:16:38,445 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 22:17:08,090 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 22:17:41,651 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 22:17:41,653 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 22:17:41,693 - INFO - [pid 45253] Worker Worker(salt=4466386513, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45253) done      Load()
2024-10-22 22:17:41,693 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:17:41,697 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 22:17:41,697 - DEBUG - Asking scheduler for work...
2024-10-22 22:17:41,698 - DEBUG - Pending tasks: 1
2024-10-22 22:17:41,699 - INFO - [pid 45253] Worker Worker(salt=4466386513, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45253) running   Transform()
2024-10-22 22:17:41,700 - INFO - Connect to DWH - SUCCESS
2024-10-22 22:17:41,702 - INFO - Read Transform Query - SUCCESS
2024-10-22 22:17:41,702 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 22:17:41,949 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 22:17:44,673 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 22:17:45,269 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 22:17:45,334 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 22:17:57,256 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 22:23:18,492 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 22:23:23,650 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 22:23:23,657 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 22:23:23,663 - ERROR - Transform Tables - FAILED
2024-10-22 22:23:23,663 - ERROR - [pid 45253] Worker Worker(salt=4466386513, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45253) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedFunction: function age(integer) does not exist
LINE 27:     EXTRACT(DAY FROM AGE(os.date_actual - op.date_actual)) A...
                              ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 142, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedFunction) function age(integer) does not exist
LINE 27:     EXTRACT(DAY FROM AGE(os.date_actual - op.date_actual)) A...
                              ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[SQL: INSERT INTO final.fct_order_delivery(
    -- delivery_id is generated by UUID when create the table
    order_id,
    customer_id,
    seller_id,
    order_received_date,
    process_date,
    success_date,
    estimated_date,
    day_process,
    day_success
)

SELECT
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_actual AS order_received_date,
    op.date_actual AS process_date,
    os.date_actual AS success_date,
    ed.date_actual AS estimated_date,

    -- Calculate day process using AGE function to subtract dates
    EXTRACT(DAY FROM AGE(op.date_actual, oa.date_actual)) AS day_process,

    -- Calculate day success
    EXTRACT(DAY FROM AGE(os.date_actual - op.date_actual)) AS day_success

FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date oa ON TO_DATE(o.order_approved_at, 'YYYY-MM-DD') = oa.date_actual
JOIN
    final.dim_date op ON TO_DATE(o.order_delivered_carrier_date, 'YYYY-MM-DD') = op.date_actual
JOIN
    final.dim_date os ON TO_DATE(o.order_delivered_customer_date, 'YYYY-MM-DD') = os.date_actual
JOIN
    final.dim_date ed ON TO_DATE(o.order_estimated_delivery_date, 'YYYY-MM-DD') = ed.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id
GROUP BY 
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_actual,
    op.date_actual,
    os.date_actual,
    ed.date_actual 

ON CONFLICT(delivery_id, customer_id, seller_id, order_received_date)
DO UPDATE SET
    process_date = EXCLUDED.process_date,
    success_date = EXCLUDED.success_date,
    estimated_date = EXCLUDED.estimated_date,
    day_process = EXCLUDED.day_process,
    day_success = EXCLUDED.day_success,
    updated_at = CASE WHEN
                        final.fct_order_delivery.process_date <> EXCLUDED.process_date
                        OR final.fct_order_delivery.success_date <> EXCLUDED.success_date
                        OR final.fct_order_delivery.estimated_date <> EXCLUDED.estimated_date
                        OR final.fct_order_delivery.day_process <> EXCLUDED.day_process
                        OR final.fct_order_delivery.day_success <> EXCLUDED.day_success
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_delivery.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 22:23:23,685 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:23:23,695 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 22:23:23,695 - DEBUG - Asking scheduler for work...
2024-10-22 22:23:23,697 - DEBUG - Done
2024-10-22 22:23:23,697 - DEBUG - There are no more tasks to run at this time
2024-10-22 22:23:23,697 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 22:23:23,697 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 22:23:23,697 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 22:23:23,697 - INFO - Worker Worker(salt=4466386513, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45253) was stopped. Shutting down Keep-Alive thread
2024-10-22 22:23:23,701 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 22:35:10,904 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 22:35:11,120 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 22:35:12,037 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 22:35:12,074 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 22:35:12,527 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 22:35:12,542 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 22:35:13,787 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 22:35:15,524 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 22:35:16,151 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 22:35:16,974 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 22:35:16,974 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 22:35:16,978 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 22:35:16,995 - INFO - [pid 54973] Worker Worker(salt=1666702593, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54973) done      Extract()
2024-10-22 22:35:16,997 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:35:17,000 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 22:35:17,000 - DEBUG - Asking scheduler for work...
2024-10-22 22:35:17,002 - DEBUG - Pending tasks: 2
2024-10-22 22:35:17,002 - INFO - [pid 54973] Worker Worker(salt=1666702593, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54973) running   Load()
2024-10-22 22:35:17,004 - INFO - Read Load Query - SUCCESS
2024-10-22 22:35:18,186 - INFO - Read Extracted Data - SUCCESS
2024-10-22 22:35:18,187 - INFO - Connect to DWH - SUCCESS
2024-10-22 22:35:18,573 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 22:35:18,573 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 22:35:46,237 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 22:36:14,325 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 22:36:14,330 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 22:36:14,486 - INFO - [pid 54973] Worker Worker(salt=1666702593, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54973) done      Load()
2024-10-22 22:36:14,487 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:36:14,491 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 22:36:14,492 - DEBUG - Asking scheduler for work...
2024-10-22 22:36:14,498 - DEBUG - Pending tasks: 1
2024-10-22 22:36:14,498 - INFO - [pid 54973] Worker Worker(salt=1666702593, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54973) running   Transform()
2024-10-22 22:36:14,501 - INFO - Connect to DWH - SUCCESS
2024-10-22 22:36:14,504 - INFO - Read Transform Query - SUCCESS
2024-10-22 22:36:14,504 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 22:36:14,729 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 22:36:17,042 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 22:36:17,420 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 22:36:17,489 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 22:36:28,026 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 22:42:00,698 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 22:42:08,546 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 22:42:08,574 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 22:42:08,655 - ERROR - Transform Tables - FAILED
2024-10-22 22:42:08,658 - ERROR - [pid 54973] Worker Worker(salt=1666702593, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54973) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedFunction: function pg_catalog.extract(unknown, integer) does not exist
LINE 24:     EXTRACT(DAY FROM (TO_DATE(op.date_id::text, 'YYYYMMDD') ...
             ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 142, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedFunction) function pg_catalog.extract(unknown, integer) does not exist
LINE 24:     EXTRACT(DAY FROM (TO_DATE(op.date_id::text, 'YYYYMMDD') ...
             ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[SQL: INSERT INTO final.fct_order_delivery(
    -- delivery_id is generated by UUID when create the table
    order_id,
    customer_id,
    seller_id,
    order_received_date,
    process_date,
    success_date,
    estimated_date,
    day_process,
    day_success
)

SELECT
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_id AS order_received_date,
    op.date_id AS process_date,
    os.date_id AS success_date,
    ed.date_id AS estimated_date,

    -- Calculate day process using AGE function to subtract dates
    EXTRACT(DAY FROM (TO_DATE(op.date_id::text, 'YYYYMMDD') - TO_DATE(oa.date_id::text, 'YYYYMMDD'))) AS day_process,

    -- Calculate day success
    EXTRACT(DAY FROM (TO_DATE(os.date_id::text, 'YYYYMMDD') - TO_DATE(op.date_id::text, 'YYYYMMDD'))) AS day_success

FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date oa ON TO_DATE(o.order_approved_at, 'YYYY-MM-DD') = oa.date_actual
JOIN
    final.dim_date op ON TO_DATE(o.order_delivered_carrier_date, 'YYYY-MM-DD') = op.date_actual
JOIN
    final.dim_date os ON TO_DATE(o.order_delivered_customer_date, 'YYYY-MM-DD') = os.date_actual
JOIN
    final.dim_date ed ON TO_DATE(o.order_estimated_delivery_date, 'YYYY-MM-DD') = ed.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id
GROUP BY 
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_id,
    op.date_id,
    os.date_id,
    ed.date_id 

ON CONFLICT(delivery_id, customer_id, seller_id, order_received_date)
DO UPDATE SET
    process_date = EXCLUDED.process_date,
    success_date = EXCLUDED.success_date,
    estimated_date = EXCLUDED.estimated_date,
    day_process = EXCLUDED.day_process,
    day_success = EXCLUDED.day_success,
    updated_at = CASE WHEN
                        final.fct_order_delivery.process_date <> EXCLUDED.process_date
                        OR final.fct_order_delivery.success_date <> EXCLUDED.success_date
                        OR final.fct_order_delivery.estimated_date <> EXCLUDED.estimated_date
                        OR final.fct_order_delivery.day_process <> EXCLUDED.day_process
                        OR final.fct_order_delivery.day_success <> EXCLUDED.day_success
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_delivery.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 22:42:08,732 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:42:08,773 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 22:42:08,773 - DEBUG - Asking scheduler for work...
2024-10-22 22:42:08,776 - DEBUG - Done
2024-10-22 22:42:08,776 - DEBUG - There are no more tasks to run at this time
2024-10-22 22:42:08,777 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 22:42:08,777 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 22:42:08,777 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 22:42:08,778 - INFO - Worker Worker(salt=1666702593, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=54973) was stopped. Shutting down Keep-Alive thread
2024-10-22 22:42:08,793 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 22:46:34,901 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 22:46:35,054 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 22:46:35,639 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 22:46:35,681 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 22:46:35,968 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 22:46:35,974 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 22:46:37,006 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 22:46:38,238 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 22:46:38,936 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 22:46:39,800 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 22:46:39,800 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 22:46:39,803 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 22:46:39,819 - INFO - [pid 61353] Worker Worker(salt=2505517506, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=61353) done      Extract()
2024-10-22 22:46:39,821 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:46:39,824 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 22:46:39,824 - DEBUG - Asking scheduler for work...
2024-10-22 22:46:39,827 - DEBUG - Pending tasks: 2
2024-10-22 22:46:39,827 - INFO - [pid 61353] Worker Worker(salt=2505517506, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=61353) running   Load()
2024-10-22 22:46:39,830 - INFO - Read Load Query - SUCCESS
2024-10-22 22:46:41,215 - INFO - Read Extracted Data - SUCCESS
2024-10-22 22:46:41,216 - INFO - Connect to DWH - SUCCESS
2024-10-22 22:46:41,675 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 22:46:41,675 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 22:47:08,202 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 22:47:42,276 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 22:47:42,278 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 22:47:42,331 - INFO - [pid 61353] Worker Worker(salt=2505517506, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=61353) done      Load()
2024-10-22 22:47:42,331 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:47:42,335 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 22:47:42,335 - DEBUG - Asking scheduler for work...
2024-10-22 22:47:42,337 - DEBUG - Pending tasks: 1
2024-10-22 22:47:42,337 - INFO - [pid 61353] Worker Worker(salt=2505517506, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=61353) running   Transform()
2024-10-22 22:47:42,338 - INFO - Connect to DWH - SUCCESS
2024-10-22 22:47:42,341 - INFO - Read Transform Query - SUCCESS
2024-10-22 22:47:42,341 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 22:47:42,565 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 22:47:45,331 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 22:47:45,758 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 22:47:45,809 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 22:47:57,175 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 22:53:24,240 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 22:53:29,860 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 22:53:29,871 - ERROR - Transform to All Dimensions and Fact Tables - FAILED
2024-10-22 22:53:29,898 - ERROR - Transform Tables - FAILED
2024-10-22 22:53:29,899 - ERROR - [pid 61353] Worker Worker(salt=2505517506, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=61353) failed    Transform()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UndefinedFunction: function pg_catalog.extract(unknown, integer) does not exist
LINE 24:     EXTRACT(DAY FROM (TO_DATE(op.date_id::text, 'YYYYMMDD') ...
             ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 142, in run
    session.execute(query)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2200, in _execute_internal
    result = conn.execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedFunction) function pg_catalog.extract(unknown, integer) does not exist
LINE 24:     EXTRACT(DAY FROM (TO_DATE(op.date_id::text, 'YYYYMMDD') ...
             ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[SQL: INSERT INTO final.fct_order_delivery(
    -- delivery_id is generated by UUID when create the table
    order_id,
    customer_id,
    seller_id,
    order_received_date,
    process_date,
    success_date,
    estimated_date,
    day_process,
    day_success
)

SELECT
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_id AS order_received_date,
    op.date_id AS process_date,
    os.date_id AS success_date,
    ed.date_id AS estimated_date,

    -- Calculate day process using AGE function to subtract dates
    EXTRACT(DAY FROM (TO_DATE(op.date_id::text, 'YYYYMMDD') - TO_DATE(oa.date_id::text, 'YYYYMMDD'))) AS day_process,

    -- Calculate day success
    EXTRACT(DAY FROM (TO_DATE(os.date_id::text, 'YYYYMMDD') - TO_DATE(op.date_id::text, 'YYYYMMDD'))) AS day_success

FROM
    stg.orders o
JOIN
    stg.order_items oi ON o.order_id = oi.order_id
JOIN
    final.dim_customers dc ON o.customer_id = dc.customer_nk
JOIN
    final.dim_sellers ds ON oi.seller_id = ds.seller_nk
JOIN
    final.dim_date oa ON TO_DATE(o.order_approved_at, 'YYYY-MM-DD') = oa.date_actual
JOIN
    final.dim_date op ON TO_DATE(o.order_delivered_carrier_date, 'YYYY-MM-DD') = op.date_actual
JOIN
    final.dim_date os ON TO_DATE(o.order_delivered_customer_date, 'YYYY-MM-DD') = os.date_actual
JOIN
    final.dim_date ed ON TO_DATE(o.order_estimated_delivery_date, 'YYYY-MM-DD') = ed.date_actual
JOIN
    final.fct_orders fo ON o.order_id = fo.dd_order_id
GROUP BY 
    fo.order_id,
    dc.customer_id,
    ds.seller_id,
    oa.date_id,
    op.date_id,
    os.date_id,
    ed.date_id 

ON CONFLICT(delivery_id, customer_id, seller_id, order_received_date)
DO UPDATE SET
    process_date = EXCLUDED.process_date,
    success_date = EXCLUDED.success_date,
    estimated_date = EXCLUDED.estimated_date,
    day_process = EXCLUDED.day_process,
    day_success = EXCLUDED.day_success,
    updated_at = CASE WHEN
                        final.fct_order_delivery.process_date <> EXCLUDED.process_date
                        OR final.fct_order_delivery.success_date <> EXCLUDED.success_date
                        OR final.fct_order_delivery.estimated_date <> EXCLUDED.estimated_date
                        OR final.fct_order_delivery.day_process <> EXCLUDED.day_process
                        OR final.fct_order_delivery.day_success <> EXCLUDED.day_success
                THEN
                        CURRENT_TIMESTAMP
                ELSE
                        final.fct_order_delivery.updated_at
                END;]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/transform.py", line 194, in run
    raise Exception('Failed Transforming Tables')
Exception: Failed Transforming Tables
2024-10-22 22:53:29,925 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:53:29,939 - INFO - Informed scheduler that task   Transform__99914b932b   has status   FAILED
2024-10-22 22:53:29,939 - DEBUG - Asking scheduler for work...
2024-10-22 22:53:29,941 - DEBUG - Done
2024-10-22 22:53:29,941 - DEBUG - There are no more tasks to run at this time
2024-10-22 22:53:29,941 - DEBUG - There are 1 pending tasks possibly being run by other workers
2024-10-22 22:53:29,941 - DEBUG - There are 1 pending tasks unique to this worker
2024-10-22 22:53:29,942 - DEBUG - There are 1 pending tasks last scheduled by this worker
2024-10-22 22:53:29,942 - INFO - Worker Worker(salt=2505517506, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=61353) was stopped. Shutting down Keep-Alive thread
2024-10-22 22:53:29,946 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 failed:
    - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-22 22:59:40,551 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-22 22:59:40,742 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-22 22:59:41,528 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-22 22:59:41,560 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-22 22:59:42,033 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-22 22:59:42,039 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-22 22:59:43,243 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-22 22:59:44,421 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-22 22:59:45,059 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-22 22:59:45,931 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-22 22:59:45,931 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-22 22:59:45,934 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-22 22:59:45,947 - INFO - [pid 68522] Worker Worker(salt=2723736079, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=68522) done      Extract()
2024-10-22 22:59:45,949 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 22:59:45,951 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-22 22:59:45,951 - DEBUG - Asking scheduler for work...
2024-10-22 22:59:45,953 - DEBUG - Pending tasks: 2
2024-10-22 22:59:45,953 - INFO - [pid 68522] Worker Worker(salt=2723736079, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=68522) running   Load()
2024-10-22 22:59:45,957 - INFO - Read Load Query - SUCCESS
2024-10-22 22:59:46,925 - INFO - Read Extracted Data - SUCCESS
2024-10-22 22:59:46,926 - INFO - Connect to DWH - SUCCESS
2024-10-22 22:59:47,393 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-22 22:59:47,393 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-22 23:00:14,965 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-22 23:00:43,770 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-22 23:00:43,776 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-22 23:00:43,820 - INFO - [pid 68522] Worker Worker(salt=2723736079, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=68522) done      Load()
2024-10-22 23:00:43,820 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 23:00:43,823 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-22 23:00:43,823 - DEBUG - Asking scheduler for work...
2024-10-22 23:00:43,825 - DEBUG - Pending tasks: 1
2024-10-22 23:00:43,825 - INFO - [pid 68522] Worker Worker(salt=2723736079, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=68522) running   Transform()
2024-10-22 23:00:43,826 - INFO - Connect to DWH - SUCCESS
2024-10-22 23:00:43,828 - INFO - Read Transform Query - SUCCESS
2024-10-22 23:00:43,828 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-22 23:00:44,037 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-22 23:00:45,689 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-22 23:00:45,990 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-22 23:00:46,061 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-22 23:00:54,127 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-22 23:06:24,011 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-22 23:06:31,058 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-22 23:06:38,918 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-22 23:06:44,603 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-22 23:06:44,618 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-22 23:06:44,712 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-22 23:06:44,716 - INFO - [pid 68522] Worker Worker(salt=2723736079, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=68522) done      Transform()
2024-10-22 23:06:44,729 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-22 23:06:44,744 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-22 23:06:44,745 - DEBUG - Asking scheduler for work...
2024-10-22 23:06:44,749 - DEBUG - Done
2024-10-22 23:06:44,749 - DEBUG - There are no more tasks to run at this time
2024-10-22 23:06:44,750 - INFO - Worker Worker(salt=2723736079, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=68522) was stopped. Shutting down Keep-Alive thread
2024-10-22 23:06:44,767 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-23 01:49:58,481 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-23 01:49:58,856 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-23 01:49:59,795 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-23 01:49:59,850 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-23 01:50:00,193 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-23 01:50:00,200 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-23 01:50:01,373 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-23 01:50:02,740 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-23 01:50:03,481 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-23 01:50:04,350 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-23 01:50:04,350 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-23 01:50:04,365 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-23 01:50:04,378 - INFO - [pid 62800] Worker Worker(salt=7148384588, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=62800) done      Extract()
2024-10-23 01:50:04,380 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-23 01:50:04,385 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-23 01:50:04,385 - DEBUG - Asking scheduler for work...
2024-10-23 01:50:04,388 - DEBUG - Done
2024-10-23 01:50:04,388 - DEBUG - There are no more tasks to run at this time
2024-10-23 01:50:04,388 - INFO - Worker Worker(salt=7148384588, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=62800) was stopped. Shutting down Keep-Alive thread
2024-10-23 01:50:04,389 - INFO - 
===== Luigi Execution Summary =====

Scheduled 1 tasks of which:
* 1 ran successfully:
    - 1 Extract()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-23 02:24:11,937 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-23 02:24:12,445 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-23 02:24:13,357 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-23 02:24:13,400 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-23 02:24:13,811 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-23 02:24:13,822 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-23 02:24:14,945 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-23 02:24:16,025 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-23 02:24:16,839 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-23 02:24:17,759 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-23 02:24:17,759 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-23 02:24:17,769 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-23 02:24:17,781 - INFO - [pid 80765] Worker Worker(salt=9724837151, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=80765) done      Extract()
2024-10-23 02:24:17,782 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-23 02:24:17,785 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-23 02:24:17,786 - DEBUG - Asking scheduler for work...
2024-10-23 02:24:17,787 - DEBUG - Pending tasks: 2
2024-10-23 02:24:17,787 - INFO - [pid 80765] Worker Worker(salt=9724837151, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=80765) running   Load()
2024-10-23 02:24:17,792 - INFO - Read Load Query - SUCCESS
2024-10-23 02:24:19,060 - INFO - Read Extracted Data - SUCCESS
2024-10-23 02:24:19,061 - INFO - Connect to DWH - SUCCESS
2024-10-23 02:24:19,868 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-23 02:24:19,869 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-23 02:24:47,397 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-23 02:25:01,639 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-23 02:25:01,643 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-23 02:25:01,675 - INFO - [pid 80765] Worker Worker(salt=9724837151, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=80765) done      Load()
2024-10-23 02:25:01,676 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-23 02:25:01,679 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-23 02:25:01,679 - DEBUG - Asking scheduler for work...
2024-10-23 02:25:01,681 - DEBUG - Pending tasks: 1
2024-10-23 02:25:01,681 - INFO - [pid 80765] Worker Worker(salt=9724837151, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=80765) running   Transform()
2024-10-23 02:25:01,682 - INFO - Connect to DWH - SUCCESS
2024-10-23 02:25:01,686 - INFO - Read Transform Query - SUCCESS
2024-10-23 02:25:01,687 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-23 02:25:01,838 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-23 02:25:03,411 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-23 02:25:03,678 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-23 02:25:03,721 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-23 02:25:11,294 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-23 02:30:09,187 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-23 02:30:14,179 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-23 02:30:21,204 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-23 02:30:25,787 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-23 02:30:25,793 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-23 02:30:25,799 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-23 02:30:25,799 - INFO - [pid 80765] Worker Worker(salt=9724837151, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=80765) done      Transform()
2024-10-23 02:30:25,799 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-23 02:30:25,803 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-23 02:30:25,803 - DEBUG - Asking scheduler for work...
2024-10-23 02:30:25,805 - DEBUG - Done
2024-10-23 02:30:25,806 - DEBUG - There are no more tasks to run at this time
2024-10-23 02:30:25,806 - INFO - Worker Worker(salt=9724837151, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=80765) was stopped. Shutting down Keep-Alive thread
2024-10-23 02:30:25,811 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-23 02:46:26,120 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-23 02:46:26,340 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-23 02:46:27,055 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-23 02:46:27,088 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-23 02:46:27,404 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-23 02:46:27,410 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-23 02:46:28,391 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-23 02:46:29,473 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-23 02:46:30,076 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-23 02:46:30,880 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-23 02:46:30,880 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-23 02:46:30,884 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-23 02:46:30,897 - INFO - [pid 91620] Worker Worker(salt=7762490647, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=91620) done      Extract()
2024-10-23 02:46:30,899 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-23 02:46:30,902 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-23 02:46:30,902 - DEBUG - Asking scheduler for work...
2024-10-23 02:46:30,903 - DEBUG - Pending tasks: 2
2024-10-23 02:46:30,903 - INFO - [pid 91620] Worker Worker(salt=7762490647, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=91620) running   Load()
2024-10-23 02:46:30,909 - INFO - Read Load Query - SUCCESS
2024-10-23 02:46:31,887 - INFO - Read Extracted Data - SUCCESS
2024-10-23 02:46:31,888 - INFO - Connect to DWH - SUCCESS
2024-10-23 02:46:32,261 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-23 02:46:32,261 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-23 02:46:53,999 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-23 02:47:05,772 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-23 02:47:05,774 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-23 02:47:05,803 - INFO - [pid 91620] Worker Worker(salt=7762490647, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=91620) done      Load()
2024-10-23 02:47:05,804 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-23 02:47:05,806 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-23 02:47:05,806 - DEBUG - Asking scheduler for work...
2024-10-23 02:47:05,808 - DEBUG - Pending tasks: 1
2024-10-23 02:47:05,808 - INFO - [pid 91620] Worker Worker(salt=7762490647, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=91620) running   Transform()
2024-10-23 02:47:05,809 - INFO - Connect to DWH - SUCCESS
2024-10-23 02:47:05,812 - INFO - Read Transform Query - SUCCESS
2024-10-23 02:47:05,813 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-23 02:47:05,944 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-23 02:47:07,185 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-23 02:47:07,434 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-23 02:47:07,479 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-23 02:47:13,769 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-23 02:52:07,747 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-23 02:52:12,061 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-23 02:52:18,558 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-23 02:52:22,562 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-23 02:52:22,568 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-23 02:52:22,571 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-23 02:52:22,571 - INFO - [pid 91620] Worker Worker(salt=7762490647, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=91620) done      Transform()
2024-10-23 02:52:22,571 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-23 02:52:22,574 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-23 02:52:22,574 - DEBUG - Asking scheduler for work...
2024-10-23 02:52:22,576 - DEBUG - Done
2024-10-23 02:52:22,576 - DEBUG - There are no more tasks to run at this time
2024-10-23 02:52:22,576 - INFO - Worker Worker(salt=7762490647, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=91620) was stopped. Shutting down Keep-Alive thread
2024-10-23 02:52:22,578 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-24 12:36:08,760 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 12:36:08,943 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 12:36:09,828 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 12:36:09,855 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 12:36:10,176 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 12:36:10,185 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 12:36:11,450 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 12:36:13,474 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 12:36:14,167 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 12:36:15,071 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 12:36:15,071 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 12:36:15,074 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 12:36:15,087 - INFO - [pid 6922] Worker Worker(salt=7811926285, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=6922) done      Extract()
2024-10-24 12:36:15,089 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 12:36:15,093 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 12:36:15,093 - DEBUG - Asking scheduler for work...
2024-10-24 12:36:15,094 - DEBUG - Pending tasks: 2
2024-10-24 12:36:15,094 - INFO - [pid 6922] Worker Worker(salt=7811926285, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=6922) running   Load()
2024-10-24 12:36:15,098 - INFO - Read Load Query - SUCCESS
2024-10-24 12:36:16,448 - INFO - Read Extracted Data - SUCCESS
2024-10-24 12:36:16,450 - INFO - Connect to DWH - SUCCESS
2024-10-24 12:36:16,796 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 12:36:16,797 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 12:36:39,615 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-24 12:36:51,987 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-24 12:36:51,989 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-24 12:36:52,021 - INFO - [pid 6922] Worker Worker(salt=7811926285, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=6922) done      Load()
2024-10-24 12:36:52,021 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 12:36:52,024 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-24 12:36:52,024 - DEBUG - Asking scheduler for work...
2024-10-24 12:36:52,025 - DEBUG - Pending tasks: 1
2024-10-24 12:36:52,026 - INFO - [pid 6922] Worker Worker(salt=7811926285, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=6922) running   Transform()
2024-10-24 12:36:52,027 - INFO - Connect to DWH - SUCCESS
2024-10-24 12:36:52,031 - INFO - Read Transform Query - SUCCESS
2024-10-24 12:36:52,032 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 12:36:52,204 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 12:36:53,507 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 12:36:53,785 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 12:36:53,837 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 12:37:01,422 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 12:42:15,730 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-24 12:42:21,345 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-24 12:42:29,111 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-24 12:42:34,205 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-24 12:42:34,213 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-24 12:42:34,238 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-24 12:42:34,240 - INFO - [pid 6922] Worker Worker(salt=7811926285, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=6922) done      Transform()
2024-10-24 12:42:34,242 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 12:42:34,248 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-24 12:42:34,248 - DEBUG - Asking scheduler for work...
2024-10-24 12:42:34,251 - DEBUG - Done
2024-10-24 12:42:34,251 - DEBUG - There are no more tasks to run at this time
2024-10-24 12:42:34,251 - INFO - Worker Worker(salt=7811926285, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=6922) was stopped. Shutting down Keep-Alive thread
2024-10-24 12:42:34,257 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-24 12:55:35,849 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 12:55:36,056 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 12:55:36,962 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 12:55:36,998 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 12:55:37,406 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 12:55:37,413 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 12:55:38,966 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 12:55:40,526 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 12:55:41,367 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 12:55:42,310 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 12:55:42,310 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 12:55:42,323 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 12:55:42,343 - INFO - [pid 17252] Worker Worker(salt=561344191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=17252) done      Extract()
2024-10-24 12:55:42,346 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 12:55:42,350 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 12:55:42,350 - DEBUG - Asking scheduler for work...
2024-10-24 12:55:42,354 - DEBUG - Pending tasks: 2
2024-10-24 12:55:42,355 - INFO - [pid 17252] Worker Worker(salt=561344191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=17252) running   Load()
2024-10-24 12:55:42,392 - INFO - Read Load Query - SUCCESS
2024-10-24 12:55:43,846 - INFO - Read Extracted Data - SUCCESS
2024-10-24 12:55:43,848 - INFO - Connect to DWH - SUCCESS
2024-10-24 12:55:44,185 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 12:55:44,185 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 12:56:11,841 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-24 12:56:25,359 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-24 12:56:25,396 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-24 12:56:25,461 - INFO - [pid 17252] Worker Worker(salt=561344191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=17252) done      Load()
2024-10-24 12:56:25,464 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 12:56:25,470 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-24 12:56:25,472 - DEBUG - Asking scheduler for work...
2024-10-24 12:56:25,476 - DEBUG - Pending tasks: 1
2024-10-24 12:56:25,477 - INFO - [pid 17252] Worker Worker(salt=561344191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=17252) running   Transform()
2024-10-24 12:56:25,482 - INFO - Connect to DWH - SUCCESS
2024-10-24 12:56:25,488 - INFO - Read Transform Query - SUCCESS
2024-10-24 12:56:25,488 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 12:56:25,685 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 12:56:27,084 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 12:56:27,301 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 12:56:27,357 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 12:56:36,582 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 13:02:26,344 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-24 13:02:32,747 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-24 13:02:40,407 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-24 13:02:45,081 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-24 13:02:45,088 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-24 13:02:45,110 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-24 13:02:45,111 - INFO - [pid 17252] Worker Worker(salt=561344191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=17252) done      Transform()
2024-10-24 13:02:45,116 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 13:02:45,122 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-24 13:02:45,123 - DEBUG - Asking scheduler for work...
2024-10-24 13:02:45,128 - DEBUG - Done
2024-10-24 13:02:45,130 - DEBUG - There are no more tasks to run at this time
2024-10-24 13:02:45,132 - INFO - Worker Worker(salt=561344191, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=17252) was stopped. Shutting down Keep-Alive thread
2024-10-24 13:02:45,145 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-24 13:05:38,158 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 13:05:38,371 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 13:05:39,257 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 13:05:39,293 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 13:05:39,609 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 13:05:39,616 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 13:05:40,710 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 13:05:41,815 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 13:05:42,489 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 13:05:43,312 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 13:05:43,312 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 13:05:43,314 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 13:05:43,330 - INFO - [pid 26007] Worker Worker(salt=1922416007, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=26007) done      Extract()
2024-10-24 13:05:43,331 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 13:05:43,334 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 13:05:43,334 - DEBUG - Asking scheduler for work...
2024-10-24 13:05:43,336 - DEBUG - Pending tasks: 2
2024-10-24 13:05:43,336 - INFO - [pid 26007] Worker Worker(salt=1922416007, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=26007) running   Load()
2024-10-24 13:05:43,341 - INFO - Read Load Query - SUCCESS
2024-10-24 13:05:44,459 - INFO - Read Extracted Data - SUCCESS
2024-10-24 13:05:44,462 - INFO - Connect to DWH - SUCCESS
2024-10-24 13:05:44,837 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 13:05:44,837 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 13:05:50,327 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-24 13:05:50,333 - INFO - Retrying attempt 2 of 3 (max)
2024-10-24 13:05:50,333 - INFO - Wait for 30 seconds
2024-10-24 13:06:07,462 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-24 13:06:49,164 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 13:06:49,269 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 13:06:49,756 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 13:06:49,787 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 13:06:50,032 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 13:06:50,037 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 13:06:50,747 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 13:06:51,717 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 13:06:52,243 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 13:06:52,865 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 13:06:52,865 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 13:06:52,867 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 13:06:52,889 - INFO - [pid 27740] Worker Worker(salt=3448857282, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27740) done      Extract()
2024-10-24 13:06:52,892 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 13:06:52,898 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 13:06:52,899 - DEBUG - Asking scheduler for work...
2024-10-24 13:06:52,902 - DEBUG - Pending tasks: 2
2024-10-24 13:06:52,902 - INFO - [pid 27740] Worker Worker(salt=3448857282, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27740) running   Load()
2024-10-24 13:06:52,906 - INFO - Read Load Query - SUCCESS
2024-10-24 13:06:54,088 - INFO - Read Extracted Data - SUCCESS
2024-10-24 13:06:54,089 - INFO - Connect to DWH - SUCCESS
2024-10-24 13:06:54,384 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 13:06:54,384 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 13:07:14,913 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-24 13:07:28,781 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-24 13:07:28,789 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-24 13:07:28,822 - INFO - [pid 27740] Worker Worker(salt=3448857282, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27740) done      Load()
2024-10-24 13:07:28,823 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 13:07:28,825 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-24 13:07:28,825 - DEBUG - Asking scheduler for work...
2024-10-24 13:07:28,827 - DEBUG - Pending tasks: 1
2024-10-24 13:07:28,827 - INFO - [pid 27740] Worker Worker(salt=3448857282, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=27740) running   Transform()
2024-10-24 13:07:28,828 - INFO - Connect to DWH - SUCCESS
2024-10-24 13:07:28,835 - INFO - Read Transform Query - SUCCESS
2024-10-24 13:07:28,835 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 13:07:29,174 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 13:07:32,142 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 13:07:32,786 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 13:07:32,828 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 13:07:41,597 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 13:28:58,625 - INFO - Connect to DWH - SUCCESS
2024-10-24 13:28:58,629 - INFO - Read Transform Query - SUCCESS
2024-10-24 13:28:58,630 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 13:28:58,666 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 13:28:58,668 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 13:28:58,671 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 13:28:58,673 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 13:28:58,680 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 13:28:58,685 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-24 13:28:58,688 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-24 13:28:58,691 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-24 13:28:58,693 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-24 13:28:58,694 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-24 13:28:58,716 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-24 13:28:58,717 - INFO - [pid 45456] Worker Worker(salt=3774450766, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45456) done      Transform()
2024-10-24 13:28:58,720 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 13:28:58,724 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-24 13:28:58,724 - DEBUG - Asking scheduler for work...
2024-10-24 13:28:58,727 - DEBUG - Done
2024-10-24 13:28:58,727 - DEBUG - There are no more tasks to run at this time
2024-10-24 13:28:58,728 - INFO - Worker Worker(salt=3774450766, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45456) was stopped. Shutting down Keep-Alive thread
2024-10-24 13:28:58,729 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 complete ones were encountered:
    - 1 Extract()
    - 1 Load()
* 1 ran successfully:
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-24 13:29:12,170 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 13:29:12,311 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 13:29:12,809 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 13:29:12,830 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 13:29:13,055 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 13:29:13,060 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 13:29:13,797 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 13:29:14,689 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 13:29:15,205 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 13:29:15,868 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 13:29:15,868 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 13:29:15,871 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 13:29:15,891 - INFO - [pid 45636] Worker Worker(salt=3958159300, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45636) done      Extract()
2024-10-24 13:29:15,892 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 13:29:15,896 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 13:29:15,896 - DEBUG - Asking scheduler for work...
2024-10-24 13:29:15,898 - DEBUG - Pending tasks: 2
2024-10-24 13:29:15,899 - INFO - [pid 45636] Worker Worker(salt=3958159300, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45636) running   Load()
2024-10-24 13:29:15,904 - INFO - Read Load Query - SUCCESS
2024-10-24 13:29:16,925 - INFO - Read Extracted Data - SUCCESS
2024-10-24 13:29:16,926 - INFO - Connect to DWH - SUCCESS
2024-10-24 13:29:17,246 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 13:29:17,246 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 13:29:43,574 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-24 13:29:58,042 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-24 13:29:58,045 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-24 13:29:58,075 - INFO - [pid 45636] Worker Worker(salt=3958159300, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45636) done      Load()
2024-10-24 13:29:58,075 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 13:29:58,078 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-24 13:29:58,078 - DEBUG - Asking scheduler for work...
2024-10-24 13:29:58,080 - DEBUG - Pending tasks: 1
2024-10-24 13:29:58,080 - INFO - [pid 45636] Worker Worker(salt=3958159300, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45636) running   Transform()
2024-10-24 13:29:58,081 - INFO - Connect to DWH - SUCCESS
2024-10-24 13:29:58,081 - INFO - Read Transform Query - SUCCESS
2024-10-24 13:29:58,081 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 13:29:58,212 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 13:29:59,997 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 13:30:00,309 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 13:30:00,349 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 13:30:11,026 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 13:30:42,254 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-24 13:30:47,483 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-24 13:30:55,221 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-24 13:30:59,799 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-24 13:30:59,808 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-24 13:30:59,811 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-24 13:30:59,811 - INFO - [pid 45636] Worker Worker(salt=3958159300, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45636) done      Transform()
2024-10-24 13:30:59,811 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 13:30:59,814 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-24 13:30:59,814 - DEBUG - Asking scheduler for work...
2024-10-24 13:30:59,815 - DEBUG - Done
2024-10-24 13:30:59,815 - DEBUG - There are no more tasks to run at this time
2024-10-24 13:30:59,816 - INFO - Worker Worker(salt=3958159300, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=45636) was stopped. Shutting down Keep-Alive thread
2024-10-24 13:30:59,817 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-24 14:11:55,678 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 14:11:56,213 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 14:11:57,978 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 14:11:58,013 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 14:11:58,370 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 14:11:58,379 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 14:12:00,674 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 14:12:02,533 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 14:12:03,620 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 14:12:04,675 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 14:12:04,676 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 14:12:04,708 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 14:12:04,725 - INFO - [pid 70421] Worker Worker(salt=7128586757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=70421) done      Extract()
2024-10-24 14:12:04,726 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 14:12:04,730 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 14:12:04,730 - DEBUG - Asking scheduler for work...
2024-10-24 14:12:04,732 - DEBUG - Pending tasks: 2
2024-10-24 14:12:04,732 - INFO - [pid 70421] Worker Worker(salt=7128586757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=70421) running   Load()
2024-10-24 14:12:04,740 - INFO - Read Load Query - SUCCESS
2024-10-24 14:12:06,148 - INFO - Read Extracted Data - SUCCESS
2024-10-24 14:12:06,151 - INFO - Connect to DWH - SUCCESS
2024-10-24 14:12:06,561 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 14:12:06,561 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 14:13:19,110 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-24 14:13:22,574 - INFO - Retrying attempt 2 of 3 (max)
2024-10-24 14:13:24,385 - INFO - Wait for 30 seconds
2024-10-24 14:14:15,689 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-24 14:14:22,727 - INFO - Retrying attempt 3 of 3 (max)
2024-10-24 14:14:29,903 - INFO - Wait for 30 seconds
2024-10-24 14:19:40,128 - ERROR - LOAD All Tables To olist_dwh - FAILED
2024-10-24 14:19:40,637 - ERROR - LOAD All Tables To DWH - FAILED
2024-10-24 14:19:40,788 - ERROR - [pid 70421] Worker Worker(salt=7128586757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=70421) failed    Load()
Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 204, in run
    order_items.to_sql('order_items',
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/util/_decorators.py", line 333, in wrapper
    return func(*args, **kwargs)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/core/generic.py", line 3084, in to_sql
    return sql.to_sql(
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/io/sql.py", line 841, in to_sql
    with pandasSQL_builder(con, schema=schema, need_transaction=True) as pandas_sql:
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/pandas/io/sql.py", line 1645, in __exit__
    self.exit_stack.close()
  File "/usr/lib/python3.10/contextlib.py", line 584, in close
    self.__exit__(None, None, None)
  File "/usr/lib/python3.10/contextlib.py", line 576, in __exit__
    raise exc_details[1]
  File "/usr/lib/python3.10/contextlib.py", line 561, in __exit__
    if cb(*exc_details):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/util.py", line 146, in __exit__
    with util.safe_reraise():
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/util.py", line 144, in __exit__
    self.commit()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2632, in commit
    self._do_commit()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2737, in _do_commit
    self._connection_commit_impl()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2708, in _connection_commit_impl
    self.connection._commit_impl()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1149, in _commit_impl
    self._handle_dbapi_exception(e, None, None, None, None)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2359, in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1147, in _commit_impl
    self.engine.dialect.do_commit(self.connection)
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 588, in connection
    return self._revalidate_connection()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 680, in _revalidate_connection
    self._invalid_transaction()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 670, in _invalid_transaction
    raise exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 228, in run
    raise Exception('Failed Load Tables To olist_dwh')
Exception: Failed Load Tables To olist_dwh

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 210, in run
    new_deps = self._run_get_new_deps()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/exercise-week-5/lib/python3.10/site-packages/luigi/worker.py", line 138, in _run_get_new_deps
    task_gen = self.task.run()
  File "/home/ricofebrian/data-warehouse-labs/exercise/olist-elt/pipeline/load.py", line 295, in run
    raise Exception('Failed Load Tables To DWH')
Exception: Failed Load Tables To DWH
2024-10-24 14:19:41,694 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 14:19:41,726 - INFO - Informed scheduler that task   Load__99914b932b   has status   FAILED
2024-10-24 14:19:41,727 - DEBUG - Asking scheduler for work...
2024-10-24 14:19:41,731 - DEBUG - Done
2024-10-24 14:19:41,732 - DEBUG - There are no more tasks to run at this time
2024-10-24 14:19:41,732 - DEBUG - There are 2 pending tasks possibly being run by other workers
2024-10-24 14:19:41,732 - DEBUG - There are 2 pending tasks unique to this worker
2024-10-24 14:19:41,732 - DEBUG - There are 2 pending tasks last scheduled by this worker
2024-10-24 14:19:41,732 - INFO - Worker Worker(salt=7128586757, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=70421) was stopped. Shutting down Keep-Alive thread
2024-10-24 14:19:41,748 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 1 ran successfully:
    - 1 Extract()
* 1 failed:
    - 1 Load()
* 1 were left pending, among these:
    * 1 had failed dependencies:
        - 1 Transform()

This progress looks :( because there were failed tasks

===== Luigi Execution Summary =====

2024-10-24 14:19:48,986 - INFO - Connect to DWH - SUCCESS
2024-10-24 14:19:48,991 - INFO - Read Transform Query - SUCCESS
2024-10-24 14:19:48,991 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 14:19:49,397 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 14:19:53,359 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 14:19:53,608 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 14:19:53,698 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 14:20:02,053 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 14:21:10,100 - WARNING - Failed connecting to remote scheduler 'http://localhost:8082'
NoneType: None
2024-10-24 14:21:10,101 - INFO - Retrying attempt 2 of 3 (max)
2024-10-24 14:21:10,101 - INFO - Wait for 30 seconds
2024-10-24 14:24:28,369 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 14:24:28,667 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 14:24:29,309 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 14:24:29,345 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 14:24:29,649 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 14:24:29,662 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 14:24:30,534 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 14:24:31,577 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 14:24:32,167 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 14:24:32,917 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 14:24:32,917 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 14:24:32,923 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 14:24:32,940 - INFO - [pid 76035] Worker Worker(salt=9477442636, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=76035) done      Extract()
2024-10-24 14:24:32,942 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 14:24:32,945 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 14:24:32,945 - DEBUG - Asking scheduler for work...
2024-10-24 14:24:32,947 - DEBUG - Pending tasks: 2
2024-10-24 14:24:32,947 - INFO - [pid 76035] Worker Worker(salt=9477442636, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=76035) running   Load()
2024-10-24 14:24:32,953 - INFO - Read Load Query - SUCCESS
2024-10-24 14:24:34,191 - INFO - Read Extracted Data - SUCCESS
2024-10-24 14:24:34,192 - INFO - Connect to DWH - SUCCESS
2024-10-24 14:24:34,599 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 14:24:34,600 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 14:24:58,832 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-24 14:25:11,305 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-24 14:25:11,366 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-24 14:25:11,420 - INFO - [pid 76035] Worker Worker(salt=9477442636, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=76035) done      Load()
2024-10-24 14:25:11,421 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 14:25:11,428 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-24 14:25:11,429 - DEBUG - Asking scheduler for work...
2024-10-24 14:25:11,435 - DEBUG - Pending tasks: 1
2024-10-24 14:25:11,435 - INFO - [pid 76035] Worker Worker(salt=9477442636, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=76035) running   Transform()
2024-10-24 14:25:11,437 - INFO - Connect to DWH - SUCCESS
2024-10-24 14:25:11,444 - INFO - Read Transform Query - SUCCESS
2024-10-24 14:25:11,445 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 14:25:11,649 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 14:25:13,005 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 14:25:13,197 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 14:25:13,244 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 14:25:19,861 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 14:58:18,875 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 14:58:18,993 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 14:58:19,478 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 14:58:19,501 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 14:58:19,764 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 14:58:19,769 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 14:58:20,553 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 14:58:21,612 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 14:58:22,122 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 14:58:22,812 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 14:58:22,812 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 14:58:22,818 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 14:58:22,838 - INFO - [pid 97187] Worker Worker(salt=7645441895, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=97187) done      Extract()
2024-10-24 14:58:22,841 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 14:58:22,845 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 14:58:22,846 - DEBUG - Asking scheduler for work...
2024-10-24 14:58:22,849 - DEBUG - Pending tasks: 2
2024-10-24 14:58:22,850 - INFO - [pid 97187] Worker Worker(salt=7645441895, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=97187) running   Load()
2024-10-24 14:58:22,856 - INFO - Read Load Query - SUCCESS
2024-10-24 14:58:24,069 - INFO - Read Extracted Data - SUCCESS
2024-10-24 14:58:24,070 - INFO - Connect to DWH - SUCCESS
2024-10-24 14:58:24,378 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 14:58:24,378 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 14:58:49,325 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-24 14:59:01,970 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-24 14:59:02,029 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-24 14:59:02,085 - INFO - [pid 97187] Worker Worker(salt=7645441895, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=97187) done      Load()
2024-10-24 14:59:02,087 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 14:59:02,091 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-24 14:59:02,091 - DEBUG - Asking scheduler for work...
2024-10-24 14:59:02,094 - DEBUG - Pending tasks: 1
2024-10-24 14:59:02,095 - INFO - [pid 97187] Worker Worker(salt=7645441895, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=97187) running   Transform()
2024-10-24 14:59:02,096 - INFO - Connect to DWH - SUCCESS
2024-10-24 14:59:02,104 - INFO - Read Transform Query - SUCCESS
2024-10-24 14:59:02,104 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 14:59:02,366 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 14:59:04,031 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 14:59:04,232 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 14:59:04,276 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 14:59:12,779 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 14:59:45,096 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-24 14:59:52,742 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-24 15:00:00,713 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-24 15:00:06,928 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-24 15:00:06,956 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-24 15:00:07,019 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-24 15:00:07,019 - INFO - [pid 97187] Worker Worker(salt=7645441895, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=97187) done      Transform()
2024-10-24 15:00:07,021 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 15:00:07,026 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-24 15:00:07,026 - DEBUG - Asking scheduler for work...
2024-10-24 15:00:07,029 - DEBUG - Done
2024-10-24 15:00:07,030 - DEBUG - There are no more tasks to run at this time
2024-10-24 15:00:07,030 - INFO - Worker Worker(salt=7645441895, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=97187) was stopped. Shutting down Keep-Alive thread
2024-10-24 15:00:07,040 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-24 15:10:36,175 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 15:10:36,409 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 15:10:37,238 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 15:10:37,272 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 15:10:37,599 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 15:10:37,606 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 15:10:38,612 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 15:10:39,764 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 15:10:40,472 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 15:10:41,280 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 15:10:41,280 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 15:10:41,308 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 15:10:41,323 - INFO - [pid 3746] Worker Worker(salt=7938675545, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=3746) done      Extract()
2024-10-24 15:10:41,326 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 15:10:41,330 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 15:10:41,330 - DEBUG - Asking scheduler for work...
2024-10-24 15:10:41,332 - DEBUG - Pending tasks: 2
2024-10-24 15:10:41,333 - INFO - [pid 3746] Worker Worker(salt=7938675545, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=3746) running   Load()
2024-10-24 15:10:41,339 - INFO - Read Load Query - SUCCESS
2024-10-24 15:10:42,607 - INFO - Read Extracted Data - SUCCESS
2024-10-24 15:10:42,615 - INFO - Connect to DWH - SUCCESS
2024-10-24 15:10:43,099 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 15:10:43,102 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 15:13:33,565 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-24 15:13:47,956 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-24 15:13:48,009 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-24 15:13:48,962 - INFO - [pid 3746] Worker Worker(salt=7938675545, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=3746) done      Load()
2024-10-24 15:13:48,964 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 15:13:48,975 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-24 15:13:48,975 - DEBUG - Asking scheduler for work...
2024-10-24 15:13:48,979 - DEBUG - Done
2024-10-24 15:13:48,979 - DEBUG - There are no more tasks to run at this time
2024-10-24 15:13:48,979 - INFO - Worker Worker(salt=7938675545, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=3746) was stopped. Shutting down Keep-Alive thread
2024-10-24 15:13:48,984 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 ran successfully:
    - 1 Extract()
    - 1 Load()
* 1 were left pending, among these:
    * 1 was not granted run permission by the scheduler:
        - 1 Transform()

This progress looks :| because there were tasks that were not granted run permission by the scheduler

===== Luigi Execution Summary =====

2024-10-24 15:14:21,044 - INFO - Connect to DWH - SUCCESS
2024-10-24 15:14:21,048 - INFO - Read Transform Query - SUCCESS
2024-10-24 15:14:21,048 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 15:14:21,174 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 15:14:22,665 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 15:14:22,904 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 15:14:22,941 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 15:14:30,681 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 15:19:36,022 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-24 15:19:41,340 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-24 15:19:49,045 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-24 15:19:54,425 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-24 15:19:54,432 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-24 15:19:54,445 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-24 15:19:54,445 - INFO - [pid 4849] Worker Worker(salt=4484958203, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=4849) done      Transform()
2024-10-24 15:19:54,447 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 15:19:54,450 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-24 15:19:54,450 - DEBUG - Asking scheduler for work...
2024-10-24 15:19:54,452 - DEBUG - Done
2024-10-24 15:19:54,452 - DEBUG - There are no more tasks to run at this time
2024-10-24 15:19:54,452 - INFO - Worker Worker(salt=4484958203, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=4849) was stopped. Shutting down Keep-Alive thread
2024-10-24 15:19:54,453 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 2 complete ones were encountered:
    - 1 Extract()
    - 1 Load()
* 1 ran successfully:
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

2024-10-24 15:25:59,372 - INFO - ==================================STARTING EXTRACT DATA=======================================
2024-10-24 15:25:59,577 - INFO - EXTRACT 'public.geolocation' - SUCCESS.
2024-10-24 15:26:00,334 - INFO - EXTRACT 'public.customers' - SUCCESS.
2024-10-24 15:26:00,360 - INFO - EXTRACT 'public.sellers' - SUCCESS.
2024-10-24 15:26:00,671 - INFO - EXTRACT 'public.products' - SUCCESS.
2024-10-24 15:26:00,677 - INFO - EXTRACT 'public.product_category_name_translation' - SUCCESS.
2024-10-24 15:26:02,126 - INFO - EXTRACT 'public.orders' - SUCCESS.
2024-10-24 15:26:04,716 - INFO - EXTRACT 'public.order_items' - SUCCESS.
2024-10-24 15:26:06,565 - INFO - EXTRACT 'public.order_payments' - SUCCESS.
2024-10-24 15:26:07,610 - INFO - EXTRACT 'public.order_reviews' - SUCCESS.
2024-10-24 15:26:07,610 - INFO - Extract All Tables From Sources - SUCCESS
2024-10-24 15:26:07,614 - INFO - ==================================ENDING EXTRACT DATA=======================================
2024-10-24 15:26:07,636 - INFO - [pid 10691] Worker Worker(salt=7422893222, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10691) done      Extract()
2024-10-24 15:26:07,638 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 15:26:07,642 - INFO - Informed scheduler that task   Extract__99914b932b   has status   DONE
2024-10-24 15:26:07,642 - DEBUG - Asking scheduler for work...
2024-10-24 15:26:07,644 - DEBUG - Pending tasks: 2
2024-10-24 15:26:07,644 - INFO - [pid 10691] Worker Worker(salt=7422893222, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10691) running   Load()
2024-10-24 15:26:07,653 - INFO - Read Load Query - SUCCESS
2024-10-24 15:26:09,095 - INFO - Read Extracted Data - SUCCESS
2024-10-24 15:26:09,097 - INFO - Connect to DWH - SUCCESS
2024-10-24 15:26:09,605 - INFO - Truncate public Schema in DWH - SUCCESS
2024-10-24 15:26:09,605 - INFO - ==================================STARTING LOAD DATA=======================================
2024-10-24 15:26:36,825 - INFO - LOAD All Tables To olist_dwh - SUCCESS
2024-10-24 15:26:50,157 - INFO - LOAD All Tables To DWH-Staging - SUCCESS
2024-10-24 15:26:50,161 - INFO - ==================================ENDING LOAD DATA=======================================
2024-10-24 15:26:50,227 - INFO - [pid 10691] Worker Worker(salt=7422893222, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10691) done      Load()
2024-10-24 15:26:50,227 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 15:26:50,230 - INFO - Informed scheduler that task   Load__99914b932b   has status   DONE
2024-10-24 15:26:50,231 - DEBUG - Asking scheduler for work...
2024-10-24 15:26:50,232 - DEBUG - Pending tasks: 1
2024-10-24 15:26:50,232 - INFO - [pid 10691] Worker Worker(salt=7422893222, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10691) running   Transform()
2024-10-24 15:26:50,233 - INFO - Connect to DWH - SUCCESS
2024-10-24 15:26:50,237 - INFO - Read Transform Query - SUCCESS
2024-10-24 15:26:50,237 - INFO - ==================================STARTING TRANSFROM DATA=======================================
2024-10-24 15:26:50,390 - INFO - Transform to 'final.dim_geolocation' - SUCCESS
2024-10-24 15:26:51,677 - INFO - Transform to 'final.dim_customers' - SUCCESS
2024-10-24 15:26:51,877 - INFO - Transform to 'final.dim_products' - SUCCESS
2024-10-24 15:26:51,920 - INFO - Transform to 'final.dim_sellers' - SUCCESS
2024-10-24 15:26:59,330 - INFO - Transform to 'final.fct_orders' - SUCCESS
2024-10-24 15:32:12,698 - INFO - Transform to 'final.fct_daily_orders' - SUCCESS
2024-10-24 15:32:17,722 - INFO - Transform to 'final.fct_order_payments' - SUCCESS
2024-10-24 15:32:24,477 - INFO - Transform to 'final.fct_order_delivery' - SUCCESS
2024-10-24 15:32:29,483 - INFO - Transform to 'final.fct_customer_reviews' - SUCCESS
2024-10-24 15:32:29,488 - INFO - Transform to All Dimensions and Fact Tables - SUCCESS
2024-10-24 15:32:29,491 - INFO - ==================================ENDING TRANSFROM DATA=======================================
2024-10-24 15:32:29,491 - INFO - [pid 10691] Worker Worker(salt=7422893222, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10691) done      Transform()
2024-10-24 15:32:29,492 - DEBUG - 1 running tasks, waiting for next task to finish
2024-10-24 15:32:29,496 - INFO - Informed scheduler that task   Transform__99914b932b   has status   DONE
2024-10-24 15:32:29,496 - DEBUG - Asking scheduler for work...
2024-10-24 15:32:29,497 - DEBUG - Done
2024-10-24 15:32:29,498 - DEBUG - There are no more tasks to run at this time
2024-10-24 15:32:29,498 - INFO - Worker Worker(salt=7422893222, workers=1, host=LAPTOP-E1BGNT67, username=ricofebrian, pid=10691) was stopped. Shutting down Keep-Alive thread
2024-10-24 15:32:29,503 - INFO - 
===== Luigi Execution Summary =====

Scheduled 3 tasks of which:
* 3 ran successfully:
    - 1 Extract()
    - 1 Load()
    - 1 Transform()

This progress looks :) because there were no failed tasks or missing dependencies

===== Luigi Execution Summary =====

